<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°å†‰å½±åƒå·¥ä½œå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        /* V16 Final Fix: æ¨£å¼ä¿®å¾© */
        :root { --bg: #F3F4F6; --primary: #1F2937; }
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: var(--bg); color: var(--primary); padding-bottom: 120px; }
        
        /* å°èˆª */
        .nav-container { background: white; padding: 10px; border-radius: 12px; display: flex; gap: 8px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-weight: 800; color: #9CA3AF; cursor: pointer; white-space: nowrap; transition: 0.1s; font-size: 16px; user-select: none; }
        .nav-btn:hover { background: #F3F4F6; }
        .nav-btn.active { background: #111827; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        /* åœ–ä¸€ä¿®æ­£ï¼šè¶…å¤§é¡å‹åˆ‡æ›æŒ‰éˆ• (ç¢ºä¿å¥½é») */
        .type-tabs { display: flex; gap: 12px; margin-bottom: 24px; }
        .type-tab { 
            flex: 1; text-align: center; padding: 20px; 
            background: white; border-radius: 16px; 
            font-weight: 900; font-size: 18px; color: #9CA3AF; 
            cursor: pointer; border: 2px solid transparent; 
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            user-select: none;
        }
        .type-tab:hover { transform: translateY(-2px); }
        .type-tab.active { 
            border-color: #111827; color: #111827; 
            background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
        }

        /* å…§å®¹å¡ç‰‡ */
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); margin-bottom: 24px; border: 1px solid #E5E7EB; }
        .inp-label { display: block; font-size: 14px; font-weight: 800; color: #374151; margin-bottom: 8px; }
        .inp { width: 100%; padding: 14px; background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 16px; font-weight: 700; color: #111827; outline: none; transition: 0.2s; }
        .inp:focus { border-color: #111827; background: white; }
        
        /* æŒ‰éˆ• */
        .btn-black { background: #111827; color: white; padding: 16px; border-radius: 12px; font-weight: 800; width: 100%; transition: 0.2s; cursor: pointer; font-size: 16px; }
        .btn-black:active { transform: scale(0.98); }
        .btn-icon { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: #F3F4F6; border-radius: 10px; cursor: pointer; color: #4B5563; font-size: 18px; transition: 0.2s; }
        .btn-icon:hover { background: #E5E7EB; color: black; }

        /* çœ‹æ¿å¡ç‰‡ */
        .kanban-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .kanban-grid { grid-template-columns: repeat(2, 1fr); } }
        .k-card { background: white; border: 1px solid #E5E7EB; border-left: 6px solid #ccc; border-radius: 12px; padding: 20px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: 0.2s; cursor: pointer; }
        .k-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .k-blue { border-left-color: #2563EB; } .k-orange { border-left-color: #F59E0B; } .k-green { border-left-color: #10B981; }
        .k-tag { font-size: 12px; padding: 4px 10px; border-radius: 6px; color: white; font-weight: 700; display: inline-block; margin-bottom: 10px; }
        .bg-blue { background: #2563EB; } .bg-orange { background: #F59E0B; } .bg-green { background: #10B981; } .bg-gray { background: #9CA3AF; }

        /* --- å³ä¸‹è§’åŠŸèƒ½å°ˆå€ (ä¿®å¾©ï¼šå´é‚Šæ»‘å‡ºã€é è¨­éš±è—) --- */
        .fab-stack { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 14px; z-index: 100; }
        .fab { 
            width: 60px; height: 60px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 24px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
            cursor: pointer; transition: 0.2s; border: 3px solid white; 
        }
        .fab:hover { transform: scale(1.1); }
        .badge { position: absolute; top: 0; right: 0; background: #EF4444; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid white; }

        /* å´é‚Šæ»‘å‡ºé¢æ¿ */
        .float-panel { 
            position: fixed; bottom: 100px; right: 30px; width: 340px; 
            background: white; border-radius: 16px; 
            box-shadow: 0 20px 50px -12px rgba(0,0,0,0.25); 
            z-index: 200; padding: 0; border: 1px solid #E5E7EB; 
            display: none; /* â˜…é è¨­éš±è—â˜… */
            flex-direction: column; max-height: 60vh;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .fp-header { padding: 16px; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; background: #FAFAFA; border-radius: 16px 16px 0 0; }
        .fp-title { font-weight: 800; font-size: 16px; color: #111827; }
        .fp-body { padding: 16px; overflow-y: auto; flex: 1; background: white; border-radius: 0 0 16px 16px; }
        
        .list-item { background: #fff; padding: 14px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #E5E7EB; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .list-icon-btn { position: absolute; top: 14px; right: 14px; color: #9CA3AF; cursor: pointer; font-size: 16px; }
        .list-icon-btn:hover { color: #EF4444; }

        /* ä¸€èˆ¬ Modal (ç·¨è¼¯/æ–°å¢ç”¨ï¼Œç¶­æŒç½®ä¸­) */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 300; }
        .modal-box { background: white; padding: 32px; border-radius: 24px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .hidden { display: none; }

        /* ç”˜ç‰¹åœ–èˆ‡è¡Œäº‹æ›† */
        .gantt-box { overflow: auto; background: white; border-radius: 12px; border: 1px solid #E5E7EB; max-height: 600px; position: relative; }
        .gantt-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
        .gantt-th { position: sticky; top: 0; background: #F9FAFB; z-index: 20; padding: 12px 0; border-bottom: 2px solid #E5E7EB; font-weight: 800; font-size: 13px; text-align: center; border-right: 1px solid #eee; min-width: 30px; }
        .gantt-col-1 { position: sticky; left: 0; background: white; z-index: 30; border-right: 2px solid #E5E7EB; width: 130px; min-width: 130px; font-weight: 800; font-size: 13px; padding: 8px; display: flex; align-items: center; height: 44px; }
        .gantt-corner { position: sticky; top: 0; left: 0; z-index: 40; background: #F3F4F6; border-right: 2px solid #E5E7EB; border-bottom: 2px solid #E5E7EB; }
        .gantt-td { border-bottom: 1px solid #eee; border-right: 1px solid #eee; height: 44px; position: relative; padding: 0; }
        .gantt-bar { position: absolute; top: 10px; height: 24px; border-radius: 6px; font-size: 11px; font-weight: 800; color: white; line-height: 24px; padding: 0 8px; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Loading */
        #loader { position: fixed; inset: 0; background: #F3F4F6; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 500; }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="text-5xl font-black tracking-widest animate-pulse text-gray-800 mb-4">LOADING</div>
    </div>

    <div class="fab-stack">
        <div onclick="togglePanel('link')" class="fab bg-blue-600" title="é€£çµ"><i class="fas fa-link"></i></div>
        <div onclick="togglePanel('pending')" class="fab bg-gray-600 relative" title="å¾…åˆ†æ´¾">
            <i class="fas fa-user-clock"></i>
            <span id="badge-pending" class="badge hidden">0</span>
        </div>
        <div onclick="togglePanel('memo')" class="fab bg-black" title="ä¾¿åˆ©è²¼"><i class="fas fa-sticky-note"></i></div>
    </div>

    <div id="panel-memo" class="float-panel">
        <div class="fp-header"><span class="fp-title">ğŸ“ ä¾¿åˆ©è²¼</span><i onclick="closePanel('memo')" class="fas fa-times cursor-pointer text-gray-400 hover:text-black text-xl"></i></div>
        <div class="p-4 bg-gray-50 border-b border-gray-100">
            <input id="m-content" class="inp mb-2 bg-white" placeholder="è¨˜äº‹å…§å®¹...">
            <div class="flex gap-2 mb-2"><select id="m-owner" class="inp flex-1 cursor-pointer bg-white"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select><input id="m-date" class="inp w-32 text-center bg-white" placeholder="æ—¥æœŸ"></div>
            <button onclick="addMemoItem()" class="btn-black py-3 text-sm">æ–°å¢è¨˜äº‹</button>
        </div>
        <div id="memo-list" class="fp-body"></div>
    </div>

    <div id="panel-pending" class="float-panel">
        <div class="fp-header"><span class="fp-title">â³ å¾…åˆ†æ´¾å°ˆæ¡ˆ</span><i onclick="closePanel('pending')" class="fas fa-times cursor-pointer text-gray-400 hover:text-black text-xl"></i></div>
        <div id="pending-list" class="fp-body"></div>
    </div>

    <div id="panel-link" class="float-panel">
        <div class="fp-header"><span class="fp-title">ğŸ”— å®¢æˆ¶é€£çµåº«</span><i onclick="closePanel('link')" class="fas fa-times cursor-pointer text-gray-400 hover:text-black text-xl"></i></div>
        <div class="p-4 bg-gray-50 border-b border-gray-100">
            <input id="l-name" class="inp mb-2 bg-white" placeholder="åç¨± (å¦‚: å°ç©é›»)"><input id="l-url" class="inp mb-2 bg-white" placeholder="ç¶²å€ (https://...)">
            <button onclick="addLinkItem()" class="btn-black py-3 text-sm bg-blue-600">æ–°å¢é€£çµ</button>
        </div>
        <div id="link-list" class="fp-body"></div>
    </div>

    <div class="max-w-6xl mx-auto px-6 py-10">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-black tracking-tight text-gray-900">æ°å†‰å½±åƒå·¥ä½œå®¤</h1>
            <div onclick="window.location.reload()" class="text-sm font-bold text-gray-400 cursor-pointer hover:text-black border px-4 py-2 rounded-full">é‡æ–°æ•´ç†</div>
        </div>
        
        <div class="nav-container">
            <div onclick="switchTab('add')" id="nav-add" class="nav-btn active">æ–°å¢å°ˆæ¡ˆ</div>
            <div onclick="switchTab('wei')" id="nav-wei" class="nav-btn">é­æ•è»’</div>
            <div onclick="switchTab('chiu')" id="nav-chiu" class="nav-btn">é‚±ä»æ°</div>
            <div onclick="switchTab('gan')" id="nav-gan" class="nav-btn">ç”˜ç‰¹åœ–</div>
            <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-btn">è¡Œäº‹æ›†</div>
        </div>

        <div id="page-add" class="card">
            <div class="type-tabs">
                <div onclick="setCat('video')" id="type-video" class="type-tab active">ğŸ¬ å½±ç‰‡å°ˆæ¡ˆ</div>
                <div onclick="setCat('image')" id="type-image" class="type-tab">ğŸ¨ åœ–æ–‡å°ˆæ¡ˆ</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="inp-label">é¸æ“‡å®¢æˆ¶</label>
                    <div class="flex gap-2">
                        <select id="add-zone" class="inp flex-1 cursor-pointer bg-white" onchange="updateClientInfo()"></select>
                        <button onclick="openHistory()" class="btn-icon" title="æŸ¥çœ‹ç´€éŒ„"><i class="fas fa-eye"></i></button>
                        <button onclick="openAddClientModal()" class="btn-icon bg-black text-white hover:bg-gray-800" title="æ–°å¢å®¢æˆ¶"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <label class="inp-label">å°ˆæ¡ˆç·¨è™Ÿ <span id="next-id-hint" class="text-red-500 ml-2 font-bold"></span></label>
                    <input id="add-id" class="inp font-mono tracking-widest text-center bg-gray-100" placeholder="001">
                </div>
            </div>

            <div class="mb-6"><label class="inp-label">å®¢æˆ¶å…¨å</label><input id="add-client" class="inp bg-white"></div>
            <div class="mb-6"><label class="inp-label">å°ˆæ¡ˆåç¨±</label><input id="add-name" class="inp bg-white" placeholder="è¼¸å…¥æ¨™é¡Œ..."></div>

            <div class="grid grid-cols-2 gap-6 mb-6">
                <div><label class="inp-label">è£½ä½œäºº</label><select id="add-producer" class="inp cursor-pointer bg-white"></select></div>
                <div><label class="inp-label">é¡å‹</label><select id="add-type" class="inp cursor-pointer bg-white"></select></div>
            </div>

            <div class="flex items-center gap-3 mb-6 bg-red-50 p-4 rounded-xl border border-red-100 cursor-pointer" onclick="document.getElementById('add-urgent').click()">
                <input type="checkbox" id="add-urgent" class="w-6 h-6 accent-red-600 cursor-pointer">
                <label class="font-bold text-red-600 cursor-pointer select-none text-lg">ğŸ”¥ æ¨™è¨˜ç‚ºæ€¥ä»¶</label>
            </div>

            <div class="mb-8"><label class="inp-label">æ—¥æœŸç¯„åœ</label><input id="add-date" class="inp text-center cursor-pointer bg-white" placeholder="é»æ“Šé¸æ“‡æ—¥æœŸ"></div>
            <div class="mb-8"><label class="inp-label">å‚™è¨»äº‹é …</label><textarea id="add-note" class="inp h-24 text-sm bg-white" placeholder="é¸å¡«..."></textarea></div>

            <button onclick="submitProject()" class="btn-black text-lg py-4 shadow-lg hover:shadow-xl">å»ºç«‹å°ˆæ¡ˆ</button>
        </div>

        <div id="page-kanban" class="hidden">
            <h2 id="kb-title" class="text-2xl font-black mb-8 pl-4 border-l-8 border-black"></h2>
            <div class="mb-12"><h3 class="text-xl font-black text-blue-600 mb-4">ğŸ”¥ è£½ä½œä¸­</h3><div id="kb-process" class="kanban-grid"></div></div>
            <details class="mb-8" open><summary class="font-bold text-orange-500 cursor-pointer mb-4 text-lg select-none">ğŸ‘€ å¯©æ ¸ä¸­</summary><div id="kb-review" class="kanban-grid"></div></details>
            <details class="mb-8"><summary class="font-bold text-gray-500 cursor-pointer mb-4 text-lg select-none">â³ å°šæœªé€²è¡Œ</summary><div id="kb-todo" class="kanban-grid"></div></details>
            <details class="mb-8"><summary class="font-bold text-green-600 cursor-pointer mb-4 text-lg select-none">âœ… å·²å®Œæˆ</summary><div id="kb-done" class="kanban-grid"></div></details>
        </div>

        <div id="page-gantt" class="hidden">
            <div class="card p-0 overflow-hidden bg-white border-0">
                <div class="flex justify-between items-center p-4 border-b">
                    <h2 id="gantt-month-title" class="text-xl font-black pl-2"></h2>
                    <div class="flex gap-2">
                        <button onclick="moveGantt(-1)" class="btn-icon"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="moveGantt(1)" class="btn-icon"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="gantt-area" class="gantt-box shadow-sm"></div>
            </div>
        </div>

        <div id="page-calendar" class="hidden">
            <div class="flex justify-between items-center mb-6 px-2">
                <h2 class="text-2xl font-black">å·¥ä½œè¡Œäº‹æ›†</h2>
                <button onclick="openLeaveModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700">æˆ‘è¦è«‹å‡</button>
            </div>
            <div id="calendar-wrapper" class="bg-white p-4 rounded-xl shadow border border-gray-100"><div id="calendar"></div></div>
        </div>
    </div>

    <div id="modal-edit" class="modal-mask"><div class="modal-box">
        <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-black">ç·¨è¼¯å°ˆæ¡ˆ</h3><i onclick="closeModal('edit')" class="fas fa-times cursor-pointer text-2xl"></i></div>
        <input type="hidden" id="e-oid"><input type="hidden" id="e-ozone">
        <input id="e-name" class="inp mb-4 font-bold text-lg bg-white border-2 border-black">
        <div class="grid grid-cols-2 gap-4 mb-4"><select id="e-prod" class="inp cursor-pointer bg-white"></select><select id="e-type" class="inp cursor-pointer bg-white"></select></div>
        <input id="e-date" class="inp text-center mb-4 cursor-pointer bg-white">
        <textarea id="e-note" class="inp h-24 mb-6 text-sm bg-white"></textarea>
        <div class="flex gap-3">
            <button onclick="deleteProject()" class="btn-black bg-red-50 text-red-500 w-1/3 hover:bg-red-100">åˆªé™¤</button>
            <button onclick="saveEdit()" class="btn-black w-2/3">å„²å­˜è®Šæ›´</button>
        </div>
    </div></div>

    <div id="modal-status" class="modal-mask"><div class="modal-box text-center">
        <h3 class="text-2xl font-black mb-2">æ›´æ–°é€²åº¦</h3>
        <p class="text-gray-500 text-sm font-bold mb-6">æœ¬æ¬¡å·¥æ™‚ (hr)</p>
        <input type="hidden" id="s-id"><input type="hidden" id="s-zone">
        <input id="s-hours" type="number" class="inp text-center text-4xl font-black mb-8 border-b-4 border-t-0 border-x-0 rounded-none bg-transparent focus:ring-0" placeholder="0.0">
        <div class="flex gap-3">
            <button onclick="submitStatus('è£½ä½œä¸­')" class="btn-black bg-gray-100 text-black flex-1">è£½ä½œ</button>
            <button onclick="submitStatus('å®¢æˆ¶å¯©æ ¸')" class="btn-black bg-orange-500 flex-1">é€å¯©</button>
            <button onclick="submitStatus('å·²å®Œæˆ')" class="btn-black bg-green-600 flex-1">å®Œæˆ</button>
        </div>
        <div onclick="closeModal('status')" class="text-center mt-4 cursor-pointer text-gray-400">å–æ¶ˆ</div>
    </div></div>

    <div id="modal-client" class="modal-mask"><div class="modal-box">
        <h3 class="text-xl font-bold mb-4">æ–°å¢å®¢æˆ¶</h3>
        <label class="inp-label">ä»£è™Ÿ</label><select id="new-client-code" class="inp mb-4 cursor-pointer"></select>
        <label class="inp-label">åç¨±</label><input id="new-client-name" class="inp mb-8" placeholder="ä¾‹å¦‚ï¼šå°ç©é›»">
        <div class="flex gap-3"><button onclick="closeModal('client')" class="btn-black bg-gray-200 text-gray-600 flex-1">å–æ¶ˆ</button><button onclick="submitNewClient()" class="btn-black flex-1">ç¢ºèª</button></div>
    </div></div>

    <div id="modal-leave" class="modal-mask"><div class="modal-box">
        <h3 class="text-xl font-bold mb-4 text-indigo-600">è«‹å‡ç”³è«‹</h3>
        <select id="leave-name" class="inp mb-4 cursor-pointer"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select>
        <input id="leave-date" class="inp mb-4 text-center cursor-pointer" placeholder="æ—¥æœŸç¯„åœ">
        <input id="leave-reason" class="inp mb-8" placeholder="äº‹ç”±">
        <div class="flex gap-3"><button onclick="closeModal('leave')" class="btn-black bg-gray-200 text-gray-600 flex-1">å–æ¶ˆ</button><button onclick="submitLeave()" class="btn-black bg-indigo-600 flex-1">é€å‡º</button></div>
    </div></div>

    <div id="modal-history" class="modal-mask"><div class="modal-box">
        <div class="flex justify-between mb-4 border-b pb-2"><h3 id="hist-client-title" class="text-xl font-bold"></h3><i onclick="closeModal('history')" class="fas fa-times cursor-pointer text-xl"></i></div>
        <div id="hist-content" class="max-h-60 overflow-y-auto mb-4 space-y-3">è¼‰å…¥ä¸­...</div>
    </div></div>

    <div id="login-overlay" style="position:fixed; inset:0; background:#111827; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;">
        <div class="text-6xl font-black mb-8 tracking-widest text-white">JAYRAN</div>
        <input id="login-pass" type="password" class="p-4 text-center text-black text-2xl font-bold rounded-2xl w-72 mb-6 outline-none border-4 border-transparent focus:border-blue-500 transition" placeholder="è¼¸å…¥å¯†ç¢¼" maxlength="8">
        <button onclick="checkLogin()" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-2xl font-bold text-xl shadow-lg cursor-pointer">é€²å…¥ç³»çµ±</button>
    </div>

    <script>
        // â˜…â˜…â˜… æ‚¨çš„ API ç¶²å€ (å·²å¯«æ­») â˜…â˜…â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbxEK4TafDLSKqfn3QuJk2bwNpnWcPMcOoNt6nVmz2w4geyMoRL4Bx_ILVIAtBbGhVCV/exec';
        
        let DATA = { projects: [], config: {}, leaves: [], memos: [], links: [] };
        let curCat = 'video';
        let curTab = 'add';
        let ganttDate = new Date();
        const fpAdd = flatpickr("#add-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpEdit = flatpickr("#e-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpLeave = flatpickr("#leave-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpMemo = flatpickr("#m-date", { dateFormat: "Y-m-d" });
        let calendar = null;

        // ç™»å…¥
        window.onload = function() {
            const loginTime = localStorage.getItem('JAYRAN_LOGIN');
            if(loginTime && (new Date().getTime() - loginTime < 43200000)) {
                document.getElementById('login-overlay').style.display = 'none';
                loadData();
            }
        };

        function checkLogin() {
            if(document.getElementById('login-pass').value === '00430552') {
                localStorage.setItem('JAYRAN_LOGIN', new Date().getTime());
                document.getElementById('login-overlay').style.display = 'none';
                loadData();
            } else alert("å¯†ç¢¼éŒ¯èª¤");
        }

        function loadData() {
            document.getElementById('loader').style.display = 'flex';
            fetch(API_URL + '?action=initAllData')
            .then(r => r.json())
            .then(d => {
                DATA = d;
                renderApp();
                document.getElementById('loader').style.display = 'none';
            })
            .catch(e => { 
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€"); 
                document.getElementById('loader').style.display = 'none'; 
            });
        }

        function renderApp() {
            renderOptions();
            if (curTab === 'wei') renderKanban('é­æ•è»’');
            else if (curTab === 'chiu') renderKanban('é‚±ä»æ°');
            else if (curTab === 'gan') renderGantt();
            else if (curTab === 'calendar') renderCalendar();
            
            // è¼‰å…¥å³ä¸‹è§’åŠŸèƒ½
            loadMemos(); loadLinks(); loadPending();
        }

        function switchTab(t) {
            curTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + t).classList.add('active');
            ['page-add', 'page-kanban', 'page-gantt', 'page-calendar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (t==='add') document.getElementById('page-add').classList.remove('hidden');
            else if (t==='wei') { document.getElementById('page-kanban').classList.remove('hidden'); renderKanban('é­æ•è»’'); }
            else if (t==='chiu') { document.getElementById('page-kanban').classList.remove('hidden'); renderKanban('é‚±ä»æ°'); }
            else if (t==='gan') { document.getElementById('page-gantt').classList.remove('hidden'); renderGantt(); }
            else if (t==='calendar') { document.getElementById('page-calendar').classList.remove('hidden'); setTimeout(renderCalendar, 100); }
            
            // åˆ‡æ› Tab æ™‚è‡ªå‹•é—œé–‰å³ä¸‹è§’é¢æ¿
            document.querySelectorAll('.float-panel').forEach(p=>p.style.display='none');
        }

        function setCat(c) {
            curCat = c;
            document.getElementById('type-video').className = c === 'video' ? 'type-tab active' : 'type-tab';
            document.getElementById('type-image').className = c === 'image' ? 'type-tab active' : 'type-tab';
            renderOptions();
        }

        function renderOptions() {
            const zSel = document.getElementById('add-zone'); zSel.innerHTML = '<option value="">é¸æ“‡å®¢æˆ¶</option>';
            const zones = curCat === 'video' ? DATA.videoSettings : DATA.imageSettings;
            if (zones) Object.keys(zones).sort().forEach(k => zSel.add(new Option(k, k)));
            
            const fill = (id, list) => { const el=document.getElementById(id); el.innerHTML=''; list.forEach(x=>el.add(new Option(x,x))); };
            if (DATA.config) {
                const types = curCat === 'video' ? DATA.config.videoTypes : DATA.config.imageTypes;
                const prods = curCat === 'video' ? DATA.config.videoProducers : DATA.config.imageProducers;
                fill('add-producer', prods); fill('add-type', types); fill('edit-prod', prods); fill('edit-type', types);
            }
        }

        function updateClientInfo() {
            const z = document.getElementById('add-zone').value;
            if (z) {
                document.getElementById('add-client').value = z.split('_')[1] || z;
                let max = 0;
                DATA.projects.forEach(p => { if (p.zone === z) { const n = parseInt(p.id.replace(/\D/g, '')) || 0; if (n > max) max = n; } });
                const next = String(max + 1).padStart(3, '0');
                document.getElementById('add-id').value = next;
                document.getElementById('next-id-hint').innerText = `(ä¸‹è™Ÿ: ${next})`;
            }
        }

        function submitProject() {
            const p = {
                category: curCat, zone: document.getElementById('add-zone').value, id: document.getElementById('add-id').value,
                client: document.getElementById('add-client').value, name: document.getElementById('add-name').value,
                producer: document.getElementById('add-producer').value, type: document.getElementById('add-type').value,
                note: document.getElementById('add-note').value, tag: document.getElementById('add-urgent').checked ? 'Urgent' : '',
                status: 'å°šæœªé€²è¡Œ'
            };
            const dates = document.getElementById('add-date').value.split(' to ');
            if (dates[0]) { p.start = dates[0]; p.end = dates[1] || dates[0]; }
            if (p.producer !== 'å°šæœªæš«å®š' && p.start && new Date(p.start) <= new Date()) p.status = 'è£½ä½œä¸­';
            if (!p.zone || !p.name) return alert("è«‹å¡«å¯«å®Œæ•´");
            
            DATA.projects.push(p); renderApp(); alert("âœ… å»ºç«‹æˆåŠŸ");
            document.getElementById('add-name').value = ''; document.getElementById('add-note').value = ''; updateClientInfo();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addProject', payload: p }) });
        }

        function renderKanban(who) {
            document.getElementById('kb-title').innerText = who + " çš„ä»»å‹™";
            const tasks = DATA.projects.filter(p => p.producer === who);
            const cols = { 'è£½ä½œä¸­': [], 'å¯©': [], 'å°šæœª': [], 'å®Œæˆ': [] };
            tasks.forEach(p => {
                if (p.status === 'è£½ä½œä¸­') cols['è£½ä½œä¸­'].push(p);
                else if (p.status.includes('å¯©')) cols['å¯©'].push(p);
                else if (p.status === 'å°šæœªé€²è¡Œ') cols['å°šæœª'].push(p);
                else cols['å®Œæˆ'].push(p);
            });
            const draw = (arr, elId) => {
                const el = document.getElementById(elId);
                if (arr.length === 0) { el.innerHTML = '<div class="text-gray-300 text-center py-4 font-bold text-sm">ç„¡é …ç›®</div>'; return; }
                el.innerHTML = arr.map(p => {
                    let bc = 'k-blue'; let badge = 'bg-blue';
                    if (p.status.includes('å¯©')) { bc = 'k-orange'; badge = 'bg-orange'; }
                    else if (p.status.includes('å®Œæˆ')) { bc = 'k-green'; badge = 'bg-green'; }
                    else if (p.status.includes('å°šæœª')) { bc = ''; badge = 'bg-gray'; }
                    return `<div class="k-card ${bc} mb-4">
                        <div class="flex justify-between items-start mb-2"><span class="k-tag ${badge}">${p.status}</span><div onclick="openEdit('${p.id}','${p.zone}')" class="text-gray-400 cursor-pointer hover:text-black px-2"><i class="fas fa-pen"></i></div></div>
                        <div class="font-bold text-gray-500 text-xs mb-1">${p.id} Â· ${p.client}</div><div class="k-title font-bold text-lg text-gray-800">${p.name}</div>
                        ${ p.start ? `<div class="text-xs text-gray-400 font-bold mt-2"><i class="far fa-clock"></i> ${p.start.slice(5)}~${p.end.slice(5)}</div>` : '' }
                        ${ p.tag==='Urgent' ? `<div class="mt-2 text-red-500 text-xs font-black">ğŸ”¥ æ€¥ä»¶</div>` : '' }
                        <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                            ${ p.status === 'è£½ä½œä¸­' ? `<div onclick="openStatus('${p.id}','${p.zone}')" class="btn-icon bg-orange-100 text-orange-600 flex-1 h-8 text-sm font-bold flex items-center justify-center rounded cursor-pointer hover:bg-orange-200">é€å¯©</div>` : '' }
                            ${ p.status.includes('å¯©') ? `<div onclick="quickUpdate('${p.id}','${p.zone}','è£½ä½œä¸­')" class="btn-icon bg-gray-100 text-gray-600 flex-1 h-8 text-sm font-bold flex items-center justify-center rounded cursor-pointer mr-2 hover:bg-gray-200">é€€ä¿®</div><div onclick="quickUpdate('${p.id}','${p.zone}','å·²å®Œæˆ')" class="btn-icon bg-green-100 text-green-600 flex-1 h-8 text-sm font-bold flex items-center justify-center rounded cursor-pointer hover:bg-green-200">å®Œæˆ</div>` : '' }
                            ${ p.status === 'å°šæœªé€²è¡Œ' ? `<div onclick="quickUpdate('${p.id}','${p.zone}','è£½ä½œä¸­')" class="btn-icon bg-blue-100 text-blue-600 flex-1 h-8 text-sm font-bold flex items-center justify-center rounded cursor-pointer hover:bg-blue-200">é–‹å§‹</div>` : '' }
                        </div>
                    </div>`;
                }).join('');
            };
            draw(cols['è£½ä½œä¸­'], 'kb-process'); draw(cols['å¯©'], 'kb-review'); draw(cols['å°šæœª'], 'kb-todo'); draw(cols['å®Œæˆ'], 'kb-done');
        }

        function renderGantt() {
            const container = document.getElementById('gantt-area');
            const y = ganttDate.getFullYear(), m = ganttDate.getMonth();
            document.getElementById('gantt-month-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const daysInMonth = new Date(y, m+1, 0).getDate();
            let html = `<table class="gantt-table"><thead><tr><th class="gantt-th gantt-corner z-[50]">å°ˆæ¡ˆ</th>`;
            for(let i=1; i<=daysInMonth; i++) {
                const isToday = (new Date().getDate() === i && new Date().getMonth() === m);
                html += `<th class="gantt-th" style="${isToday?'background:#FFF9C4; color:black;':''}">${i}</th>`;
            }
            html += `</tr></thead><tbody>`;
            const tasks = DATA.projects.filter(p=>p.start && p.end).sort((a,b)=>new Date(a.start)-new Date(b.start));
            tasks.forEach(p => {
                const s = new Date(p.start), e = new Date(p.end);
                if(e < new Date(y, m, 1) || s > new Date(y, m+1, 0)) return;
                let startDay = s < new Date(y, m, 1) ? 1 : s.getDate();
                let endDay = e > new Date(y, m+1, 0) ? daysInMonth : e.getDate();
                let width = (endDay - startDay + 1) * 31; let left = (startDay - 1) * 31;
                let bg = p.status==='è£½ä½œä¸­'?'#2563EB':(p.status.includes('å¯©')?'#F59E0B':'#10B981');
                html += `<tr><td class="gantt-col-1 border-b truncate" title="${p.name}">${p.name}<br><span class="text-gray-400 text-xs">${p.client}</span></td><td class="gantt-td" colspan="${daysInMonth}"><div class="gantt-bar" style="left:${left}px; width:${width}px; background:${bg};">${p.producer[0]}</div></td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        function moveGantt(n) { ganttDate.setMonth(ganttDate.getMonth() + n); renderGantt(); }

        function renderCalendar() {
            if (calendar) calendar.destroy();
            const el = document.getElementById('calendar');
            let events = DATA.projects.filter(p => p.start).map(p => ({
                title: `${p.name} (${p.producer})`, start: p.start, end: new Date(new Date(p.end).getTime()+86400000).toISOString().slice(0,10),
                color: p.status==='è£½ä½œä¸­'?'#2563EB':(p.status.includes('å¯©')?'#F59E0B':'#10B981')
            }));
            if(DATA.leaves) DATA.leaves.forEach(l => events.push({ title: `ğŸ–ï¸ ${l.name}`, start:l.start, end: new Date(new Date(l.end).getTime()+86400000).toISOString().slice(0,10), color:'#7C3AED' }));
            calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', locale: 'zh-tw', headerToolbar: { left: 'prev,next today', center: 'title', right: '' }, buttonText: { today: 'ä»Šå¤©', month: 'æœˆ' }, events: events, height: 'auto', contentHeight: 650 });
            calendar.render();
        }

        // --- Modals & Panels ---
        function openEdit(id, zone) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone); if(!p) return;
            document.getElementById('e-oid').value = p.id; document.getElementById('e-ozone').value = p.zone;
            document.getElementById('e-name').value = p.name; document.getElementById('e-note').value = p.note;
            if(p.start) fpEdit.setDate([p.start, p.end]);
            const prods = curCat === 'video' ? DATA.config.videoProducers : DATA.config.imageProducers;
            const types = curCat === 'video' ? DATA.config.videoTypes : DATA.config.imageTypes;
            const pSel = document.getElementById('e-prod'); pSel.innerHTML=''; prods.forEach(x=>pSel.add(new Option(x,x))); pSel.value=p.producer;
            const tSel = document.getElementById('e-type'); tSel.innerHTML=''; types.forEach(x=>tSel.add(new Option(x,x))); tSel.value=p.type;
            openModal('edit');
        }
        function saveEdit() {
            const oid = document.getElementById('e-oid').value, ozone = document.getElementById('e-ozone').value;
            const p = DATA.projects.find(x => x.id === oid && x.zone === ozone);
            if(p) {
                p.name = document.getElementById('e-name').value; p.producer = document.getElementById('e-prod').value;
                p.type = document.getElementById('e-type').value; p.note = document.getElementById('e-note').value;
                const d = document.getElementById('e-date').value.split(' to '); if(d[0]) { p.start=d[0]; p.end=d[1]||d[0]; }
                renderApp(); 
                fetch(API_URL, { method:'POST', body:JSON.stringify({action:'updateProject', payload:p, originId:oid, originZone:ozone}) });
            }
            closeModal('edit');
        }
        function deleteProject() {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            const id = document.getElementById('e-oid').value, zone = document.getElementById('e-ozone').value;
            DATA.projects = DATA.projects.filter(p => !(p.id === id && p.zone === zone));
            renderApp(); closeModal('edit');
            fetch(API_URL, { method:'POST', body:JSON.stringify({action:'deleteProject', cat:curCat, zone:zone, id:id}) });
        }
        function openStatus(id, zone) { document.getElementById('s-id').value=id; document.getElementById('s-zone').value=zone; openModal('status'); }
        function submitStatus(st) { quickUpdate(document.getElementById('s-id').value, document.getElementById('s-zone').value, st, document.getElementById('s-hours').value); closeModal('status'); }
        function quickUpdate(id, zone, st, hr) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if(p) { p.status = st; if(hr) p.hours = (Number(p.hours)||0)+Number(hr); renderApp(); fetch(API_URL, { method:'POST', body:JSON.stringify({action:'updateStatus', cat:p.category, zone:zone, id:id, status:st, hours:hr}) }); }
        }
        function openLeaveModal() { openModal('leave'); }
        function submitLeave() {
            const i = { name:document.getElementById('leave-name').value, start:document.getElementById('leave-date').value.split(' to ')[0], end:document.getElementById('leave-date').value.split(' to ')[1]||document.getElementById('leave-date').value.split(' to ')[0], reason:document.getElementById('leave-reason').value };
            if(!i.start) return alert("è«‹é¸æ—¥æœŸ");
            DATA.leaves.push(i); renderApp(); closeModal('leave'); alert("è«‹å‡å·²é€å‡º");
            fetch(API_URL, { method:'POST', body:JSON.stringify({action:'addLeave', item:i}) });
        }
        function openModal(id) { document.getElementById('modal-'+id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
        function closePanel(id) { document.getElementById('panel-'+id).style.display = 'none'; }
        
        // â˜… ä¿®å¾©ï¼šå´é‚Šé¸å–®æ§åˆ¶é‚è¼¯ â˜…
        function togglePanel(id) { 
            const target = document.getElementById('panel-'+id);
            const isVisible = target.style.display === 'flex';
            document.querySelectorAll('.float-panel').forEach(p=>p.style.display='none'); // å…ˆé—œå…¨éƒ¨
            if(!isVisible) {
                target.style.display = 'flex'; // æ‰“é–‹æŒ‡å®šçš„
                // é‡æ–°æ¸²æŸ“è©²å€å¡Šå…§å®¹ï¼Œç¢ºä¿æœ€æ–°
                if(id==='memo') renderMemos();
                if(id==='link') renderLinks();
                if(id==='pending') renderPending();
            }
        }

        // é¢æ¿æ¸²æŸ“
        function renderMemos(){ document.getElementById('memo-list').innerHTML = (DATA.memos||[]).map((m,i)=>`<div class="list-item"><div class="font-bold">${m.content}</div><div class="text-xs text-gray-500 mt-1 flex justify-between"><span>${m.owner} Â· ${m.date}</span><i class="list-icon-btn fas fa-trash" onclick="delMemo(${i})"></i></div></div>`).join(''); }
        function addMemoItem(){ const c=document.getElementById('m-content').value, o=document.getElementById('m-owner').value, d=document.getElementById('m-date').value; if(c){ DATA.memos.push({content:c,owner:o,date:d}); renderMemos(); fetch(API_URL,{method:'POST',body:JSON.stringify({action:'addMemo',item:{content:c,owner:o,date:d}})}); document.getElementById('m-content').value=''; } }
        function delMemo(i){ if(confirm('åˆªé™¤ä¾¿åˆ©è²¼?')){ DATA.memos.splice(i,1); renderMemos(); fetch(API_URL,{method:'POST',body:JSON.stringify({action:'deleteMemo',idx:i+2})}); } }

        function renderLinks(){ document.getElementById('link-list').innerHTML = (DATA.links||[]).map((k,i)=>`<div class="list-item flex justify-between items-center cursor-pointer" onclick="window.open('${k.url}')"><span class="font-bold text-gray-700">${k.client}</span><div class="flex gap-3"><i class="fas fa-external-link-alt text-gray-400"></i><i class="list-icon-btn fas fa-trash" onclick="event.stopPropagation();delLink(${i})"></i></div></div>`).join(''); }
        function addLinkItem(){ const n=document.getElementById('l-name').value, u=document.getElementById('l-url').value; if(n&&u){ DATA.links.push({client:n,url:u}); renderLinks(); fetch(API_URL,{method:'POST',body:JSON.stringify({action:'addLink',client:n,url:u})}); document.getElementById('l-name').value=''; document.getElementById('l-url').value=''; } }
        function delLink(i){ if(confirm('åˆªé™¤é€£çµ?')){ DATA.links.splice(i,1); renderLinks(); fetch(API_URL,{method:'POST',body:JSON.stringify({action:'deleteLink',idx:i+2})}); } }

        function renderPending(){ const l=DATA.projects.filter(p=>p.producer==='å°šæœªæš«å®š'); document.getElementById('pending-list').innerHTML=l.map(p=>`<div class="list-item"><div class="font-bold text-lg">${p.name}</div><div class="text-sm text-gray-500">${p.client}</div></div>`).join(''); document.getElementById('badge-pending').innerText=l.length; document.getElementById('badge-pending').style.display=l.length?'flex':'none'; }
    </script>
</body>
</html>
