<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°å†‰å½±åƒå·¥ä½œå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="icon" href="https://drive.google.com/uc?export=view&id=1PA3de57c2FhIo86zRGzXB2e-LTmvVnt5">
    
    <style>
        :root { --bg: #F2F2F7; --surface: #FFFFFF; --primary: #000000; --secondary: #8E8E93; --radius: 16px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--primary); padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        .segmented-nav { background: #E5E5EA; padding: 4px; border-radius: 12px; display: flex; margin-bottom: 24px; overflow-x: auto; }
        .nav-item { flex: 1; min-width: 90px; text-align: center; padding: 10px; font-size: 14px; font-weight: 700; color: var(--secondary); cursor: pointer; border-radius: 9px; transition: all 0.2s; white-space: nowrap; }
        .nav-item.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        
        .clean-card { background: var(--surface); border-radius: var(--radius); padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.04); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .clean-input, .clean-select { width: 100%; padding: 14px; background: #F2F2F7; border: 1px solid transparent; border-radius: 10px; font-size: 15px; font-weight: 600; transition: 0.2s; appearance: none; }
        .clean-input:focus, .clean-select:focus { background: var(--surface); border-color: #000; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.1); }
        
        .type-switch { display: flex; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: #E5E5EA; padding: 2px; }
        .type-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; color: #8E8E93; border-radius: 10px; transition: 0.2s; }
        .type-btn.active { background: #FFFFFF; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        
        .icon-btn { width: 44px; height: 44px; border-radius: 10px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-black { background: #000; color: white; }
        .btn-gray { background: #E5E5EA; color: #000; }

        .kanban-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .kanban-grid { grid-template-columns: repeat(2, 1fr); } }
        .kanban-item { background: white; border-radius: 16px; padding: 18px 20px 24px 20px; position: relative; transition: 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03); overflow: hidden; }
        .kanban-item:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .status-pill { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; color: white; margin-bottom: 8px; letter-spacing: 0.5px; }
        .pill-blue { background: #007AFF; } .pill-orange { background: #FF9500; } .pill-green { background: #34C759; } .pill-gray { background: #8E8E93; } .pill-urgent { background: #FF3B30; margin-left: 6px; }

        .k-id { font-size: 13px; font-weight: 700; color: #8E8E93; font-family: monospace; letter-spacing: 1px; }
        .k-name { font-size: 18px; font-weight: 800; color: #1C1C1E; margin: 4px 0 6px 0; line-height: 1.3; }
        .k-client { font-size: 13px; font-weight: 600; color: #3A3A3C; background: #F2F2F7; padding: 2px 8px; border-radius: 6px; display: inline-block; margin-bottom: 12px; }
        
        .progress-container { width: 100%; height: 4px; background: #F2F2F7; border-radius: 2px; margin-top: 12px; overflow: hidden; display: flex; }
        .progress-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        
        .k-actions { position: absolute; top: 18px; right: 18px; display: flex; gap: 8px; z-index: 20; }
        .k-action-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #8E8E93; background: #F2F2F7; transition: 0.2s; z-index: 30; }
        .k-action-btn:hover { background: #E5E5EA; color: #000; }
        .k-del:hover { background: #FF3B30; color: white; }

        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary i.fa-chevron-right { transition: transform 0.2s ease; display: inline-block; width: 20px; text-align: center; font-size: 12px; }
        details[open] > summary i.fa-chevron-right { transform: rotate(90deg); }

        .gantt-wrapper { overflow-x: auto; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); width: 100%; border: 1px solid rgba(0,0,0,0.03); }
        .gantt-table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; }
        .gantt-header-cell { text-align: center; font-size: 11px; font-weight: 700; color: #8E8E93; padding: 10px 0; }
        .gantt-today-cell { background-color: #FFF9C4; } 
        .gantt-bar { position: absolute; top: 10px; height: 24px; border-radius: 6px; color: white; font-size: 11px; line-height: 24px; padding: 0 8px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 5; }
        
        .gan-btn { background: #E5E5EA; color: #8E8E93; transition: all 0.2s; font-weight: 700; }
        .gan-btn.active { background: #000; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-body { background: white; padding: 28px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; margin: 20px; }
        .hidden { display: none; }
        
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 999; }
        .fab-btn { width: 56px; height: 56px; background: #000; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 22px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); cursor: pointer; transition: transform 0.2s; position: relative; }
        .fab-btn:hover { transform: scale(1.1); }
        .badge { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: bold; display: none; }
        .fab-left-container { position: fixed; bottom: 30px; left: 30px; z-index: 999; }
        .fab-btn-small { width: 44px; height: 44px; font-size: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: white; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }

        .float-panel { position: fixed; bottom: 30px; right: 100px; width: 360px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 998; display: none; border: 1px solid rgba(0,0,0,0.05); flex-direction: column; max-height: 70vh; padding: 0; overflow: hidden; }
        @media (max-width: 600px) { .float-panel { right: 20px; left: 20px; width: auto; bottom: 100px; } }
        .panel-header-area { padding: 25px 25px 0 25px; flex-shrink: 0; background: white; }
        .panel-scroll-area { padding: 0 25px 25px 25px; overflow-y: auto; flex-grow: 1; }
        .memo-item, .pending-item { background: #FFF9C4; padding: 15px; border-radius: 12px; margin-bottom: 12px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .memo-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .link-item { background: #1C1C1E; color: white; padding: 16px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #F2F2F7; }

        #calendar-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); min-height: 600px; }
        .fc-theme-standard td, .fc-theme-standard th { border: none !important; }
        .fc-col-header-cell-cushion { color: #8E8E93; font-weight: 700; padding: 12px 0 !important; }
        .fc-daygrid-day-number { color: #1C1C1E; font-weight: 700; padding: 8px !important; text-decoration: none !important; }
        .fc-event { border: none !important; box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important; cursor: pointer; margin-bottom: 4px !important; border-radius: 6px !important; }
        .cal-filter-btn { padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; transition: 0.2s; background: #E5E5EA; color: #8E8E93; }
        .cal-filter-btn.active { background: #000; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="loader" class="fixed top-0 left-0 w-full h-full bg-[#F2F2F7] flex flex-col justify-center items-center z-[999]">
        <div class="text-3xl font-black tracking-widest animate-pulse mb-4">JAYRAN</div>
        <div id="loader-msg" class="text-gray-400 font-bold text-sm">SYSTEM LOADING...</div>
    </div>

    <div class="fab-container">
        <div onclick="togglePanel('link')" class="fab-btn fab-link" title="é€£çµ"><i class="fas fa-link"></i></div>
        <div onclick="togglePanel('pending')" class="fab-btn" title="å¾…åˆ†æ´¾" style="background:#48484A;">
            <i class="fas fa-user-clock"></i>
            <span id="pending-badge" class="badge">0</span>
        </div>
        <div onclick="togglePanel('memo')" class="fab-btn" title="ä¾¿åˆ©è²¼">
            <i class="fas fa-paste"></i>
            <span id="memo-badge" class="badge">0</span>
        </div>
    </div>

    <div class="fab-left-container">
        <div onclick="window.open('https://script.google.com/macros/s/AKfycbzpYIM8Pw-ASL_M_cVIJl-H_AXMZWcADv6qmxmo7cvxidEib74mXmP_sQJatY1MM30R0g/exec', '_blank')" class="fab-btn-small" title="å¿ƒæ™ºåœ–">
            <i class="fas fa-project-diagram"></i>
        </div>
    </div>
    
    <div id="panel-memo" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">ä¾¿åˆ©è²¼</h3>
                <span onclick="togglePanel('memo')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
            <div class="mb-6 bg-gray-50 p-4 rounded-xl">
                <input id="m-content" class="w-full clean-input mb-3" placeholder="è¼¸å…¥äº‹é …...">
                <div class="flex gap-2 mb-3">
                    <select id="m-owner" class="clean-select flex-1"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select>
                    <input id="m-date" class="clean-input w-32 text-center" placeholder="æ—¥æœŸ">
                </div>
                <button id="btn-memo-add" onclick="addMemoItem()" class="w-full bg-black text-white py-3 rounded-lg font-bold">æ–°å¢</button>
            </div>
        </div>
        <div id="memo-list" class="panel-scroll-area"></div>
    </div>

    <div id="panel-pending" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">å¾…åˆ†æ´¾</h3>
                <span onclick="togglePanel('pending')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
        </div>
        <div id="pending-list" class="panel-scroll-area"></div>
    </div>

    <div id="panel-link" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">é€£çµåº«</h3>
                <span onclick="togglePanel('link')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
            <div class="mb-6 bg-gray-50 p-4 rounded-xl">
                <input id="l-client" class="w-full clean-input mb-3" placeholder="åç¨±">
                <input id="l-url" class="w-full clean-input mb-3" placeholder="ç¶²å€">
                <button id="btn-link-add" onclick="addLinkItem()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">æ–°å¢</button>
            </div>
        </div>
        <div id="link-list" class="panel-scroll-area"></div>
    </div>

    <div id="modal-preview" class="modal-mask"><div class="modal-body">
        <h3 class="text-xl font-black mb-4">æ­·å²ç´€éŒ„</h3>
        <p id="hist-title" class="text-sm text-gray-500 mb-4"></p>
        <div id="hist-list" class="mb-4 max-h-60 overflow-y-auto"></div>
        <button onclick="closeModal('preview')" class="w-full bg-gray-200 py-3 rounded-lg font-bold">é—œé–‰</button>
    </div></div>

    <div id="modal-zone" class="modal-mask"><div class="modal-body">
        <h3 id="modal-title" class="text-xl font-black mb-4">å€åŸŸè¨­å®š</h3>
        <div class="mb-4" id="div-code-select"><label class="text-xs font-bold text-gray-500">ä»£è™Ÿ</label><select id="modal-code" class="clean-select"></select></div>
        <label class="text-xs font-bold text-gray-500">åç¨±</label><input id="modal-name" class="clean-input mb-6">
        <div class="flex gap-2">
            <button onclick="closeModal('zone')" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmZoneModal()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">ç¢ºèª</button>
        </div>
    </div></div>
    
    <div id="modal-leave" class="modal-mask"><div class="modal-body">
        <h3 class="text-xl font-black mb-4">è«‹å‡</h3>
        <div class="mb-3"><select id="leave-name" class="clean-select"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select></div>
        <div class="mb-3"><input id="leave-date" class="clean-input text-center" placeholder="æ—¥æœŸç¯„åœ"></div>
        <div class="mb-6"><input id="leave-reason" class="clean-input" placeholder="äº‹ç”±"></div>
        <div class="flex gap-2">
            <button onclick="closeModal('leave')" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmLeave()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">é€å‡º</button>
        </div>
    </div></div>

    <div id="modal-edit-project" class="modal-mask"><div class="modal-body w-[400px]">
        <h3 class="text-xl font-black mb-4">ç·¨è¼¯å°ˆæ¡ˆ</h3>
        <input type="hidden" id="ep-cat"><input type="hidden" id="ep-zone"><input type="hidden" id="ep-origin-id"><input type="hidden" id="ep-origin-zone">
        <div class="flex gap-2 mb-3">
            <select id="ep-code" class="clean-select w-20 text-center" onchange="updateEditClientInfo()"></select>
            <input id="ep-client-display" class="clean-input flex-1 bg-white" disabled>
            <input id="ep-num" class="clean-input w-20 text-center">
        </div>
        <div class="mb-3"><select id="ep-producer" class="clean-select"></select></div>
        <div class="mb-3"><input id="ep-name" class="clean-input font-bold"></div>
        <div class="flex gap-3 mb-3">
             <select id="ep-type" class="clean-select flex-1"></select>
             <input id="ep-date" class="clean-input flex-1 text-center text-xs">
        </div>
        <div class="mb-3"><input id="ep-hours" type="number" step="0.5" class="clean-input" placeholder="å·¥æ™‚"></div>
        <div class="mb-3"><textarea id="ep-note" class="clean-input h-20 text-sm"></textarea></div>
        <div class="flex items-center gap-2 mb-6">
            <input type="checkbox" id="ep-urgent" class="w-5 h-5 accent-red-600">
            <label for="ep-urgent" class="font-bold text-red-600">æ€¥ä»¶</label>
        </div>
        <div class="flex gap-2">
            <button onclick="closeModal('edit-project')" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmEditProject()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">å„²å­˜</button>
        </div>
    </div></div>

    <div id="modal-hours" class="modal-mask"><div class="modal-body">
        <h3 class="text-xl font-black mb-2">é€å¯©å·¥æ™‚</h3>
        <input type="hidden" id="hours-zone"><input type="hidden" id="hours-id"><input type="hidden" id="hours-cat">
        <input id="input-hours" type="number" step="0.5" class="clean-input mb-6 text-center text-2xl font-bold" placeholder="0.0">
        <div class="flex gap-2">
            <button onclick="closeModal('hours')" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmSendReview()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">é€å‡º</button>
        </div>
    </div></div>

    <div id="modal-settings" class="modal-mask"><div class="modal-body">
        <h3 id="setting-title" class="text-xl font-black mb-4">è¨­å®š</h3>
        <input type="hidden" id="st-type"> 
        <div class="flex gap-2 mb-4">
            <input id="st-input" class="clean-input flex-1" placeholder="è¼¸å…¥...">
            <button onclick="addSettingItem()" class="bg-black text-white px-4 rounded-lg font-bold">æ–°å¢</button>
        </div>
        <div id="st-list" class="max-h-60 overflow-y-auto border-t border-gray-100"></div>
        <button onclick="closeModal('settings')" class="w-full bg-gray-200 py-3 rounded-lg font-bold mt-4">é—œé–‰</button>
    </div></div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8 px-1 flex items-center gap-3">
            <h1 class="text-3xl font-black text-black tracking-tight">æ°å†‰å½±åƒå·¥ä½œå®¤</h1>
        </div>
        
        <div class="segmented-nav">
            <div onclick="switchTab('add')" id="nav-add" class="nav-item active"><i class="fas fa-plus mr-2"></i>æ–°å¢</div>
            <div onclick="switchTab('wei')" id="nav-wei" class="nav-item">é­æ•è»’</div>
            <div onclick="switchTab('chiu')" id="nav-chiu" class="nav-item">é‚±ä»æ°</div>
            <div onclick="switchTab('gan')" id="nav-gan" class="nav-item"><i class="fas fa-chart-bar mr-2"></i>ç”˜ç‰¹åœ–</div>
            <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-alt mr-2"></i>è¡Œäº‹æ›†</div>
        </div>

        <div id="p-add" class="clean-card">
            <div class="type-switch">
                <div onclick="setProjectType('video')" id="btn-type-video" class="type-btn active">ğŸ¬ å‰ªè¼¯å°ˆæ¡ˆ</div>
                <div onclick="setProjectType('image')" id="btn-type-image" class="type-btn">ğŸ¨ åœ–æ–‡å°ˆæ¡ˆ</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">å®¢æˆ¶</label>
                    <div class="flex gap-2">
                        <select id="i-zone" onchange="updateClientName()" class="clean-select flex-grow"></select>
                        <div onclick="openHistory()" class="icon-btn btn-gray"><i class="fas fa-eye"></i></div>
                        <div onclick="openZoneModal('new')" class="icon-btn btn-black"><i class="fas fa-plus"></i></div>
                    </div>
                </div>
                <div><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">ç·¨è™Ÿ</label><input id="i-id" class="clean-input font-mono"></div>
            </div>
            <div class="mb-4"><input id="i-client" class="clean-input bg-gray-100 text-gray-500 font-bold" disabled></div>
            <div class="mb-4"><label id="lbl-name" class="block text-xs font-bold text-gray-400 mb-1 uppercase">å°ˆæ¡ˆåç¨±</label><input id="i-name" class="clean-input"></div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">è£½ä½œäºº</label><div class="flex gap-1"><select id="i-producer" class="clean-select" onchange="checkProducer()"></select><div onclick="openSettings('Producer')" class="icon-btn btn-gray"><i class="fas fa-cog"></i></div></div></div>
                <div><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">é¡å‹</label><div class="flex gap-1"><select id="i-type" class="clean-select"></select><div onclick="openSettings('Type')" class="icon-btn btn-gray"><i class="fas fa-cog"></i></div></div></div>
            </div>
            <div class="mb-4 flex items-center gap-2">
                <input type="checkbox" id="i-urgent" class="w-5 h-5 accent-red-600">
                <label for="i-urgent" class="font-bold text-red-600">ğŸ”¥ æ€¥ä»¶</label>
            </div>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">æ—¥æœŸ</label><input id="i-date" class="clean-input text-center"></div>
            <div class="mb-6"><textarea id="i-note" class="clean-input h-24" placeholder="å‚™è¨»..."></textarea></div>
            <button onclick="saveProject()" id="btn-create" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition">å»ºç«‹å°ˆæ¡ˆ</button>
        </div>

        <div id="p-kanban" class="hidden">
            <h2 id="kb-title" class="text-3xl font-black mb-8 px-2"></h2>
            <div class="mb-10">
                <h3 class="text-lg font-bold text-blue-600 mb-4 px-2">ğŸ”¥ è£½ä½œä¸­</h3>
                <div id="kb-process" class="kanban-grid"></div>
            </div>
            <details class="mb-6 group">
                <summary class="text-lg font-bold text-orange-500 mb-4 px-2 cursor-pointer select-none flex items-center gap-2"><i class="fas fa-chevron-right"></i> ğŸ‘€ å¯©æ ¸ä¸­</summary>
                <div id="kb-review" class="kanban-grid pl-2"></div>
            </details>
            <details class="mb-4 group">
                <summary class="text-lg font-bold text-gray-400 mb-4 px-2 cursor-pointer select-none flex items-center gap-2"><i class="fas fa-chevron-right"></i> â³ å°šæœªé€²è¡Œ</summary>
                <div id="kb-todo" class="kanban-grid pl-2"></div>
            </details>
            <details class="mb-4 group">
                <summary class="text-lg font-bold text-gray-400 mb-4 px-2 cursor-pointer select-none flex items-center gap-2"><i class="fas fa-chevron-right"></i> âœ… å·²å®Œæˆ</summary>
                <div id="kb-done" class="kanban-grid pl-2"></div>
            </details>
        </div>

        <div id="p-gantt" class="hidden">
            <div class="flex justify-between items-center mb-6 px-2">
                <h2 id="gan-title" class="text-2xl font-black">ç”˜ç‰¹åœ–</h2>
                <div class="flex gap-2">
                    <button class="icon-btn btn-gray" onclick="changeGanttMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="icon-btn btn-gray" onclick="changeGanttMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="flex gap-2 mb-6 px-2">
                <button id="btn-gan-all" onclick="renderGantt('all')" class="gan-btn px-4 py-2 rounded-lg font-bold active">å…¨éƒ¨</button>
                <button id="btn-gan-wei" onclick="renderGantt('é­æ•è»’')" class="gan-btn px-4 py-2 rounded-lg font-bold">é­æ•è»’</button>
                <button id="btn-gan-chiu" onclick="renderGantt('é‚±ä»æ°')" class="gan-btn px-4 py-2 rounded-lg font-bold">é‚±ä»æ°</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="p-calendar" class="hidden">
            <div class="flex justify-between items-center mb-6 px-2">
                <h2 class="text-2xl font-black">è¡Œäº‹æ›†</h2>
                <button onclick="openLeaveModal()" class="bg-black text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">è«‹å‡</button>
            </div>
            <div class="flex gap-2 mb-4 px-2">
                <button id="btn-cal-all" onclick="filterCalendar('all')" class="cal-filter-btn active">å…¨éƒ¨</button>
                <button id="btn-cal-wei" onclick="filterCalendar('é­æ•è»’')" class="cal-filter-btn">é­æ•è»’</button>
                <button id="btn-cal-chiu" onclick="filterCalendar('é‚±ä»æ°')" class="cal-filter-btn">é‚±ä»æ°</button>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… ç¶²å€å·²å¹«æ‚¨å¡«å¥½ (è«‹å‹¿ä¿®æ”¹ï¼Œé™¤éæ‚¨æ›äº†éƒ¨ç½²) â˜…â˜…â˜…
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxEK4TafDLSKqfn3QuJk2bwNpnWcPMcOoNt6nVmz2w4geyMoRL4Bx_ILVIAtBbGhVCV/exec'; 

        let DATA = { ids: {}, videoSettings: {}, imageSettings: {}, projects: [], usedCodesVideo: [], usedCodesImage: [], config: {}, leaves: [] };
        let curTab = 'add';
        let curCat = 'video';
        let modalMode = 'new';
        let calendar = null; 
        let calendarFilter = 'all'; 
        let currentGanttDate = new Date(); 
        let ganttFilter = 'all';
        let editingMemoIdx = null;
        let editingLinkIdx = null;

        const fp = flatpickr("#i-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpMemo = flatpickr("#m-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpEdit = flatpickr("#ep-date", { mode: "range", dateFormat: "Y-m-d" }); 
        const fpLeave = flatpickr("#leave-date", { mode: "range", dateFormat: "Y-m-d" }); 

        function callAPI(action, payload, onSuccess) {
            if (GAS_API_URL) {
                if (['initAllData', 'getHistory', 'getLeaves', 'getMemos', 'getLinks'].includes(action)) {
                    let params = `?action=${action}`;
                    if(payload.cat) params += `&cat=${payload.cat}`;
                    if(payload.zone) params += `&zone=${payload.zone}`;
                    fetch(GAS_API_URL + params).then(res => res.json()).then(data => onSuccess(data)).catch(e => { console.error(e); alert("ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ API ç¶²å€"); document.getElementById('loader').style.display = 'none'; });
                } else {
                    const postData = { action: action, ...payload };
                    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(postData) })
                    .then(res => res.json()).then(data => onSuccess(data.data)).catch(e => { alert("é€£ç·šéŒ¯èª¤"); document.getElementById('loader').style.display = 'none'; });
                }
            } else {
                alert("éŒ¯èª¤ï¼šæœªè¨­å®š API ç¶²å€");
                document.getElementById('loader').style.display = 'none';
            }
        }

        window.onload = function() {
            const cachedData = localStorage.getItem('JAYRAN_SYSTEM_DATA');
            if (cachedData) {
                try {
                    const parsedData = JSON.parse(cachedData);
                    processDataUpdate(parsedData, true); 
                    document.getElementById('loader-msg').innerText = "èƒŒæ™¯åŒæ­¥ä¸­...";
                } catch(e) {}
            }
            callAPI('initAllData', {}, (res) => {
                localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(res));
                processDataUpdate(res, false);
            });
        };

        function processDataUpdate(res, isCache) {
            DATA = res;
            renderZoneOptions();
            loadMemos();
            loadLinks();
            loadPending();
            
            if (curTab === 'wei') renderKanban('é­æ•è»’');
            else if (curTab === 'chiu') renderKanban('é‚±ä»æ°');
            else if (curTab === 'gan') renderGantt(ganttFilter);
            else if (curTab === 'calendar') renderCalendar();

            if (!isCache) { document.getElementById('loader').style.display = 'none'; setProjectType('video'); } 
            else { document.getElementById('loader').style.display = 'none'; }
        }

        function setProjectType(type) {
            curCat = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-type-' + type).classList.add('active');
            document.getElementById('i-name').placeholder = (type === 'video') ? "å½±ç‰‡æ¨™é¡Œ" : "åœ–æ–‡æ¨™é¡Œ";
            document.getElementById('lbl-name').innerText = (type === 'video') ? "å½±ç‰‡åç¨±" : "åœ–æ–‡åç¨±";
            document.getElementById('i-id').placeholder = "001";
            renderZoneOptions();
            renderDynamicOptions();
        }

        function renderDynamicOptions() {
            if (!DATA.config) return;
            const types = (curCat === 'video') ? DATA.config.videoTypes : DATA.config.imageTypes;
            const producers = (curCat === 'video') ? DATA.config.videoProducers : DATA.config.imageProducers;
            const fillSelect = (id, list) => {
                const el = document.getElementById(id);
                if(el && list) {
                    const currentVal = el.value;
                    el.innerHTML = '';
                    list.forEach(item => el.add(new Option(item, item)));
                    if(list.includes(currentVal)) el.value = currentVal;
                }
            };
            fillSelect('i-type', types);
            fillSelect('i-producer', producers);
            fillSelect('ep-type', types);
            fillSelect('ep-producer', producers);
        }

        function switchTab(tab) {
            curTab = tab;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            ['p-add', 'p-kanban', 'p-gantt', 'p-calendar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (tab === 'add') document.getElementById('p-add').classList.remove('hidden');
            else if (tab === 'wei') { document.getElementById('p-kanban').classList.remove('hidden'); renderKanban('é­æ•è»’'); }
            else if (tab === 'chiu') { document.getElementById('p-kanban').classList.remove('hidden'); renderKanban('é‚±ä»æ°'); }
            else if (tab === 'gan') { document.getElementById('p-gantt').classList.remove('hidden'); renderGantt(ganttFilter); }
            else if (tab === 'calendar') { 
                document.getElementById('p-calendar').classList.remove('hidden'); 
                setTimeout(() => renderCalendar(), 100); 
            }
        }

        function renderZoneOptions() {
            const sel = document.getElementById('i-zone'); 
            sel.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            const settings = (curCat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            if (settings) Object.keys(settings).sort().forEach(k => sel.add(new Option(k, k)));
            updateClientName(); 
        }

        function updateClientName() {
            const z = document.getElementById('i-zone').value;
            const clientInput = document.getElementById('i-client');
            const idInput = document.getElementById('i-id');
            if (z) { 
                const realName = z.includes('_') ? z.substring(z.indexOf('_') + 1) : z;
                if (z.toUpperCase().startsWith('Z')) {
                    clientInput.value = ''; clientInput.disabled = false; clientInput.classList.remove('bg-gray-100'); clientInput.classList.add('bg-white');
                } else {
                    clientInput.value = realName; clientInput.disabled = true; clientInput.classList.add('bg-gray-100'); clientInput.classList.remove('bg-white');
                }
                let lastId = (DATA.ids) ? DATA.ids[z] : "";
                idInput.placeholder = (lastId && lastId.match(/\d+$/)) ? `æœ€å¾Œ: ${lastId.match(/\d+$/)[0]}` : "001";
            } else {
                clientInput.value = ''; idInput.placeholder = ''; 
            }
        }

        function checkProducer() {
            const prod = document.getElementById('i-producer').value;
            const dateInput = document.getElementById('i-date');
            dateInput.placeholder = (prod === 'å°šæœªæš«å®š') ? "æ—¥æœŸå¯ç•™ç©º" : "é»æ“Šé¸æ“‡";
        }

        function saveProject() {
            const dr = document.getElementById('i-date').value.split(' to ');
            const prod = document.getElementById('i-producer').value;
            const p = {
                category: curCat, zone: document.getElementById('i-zone').value, id: document.getElementById('i-id').value,
                client: document.getElementById('i-client').value, name: document.getElementById('i-name').value,
                producer: prod, type: document.getElementById('i-type').value,
                note: document.getElementById('i-note').value, start: dr[0] || "", end: dr[1] || dr[0] || "",
                tag: document.getElementById('i-urgent').checked ? 'Urgent' : '',
                status: (prod !== 'å°šæœªæš«å®š' && dr[0] && new Date(dr[0]) <= new Date()) ? 'è£½ä½œä¸­' : 'å°šæœªé€²è¡Œ'
            };
            if(!p.zone || !p.id || !p.name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            
            DATA.projects.push(p);
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);
            alert("âœ… å»ºç«‹æˆåŠŸ");

            document.getElementById('i-id').value = ''; document.getElementById('i-name').value = '';
            document.getElementById('i-note').value = ''; document.getElementById('i-urgent').checked = false; 
            callAPI('addProject', { payload: p }, (res) => {});
        }

        function renderKanban(producer) {
            document.getElementById('kb-title').innerText = producer + " ä»»å‹™çœ‹æ¿";
            if (!DATA.projects) return;
            const tasks = DATA.projects.filter(p => p.producer === producer);
            const card = (p) => {
                let progress = 0;
                if (p.status === 'å·²å®Œæˆ' || p.status === 'å·²çµæ¡ˆ') progress = 100;
                else if (p.start && p.end) {
                    const start = new Date(p.start).getTime();
                    const end = new Date(p.end).getTime();
                    const now = new Date().getTime();
                    if (now >= end) progress = 100;
                    else if (now > start) progress = ((now - start) / (end - start)) * 100;
                }
                
                let pillClass = 'pill-gray';
                if (p.status === 'è£½ä½œä¸­') pillClass = 'pill-blue';
                else if (p.status.includes('å¯©')) pillClass = 'pill-orange';
                else if (p.status === 'å·²å®Œæˆ') pillClass = 'pill-green';

                return `
                <div class="kanban-item">
                    <div class="status-pill ${pillClass}">${p.status}${p.tag === 'Urgent' ? '<span class="pill-urgent">ğŸ”¥ æ€¥ä»¶</span>' : ''}</div>
                    <div class="k-actions">
                        <div onclick="triggerEdit('${p.id}', '${p.zone}')" class="k-action-btn"><i class="fas fa-pen text-xs"></i></div>
                        <div onclick="deleteProject('${p.category}', '${p.zone}', '${p.id}')" class="k-action-btn k-del"><i class="fas fa-times text-xs"></i></div>
                    </div>
                    <div class="k-id">${p.id}</div>
                    <div class="k-name">${p.name}</div>
                    <div class="k-client">${p.client}</div>
                    <div class="k-date"><i class="far fa-calendar-alt mr-1"></i> ${p.start} ~ ${p.end}</div>
                    <div class="progress-container"><div class="progress-bar" style="width:${progress}%; background:${progress===100 ? '#34C759' : '#007AFF'}"></div></div>
                    <div class="mt-4 flex gap-2">
                        ${ p.status==='è£½ä½œä¸­' ? `<button onclick="openHoursModal('${p.category}','${p.zone}','${p.id}')" class="flex-1 bg-gray-100 text-orange-600 text-xs font-bold py-2 rounded-lg hover:bg-orange-50">é€å¯©</button>` : '' }
                        ${ p.status.includes('å¯©') ? `<button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','è£½ä½œä¸­')" class="bg-gray-100 px-4 py-2 rounded-lg text-xs font-bold">é€€ä¿®</button><button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','å·²å®Œæˆ')" class="flex-1 bg-black text-white text-xs font-bold py-2 rounded-lg">å®Œæˆ</button>` : '' }
                        ${ p.status === 'å°šæœªé€²è¡Œ' ? `<button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','è£½ä½œä¸­')" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded-lg">é–‹å§‹</button>` : '' }
                    </div>
                </div>`;
            };
            
            document.getElementById('kb-process').innerHTML = tasks.filter(p => p.status === 'è£½ä½œä¸­').map(p => card(p)).join('') || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-review').innerHTML = tasks.filter(p => p.status.includes('å¯©')).map(p => card(p)).join('') || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-todo').innerHTML = tasks.filter(p => p.status === 'å°šæœªé€²è¡Œ').map(p => card(p)).join('') || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-done').innerHTML = tasks.filter(p => p.status === 'å·²å®Œæˆ' || p.status === 'å·²çµæ¡ˆ').map(p => card(p)).join('') || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
        }

        function changeGanttMonth(offset) {
            currentGanttDate.setMonth(currentGanttDate.getMonth() + offset);
            renderGantt(ganttFilter);
        }

        function renderGantt(filter) {
            ganttFilter = filter;
            document.querySelectorAll('.gan-btn').forEach(b => b.classList.remove('active'));
            if(filter === 'all') document.getElementById('btn-gan-all').classList.add('active');
            if(filter === 'é­æ•è»’') document.getElementById('btn-gan-wei').classList.add('active');
            if(filter === 'é‚±ä»æ°') document.getElementById('btn-gan-chiu').classList.add('active');
            
            const container = document.getElementById('gantt-chart');
            const year = currentGanttDate.getFullYear();
            const month = currentGanttDate.getMonth();
            document.getElementById('gan-title').innerText = `ç”˜ç‰¹åœ– (${year}å¹´${month + 1}æœˆ)`;

            let tasks = DATA.projects.filter(p => p.start && p.end);
            if(filter !== 'all') tasks = tasks.filter(p => p.producer === filter);

            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0, 23, 59, 59);

            tasks = tasks.filter(p => {
                const pStart = new Date(p.start);
                const pEnd = new Date(p.end);
                return pStart <= monthEnd && pEnd >= monthStart;
            }).sort((a, b) => new Date(a.start) - new Date(b.start));

            if (tasks.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10 font-bold">æœ¬æœˆç„¡æ’ç¨‹</div>'; return; }

            const daysInMonth = monthEnd.getDate(); 
            const today = new Date();
            const todayDay = (today.getFullYear() === year && today.getMonth() === month) ? today.getDate() : -1;

            let header = '<tr class="gantt-row"><th class="gantt-label-cell">å°ˆæ¡ˆ</th>';
            for (let i = 1; i <= daysInMonth; i++) {
                let bg = (i === todayDay) ? 'gantt-today' : '';
                header += `<th class="gantt-header-cell ${bg}">${i}</th>`;
            }
            header += '</tr>';

            let body = '';
            tasks.forEach(p => {
                const pStartObj = new Date(p.start);
                const pEndObj = new Date(p.end);
                
                let color = '#8E8E93'; 
                if (p.status === 'è£½ä½œä¸­') color = '#007AFF';
                else if (p.status.includes('å¯©')) color = '#FF9500';
                else if (p.status === 'å·²å®Œæˆ') color = '#34C759';

                let gridStartDay = (pStartObj < monthStart) ? 1 : pStartObj.getDate();
                let gridEndDay = (pEndObj > monthEnd) ? daysInMonth : pEndObj.getDate();

                let bars = '';
                for (let i = 1; i <= daysInMonth; i++) {
                    let bg = (i === todayDay) ? 'gantt-today-cell' : '';
                    let content = '';
                    if (i === gridStartDay) {
                        let span = (gridEndDay - gridStartDay) + 1;
                        let barTxt = (filter === 'all') ? `${p.producer.charAt(0)}: ${p.name}` : p.name;
                        content = `<div class="gantt-bar" style="width:calc(${span * 100}% + ${span * 2}px); background:${color};">${barTxt}</div>`;
                    }
                    bars += `<td class="gantt-grid-cell ${bg}" ${i === gridStartDay ? 'style="overflow:visible; z-index:10;"' : ''}>${content}</td>`;
                }
                body += `<tr class="gantt-row"><td class="gantt-label-cell"><div class="truncate font-bold text-xs">${p.client} - ${p.name}</div></td>${bars}</tr>`;
            });
            container.innerHTML = `<table class="gantt-table"><thead>${header}</thead><tbody>${body}</tbody></table>`;
        }

        function filterCalendar(filter) {
            calendarFilter = filter;
            document.querySelectorAll('.cal-filter-btn').forEach(btn => btn.classList.remove('active'));
            if(filter === 'all') document.getElementById('btn-cal-all').classList.add('active');
            if(filter === 'é­æ•è»’') document.getElementById('btn-cal-wei').classList.add('active');
            if(filter === 'é‚±ä»æ°') document.getElementById('btn-cal-chiu').classList.add('active');
            renderCalendar();
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            let filteredProjects = DATA.projects.filter(p => p.start && p.end);
            if (calendarFilter !== 'all') {
                filteredProjects = filteredProjects.filter(p => p.producer === calendarFilter);
            }

            const events = filteredProjects.map(p => {
                let color = '#8E8E93'; 
                if (p.status === 'è£½ä½œä¸­') color = '#007AFF';
                else if (p.status.includes('å¯©')) color = '#FF9500';
                else if (p.status === 'å·²å®Œæˆ') color = '#34C759';
                
                let endDate = new Date(p.end);
                endDate.setDate(endDate.getDate() + 1);
                
                return {
                    title: `${p.name}`,
                    start: p.start,
                    end: endDate.toISOString().split('T')[0],
                    backgroundColor: color,
                    borderColor: color,
                    extendedProps: { project: p } 
                };
            });
            
            if (DATA.leaves) {
                DATA.leaves.forEach(l => {
                    if (calendarFilter !== 'all' && l.name !== calendarFilter) return;
                    let endDate = new Date(l.end);
                    endDate.setDate(endDate.getDate() + 1);
                    events.push({
                        title: `ğŸ–ï¸ ${l.name}: ${l.reason}`,
                        start: l.start,
                        end: endDate.toISOString().split('T')[0],
                        backgroundColor: '#5856D6',
                        borderColor: '#5856D6',
                        allDay: true
                    });
                });
            }

            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw', 
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek' },
                buttonText: { today: 'ä»Šå¤©', month: 'æœˆ', week: 'é€±' },
                events: events,
                eventClick: function(info) {
                    if (info.event.extendedProps.project) triggerEdit(info.event.extendedProps.project.id, info.event.extendedProps.project.zone);
                },
                height: 'auto', 
                contentHeight: 600
            });
            calendar.render();
        }

        function triggerEdit(id, zone) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if(p) openEditProject(p);
        }

        function deleteProject(category, zone, id) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆ ${id} å—ï¼Ÿ`)) return;
            DATA.projects = DATA.projects.filter(p => !(p.id === id && p.zone === zone));
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);
            callAPI('deleteProject', { cat: category, zone: zone, id: id }, (res) => {});
        }

        function confirmEditProject() {
            const dateVal = document.getElementById('ep-date').value;
            const dates = dateVal.split(' to ');
            const originId = document.getElementById('ep-origin-id').value;
            const originZone = document.getElementById('ep-origin-zone').value;
            
            const p = {
                category: document.getElementById('ep-cat').value,
                zone: document.getElementById('ep-zone').value, 
                id: document.getElementById('ep-num').value, 
                client: document.getElementById('ep-client-display').value,
                name: document.getElementById('ep-name').value,
                producer: document.getElementById('ep-producer').value,
                type: document.getElementById('ep-type').value,
                hours: document.getElementById('ep-hours').value, 
                start: dates[0] || "", end: dates[1] || dates[0] || "",
                note: document.getElementById('ep-note').value,
                tag: document.getElementById('ep-urgent').checked ? 'Urgent' : '',
                status: 'ä¿æŒåŸæ¨£' 
            };

            const targetIdx = DATA.projects.findIndex(x => x.id === originId && x.zone === originZone);
            if (targetIdx !== -1) { p.status = DATA.projects[targetIdx].status; DATA.projects[targetIdx] = p; }

            closeModal('edit-project');
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);
            alert("âœ… ä¿®æ”¹æˆåŠŸ");
            callAPI('updateProject', { payload: p, originId: originId, originZone: originZone }, (res) => {});
        }

        function doUpdate(cat, zone, id, status, hours=0) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if (p) {
                p.status = status;
                if (hours > 0) p.hours = (parseFloat(p.hours) || 0) + parseFloat(hours);
                localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
                processDataUpdate(DATA, true);
            }
            callAPI('updateStatus', { cat:cat, zone:zone, id:id, status:status, hours:hours }, (res) => {});
        }
        
        function openEditProject(p) {
            document.getElementById('ep-cat').value = p.category;
            document.getElementById('ep-origin-id').value = p.id; 
            document.getElementById('ep-origin-zone').value = p.zone; 
            const prefix = p.zone.split('_')[0]; 
            const numPart = p.id.replace(prefix, ''); 
            const epCodeSel = document.getElementById('ep-code');
            epCodeSel.innerHTML = '';
            const settings = (p.category === 'video') ? DATA.videoSettings : DATA.imageSettings;
            Object.keys(settings).sort().forEach(k => { epCodeSel.add(new Option(k.split('_')[0], k.split('_')[0])); });
            epCodeSel.value = prefix;
            document.getElementById('ep-num').value = numPart;
            updateEditClientInfo(); 
            document.getElementById('ep-producer').value = p.producer;
            document.getElementById('ep-name').value = p.name;
            document.getElementById('ep-type').value = p.type;
            document.getElementById('ep-hours').value = p.hours || 0; 
            if (p.start && p.end) fpEdit.setDate([p.start, p.end]); else fpEdit.clear();
            document.getElementById('ep-note').value = p.note;
            document.getElementById('ep-urgent').checked = (p.tag === 'Urgent');
            document.getElementById('modal-edit-project').style.display = 'flex';
        }

        function updateEditClientInfo() {
            const selectedCode = document.getElementById('ep-code').value;
            const settings = (document.getElementById('ep-cat').value === 'video') ? DATA.videoSettings : DATA.imageSettings;
            let foundZone = "";
            for (let key in settings) { if (key.startsWith(selectedCode + "_") || key === selectedCode) { foundZone = key; break; } }
            if (foundZone) {
                const clientName = foundZone.includes('_') ? foundZone.substring(foundZone.indexOf('_') + 1) : foundZone;
                document.getElementById('ep-client-display').value = clientName;
                document.getElementById('ep-zone').value = foundZone; 
            }
        }
        
        function openHoursModal(cat, zone, id) {
            document.getElementById('hours-cat').value = cat;
            document.getElementById('hours-zone').value = zone;
            document.getElementById('hours-id').value = id;
            document.getElementById('input-hours').value = '';
            document.getElementById('modal-hours').style.display = 'flex';
        }
        function confirmSendReview() {
            const h = document.getElementById('input-hours').value;
            if(!h) return alert("è«‹è¼¸å…¥å·¥æ™‚");
            closeModal('hours');
            doUpdate(document.getElementById('hours-cat').value, document.getElementById('hours-zone').value, document.getElementById('hours-id').value, 'å®¢æˆ¶å¯©æ ¸', h);
        }
        function togglePanel(type) {
            const allPanels = ['panel-memo', 'panel-link', 'panel-pending'];
            const targetId = 'panel-' + type;
            const targetEl = document.getElementById(targetId);
            const isVisible = targetEl.style.display !== 'none';
            allPanels.forEach(id => { document.getElementById(id).style.display = 'none'; });
            if (!isVisible) { targetEl.style.display = 'flex'; if (type === 'memo') loadMemos(); if (type === 'link') loadLinks(); if (type === 'pending') loadPending(); }
        }
        // ... (Memo, Link, Pending, Modal logic retained for stability)
        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
        function openLeaveModal() { document.getElementById('modal-leave').style.display = 'flex'; }
        function confirmLeave() {
            const name = document.getElementById('leave-name').value;
            const dates = document.getElementById('leave-date').value.split(' to ');
            if(!name || !dates[0]) return alert("è«‹å¡«å¯«å®Œæ•´");
            DATA.leaves.push({name: name, start: dates[0], end: dates[1]||dates[0], reason: document.getElementById('leave-reason').value});
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);
            closeModal('leave');
            callAPI('addLeave', { item: {name:name, start:dates[0], end:dates[1]||dates[0], reason: document.getElementById('leave-reason').value} }, ()=>{});
        }
        function openZoneModal(mode) {
            modalMode = mode;
            document.getElementById('modal-zone').style.display = 'flex';
            const selCode = document.getElementById('modal-code');
            selCode.innerHTML = '';
            "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(c => selCode.add(new Option(c,c)));
        }
        function confirmZoneModal() {
            const name = document.getElementById('modal-name').value;
            const code = document.getElementById('modal-code').value;
            if(!name) return;
            closeModal('zone');
            callAPI('createClient', { cat: curCat, code: code, name: name }, (res) => { alert("å»ºç«‹æˆåŠŸ"); location.reload(); });
        }
        function openSettings(type) { document.getElementById('modal-settings').style.display = 'flex'; }
        
        function loadMemos() { callAPI('getMemos', {}, (list) => {
            const c = document.getElementById('memo-list');
            c.innerHTML = list.map(m => `<div class="memo-item"><div class="memo-content">${m.content}</div><div class="memo-meta"><span>${m.owner}</span><span>${m.date}</span></div></div>`).join('');
            document.getElementById('memo-badge').innerText = list.length || 0;
            document.getElementById('memo-badge').style.display = list.length ? 'flex' : 'none';
        }); }
        function addMemoItem() { callAPI('addMemo', { item: {content:document.getElementById('m-content').value, owner:document.getElementById('m-owner').value, date:document.getElementById('m-date').value} }, ()=>loadMemos()); document.getElementById('m-content').value=''; }
        function loadLinks() { callAPI('getLinks', {}, (list) => {
            document.getElementById('link-list').innerHTML = list.map(l => `<div class="link-item" onclick="window.open('${l.url}')"><span>${l.client}</span><i class="fas fa-external-link-alt"></i></div>`).join('');
        }); }
        function addLinkItem() { callAPI('addLink', { client:document.getElementById('l-client').value, url:document.getElementById('l-url').value }, ()=>loadLinks()); document.getElementById('l-client').value=''; document.getElementById('l-url').value=''; }
        function loadPending() {
             const list = DATA.projects.filter(p => p.producer === 'å°šæœªæš«å®š');
             document.getElementById('pending-list').innerHTML = list.map(p => `<div class="pending-item"><div class="pending-name">${p.name}</div></div>`).join('');
             document.getElementById('pending-badge').innerText = list.length;
             document.getElementById('pending-badge').style.display = list.length ? 'flex' : 'none';
        }
        function addSettingItem() { 
            const val = document.getElementById('st-input').value; 
            callAPI('manageConfig', {act:'add', cat:curCat, type:document.getElementById('st-type').value, val:val}, ()=>{ alert('æ–°å¢æˆåŠŸ'); location.reload(); }); 
        }
    </script>
</body>
</html>
