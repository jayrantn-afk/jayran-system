<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°å†‰å½±åƒå·¥ä½œå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        /* V7: å›æ­¸å¯¦ç”¨é¢¨æ ¼ */
        :root { --bg: #F3F4F6; --primary: #1F2937; --accent: #2563EB; }
        body { font-family: "SF Pro TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--primary); padding-bottom: 80px; }
        
        /* å°èˆªåˆ— */
        .nav-container { background: white; padding: 10px; border-radius: 12px; display: flex; gap: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        .nav-btn { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-weight: bold; color: #6B7280; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* å…§å®¹å¡ç‰‡ */
        .main-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 12px; font-weight: 700; color: #6B7280; margin-bottom: 4px; text-transform: uppercase; }
        .std-input, .std-select { width: 100%; padding: 12px; background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 15px; font-weight: 600; outline: none; transition: 0.2s; }
        .std-input:focus, .std-select:focus { border-color: var(--primary); background: white; }
        
        /* é¡å‹åˆ‡æ› (å¤§æŒ‰éˆ•) */
        .type-toggle { display: flex; gap: 0; background: #E5E7EB; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .type-opt { flex: 1; text-align: center; padding: 12px; font-weight: 800; color: #6B7280; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .type-opt.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* çœ‹æ¿å¡ç‰‡ */
        .kanban-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .kanban-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .k-card { background: white; border: 1px solid #E5E7EB; border-left: 5px solid #9CA3AF; border-radius: 12px; padding: 16px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .k-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .k-blue { border-left-color: #2563EB; }
        .k-orange { border-left-color: #F59E0B; }
        .k-green { border-left-color: #10B981; }
        
        .k-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .k-id { font-size: 12px; font-weight: 800; color: #9CA3AF; background: #F3F4F6; padding: 2px 6px; border-radius: 4px; }
        .k-title { font-size: 18px; font-weight: 800; color: #111827; line-height: 1.3; margin-bottom: 4px; }
        .k-client { font-size: 13px; color: #4B5563; font-weight: 600; }
        .k-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; border-top: 1px solid #F3F4F6; padding-top: 12px; }
        .k-actions { display: flex; gap: 8px; width: 100%; }
        
        /* å¯¦ç”¨æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s; text-align: center; border: none; }
        .btn-action { flex: 1; color: white; }
        .btn-edit { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #F3F4F6; color: #4B5563; border-radius: 50%; }
        .btn-edit:hover { background: #E5E7EB; color: black; }
        .btn-del:hover { background: #FEE2E2; color: #EF4444; }

        /* ç”˜ç‰¹åœ–èˆ‡è¡Œäº‹æ›† */
        .gantt-container { overflow-x: auto; background: white; border-radius: 12px; padding: 10px; border: 1px solid #E5E7EB; }
        .gantt-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .gantt-th { text-align: center; font-size: 11px; color: #6B7280; padding: 5px; border-right: 1px solid #F3F4F6; }
        .gantt-td { border-right: 1px solid #F3F4F6; height: 36px; padding: 0; position: relative; }
        .gantt-bar { position: absolute; top: 8px; height: 20px; background: #3B82F6; border-radius: 4px; font-size: 10px; color: white; line-height: 20px; padding: 0 4px; white-space: nowrap; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #calendar-wrapper { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .fc-toolbar-title { font-size: 1.25em !important; font-weight: 800 !important; }
        .fc-button-primary { background-color: #1F2937 !important; border-color: #1F2937 !important; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-box { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* Loading */
        #loader { position: fixed; inset: 0; background: #F3F4F6; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        
        /* FAB */
        .fab-stack { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 40; }
        .fab { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="text-4xl font-black text-gray-800 mb-2">JAYRAN</div>
        <div class="text-sm text-gray-500 font-bold">SYSTEM LOADING...</div>
    </div>

    <div class="fab-stack">
        <div onclick="togglePanel('link')" class="fab bg-blue-600"><i class="fas fa-link"></i></div>
        <div onclick="togglePanel('pending')" class="fab bg-gray-600">
            <i class="fas fa-user-clock"></i>
            <span id="badge-pending" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
        </div>
        <div onclick="togglePanel('memo')" class="fab bg-black"><i class="fas fa-sticky-note"></i></div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <h1 class="text-2xl font-black mb-6">æ°å†‰å½±åƒå·¥ä½œå®¤</h1>

        <div class="nav-container">
            <div onclick="switchTab('add')" id="nav-add" class="nav-btn active"><i class="fas fa-plus mr-1"></i> æ–°å¢</div>
            <div onclick="switchTab('wei')" id="nav-wei" class="nav-btn">é­æ•è»’</div>
            <div onclick="switchTab('chiu')" id="nav-chiu" class="nav-btn">é‚±ä»æ°</div>
            <div onclick="switchTab('gan')" id="nav-gan" class="nav-btn"><i class="fas fa-chart-bar mr-1"></i> ç”˜ç‰¹åœ–</div>
            <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-btn"><i class="fas fa-calendar-alt mr-1"></i> è¡Œäº‹æ›†</div>
        </div>

        <div id="page-add" class="main-card">
            <div class="type-toggle">
                <div onclick="setCategory('video')" id="type-video" class="type-opt active">ğŸ¬ å½±ç‰‡å°ˆæ¡ˆ</div>
                <div onclick="setCategory('image')" id="type-image" class="type-opt">ğŸ¨ åœ–æ–‡å°ˆæ¡ˆ</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="input-label">å®¢æˆ¶</label>
                    <div class="flex gap-2">
                        <select id="add-zone" class="std-select" onchange="updateClientInfo()"></select>
                        <button onclick="openHistory()" class="bg-gray-200 text-gray-700 w-10 rounded-lg"><i class="fas fa-eye"></i></button>
                        <button onclick="openAddClientModal()" class="bg-black text-white w-10 rounded-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">ç·¨è™Ÿ</label>
                    <input id="add-id" class="std-input font-mono" placeholder="001">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">å®¢æˆ¶å…¨å (è‡ªå‹•å¸¶å…¥)</label>
                <input id="add-client" class="std-input bg-gray-100" disabled>
            </div>

            <div class="input-group">
                <label class="input-label">å°ˆæ¡ˆåç¨±</label>
                <input id="add-name" class="std-input font-bold" placeholder="è¼¸å…¥æ¨™é¡Œ">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="input-label">è£½ä½œäºº</label>
                    <select id="add-producer" class="std-select"></select>
                </div>
                <div class="input-group">
                    <label class="input-label">é¡å‹</label>
                    <select id="add-type" class="std-select"></select>
                </div>
            </div>

            <div class="flex items-center gap-2 mb-4">
                <input type="checkbox" id="add-urgent" class="w-5 h-5 accent-red-600">
                <label for="add-urgent" class="font-bold text-red-600">ğŸ”¥ æ¨™è¨˜ç‚ºæ€¥ä»¶</label>
            </div>

            <div class="input-group">
                <label class="input-label">æ—¥æœŸç¯„åœ</label>
                <input id="add-date" class="std-input text-center" placeholder="é»æ“Šé¸æ“‡æ—¥æœŸ">
            </div>

            <div class="input-group">
                <label class="input-label">å‚™è¨»</label>
                <textarea id="add-note" class="std-input h-20"></textarea>
            </div>

            <button onclick="submitProject()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800">å»ºç«‹å°ˆæ¡ˆ</button>
        </div>

        <div id="page-kanban" class="hidden">
            <h2 id="kb-title" class="text-2xl font-black mb-6"></h2>
            
            <div class="mb-8">
                <h3 class="text-lg font-bold text-blue-600 mb-3 border-b-2 border-blue-100 pb-1">ğŸ”¥ è£½ä½œä¸­</h3>
                <div id="kb-process" class="kanban-grid"></div>
            </div>

            <details class="mb-6" open>
                <summary class="font-bold text-orange-500 cursor-pointer mb-2">ğŸ‘€ å¯©æ ¸ä¸­</summary>
                <div id="kb-review" class="kanban-grid mt-2"></div>
            </details>

            <details class="mb-6">
                <summary class="font-bold text-gray-500 cursor-pointer mb-2">â³ å°šæœªé€²è¡Œ</summary>
                <div id="kb-todo" class="kanban-grid mt-2"></div>
            </details>

            <details class="mb-6">
                <summary class="font-bold text-green-600 cursor-pointer mb-2">âœ… å·²å®Œæˆ</summary>
                <div id="kb-done" class="kanban-grid mt-2"></div>
            </details>
        </div>

        <div id="page-gantt" class="hidden">
            <div class="main-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="gantt-month-title" class="text-xl font-bold"></h2>
                    <div class="flex gap-2">
                        <button onclick="moveGantt(-1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="moveGantt(1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="gantt-area" class="gantt-container"></div>
            </div>
        </div>

        <div id="page-calendar" class="hidden">
            <div id="calendar-wrapper">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <div id="modal-client" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-xl font-bold mb-4">æ–°å¢å®¢æˆ¶</h3>
            <label class="input-label">å¯ç”¨ä»£è™Ÿ</label>
            <select id="new-client-code" class="std-select mb-4"></select>
            <label class="input-label">å®¢æˆ¶åç¨±</label>
            <input id="new-client-name" class="std-input mb-6" placeholder="ä¾‹å¦‚ï¼šå°ç©é›»">
            <div class="flex gap-2">
                <button onclick="closeModal('client')" class="btn bg-gray-200 flex-1 text-gray-600">å–æ¶ˆ</button>
                <button onclick="submitNewClient()" class="btn bg-black flex-1 text-white">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal-overlay">
        <div class="modal-box">
            <h3 id="hist-client-title" class="text-xl font-bold mb-4"></h3>
            <div id="hist-content" class="max-h-60 overflow-y-auto mb-4">è¼‰å…¥ä¸­...</div>
            <button onclick="closeModal('history')" class="btn bg-gray-200 w-full">é—œé–‰</button>
        </div>
    </div>

    <div id="modal-edit" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-xl font-bold mb-4">ç·¨è¼¯å°ˆæ¡ˆ</h3>
            <input type="hidden" id="edit-oid"><input type="hidden" id="edit-ozone">
            <div class="flex gap-2 mb-3">
                <input id="edit-id" class="std-input w-24 text-center font-bold" disabled>
                <input id="edit-name" class="std-input flex-1 font-bold">
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <select id="edit-prod" class="std-select"></select>
                <select id="edit-type" class="std-select"></select>
            </div>
            <input id="edit-date" class="std-input text-center mb-3">
            <textarea id="edit-note" class="std-input h-20 mb-6"></textarea>
            
            <div class="flex gap-2">
                <button onclick="deleteProject()" class="btn bg-red-100 text-red-500 w-1/3">åˆªé™¤</button>
                <button onclick="saveEdit()" class="btn bg-black text-white w-2/3">å„²å­˜è®Šæ›´</button>
            </div>
            <div onclick="closeModal('edit')" class="text-center mt-4 text-gray-400 text-sm cursor-pointer">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="modal-status" class="modal-overlay">
        <div class="modal-box text-center">
            <h3 class="text-xl font-bold mb-2">æ›´æ–°é€²åº¦</h3>
            <p class="text-gray-500 text-sm mb-4">è«‹è¼¸å…¥æœ¬æ¬¡å·¥æ™‚ (è‹¥ç„¡å¯å¡« 0)</p>
            <input type="hidden" id="status-id"><input type="hidden" id="status-zone">
            <input id="status-hours" type="number" class="std-input text-center text-3xl font-bold mb-6" placeholder="0.0">
            <div class="flex gap-2">
                <button onclick="submitStatus('è£½ä½œä¸­')" class="btn bg-gray-100 flex-1 text-black">é€€ä¿® / è£½ä½œ</button>
                <button onclick="submitStatus('å®¢æˆ¶å¯©æ ¸')" class="btn bg-orange-500 flex-1 text-white">é€å¯©</button>
                <button onclick="submitStatus('å·²å®Œæˆ')" class="btn bg-green-500 flex-1 text-white">å®Œæˆ</button>
            </div>
            <div onclick="closeModal('status')" class="mt-4 text-gray-400 text-sm cursor-pointer">å–æ¶ˆ</div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… ç¶²å€å¯«æ­»ï¼Œä¸ç”¨å†å¡« â˜…â˜…â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbxEK4TafDLSKqfn3QuJk2bwNpnWcPMcOoNt6nVmz2w4geyMoRL4Bx_ILVIAtBbGhVCV/exec';

        // è³‡æ–™å®¹å™¨
        let DATA = { projects: [], config: {}, ids: {} };
        let curCat = 'video'; // video æˆ– image
        let curTab = 'add';
        let ganttDate = new Date();
        const fpAdd = flatpickr("#add-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpEdit = flatpickr("#edit-date", { mode: "range", dateFormat: "Y-m-d" });
        let calendar = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            // å…ˆè®€å¿«å–è®“ç•«é¢ç§’é–‹
            const cache = localStorage.getItem('JAYRAN_CACHE');
            if (cache) { renderApp(JSON.parse(cache)); }
            
            // èƒŒæ™¯æŠ“æ–°è³‡æ–™
            fetchData();
        };

        function fetchData() {
            fetch(API_URL + '?action=initAllData')
            .then(r => r.json())
            .then(d => {
                localStorage.setItem('JAYRAN_CACHE', JSON.stringify(d));
                renderApp(d);
                document.getElementById('loader').style.display = 'none';
            })
            .catch(e => {
                console.error(e);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                document.getElementById('loader').style.display = 'none';
            });
        }

        function renderApp(d) {
            DATA = d;
            renderOptions();
            if (curTab === 'wei') renderKanban('é­æ•è»’');
            else if (curTab === 'chiu') renderKanban('é‚±ä»æ°');
            else if (curTab === 'gan') renderGantt();
            else if (curTab === 'calendar') renderCalendar();
        }

        // --- ä»‹é¢é‚è¼¯ ---
        function switchTab(t) {
            curTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + t).classList.add('active');
            
            ['page-add', 'page-kanban', 'page-gantt', 'page-calendar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (t === 'add') document.getElementById('page-add').classList.remove('hidden');
            else if (t === 'wei') { document.getElementById('page-kanban').classList.remove('hidden'); renderKanban('é­æ•è»’'); }
            else if (t === 'chiu') { document.getElementById('page-kanban').classList.remove('hidden'); renderKanban('é‚±ä»æ°'); }
            else if (t === 'gan') { document.getElementById('page-gantt').classList.remove('hidden'); renderGantt(); }
            else if (t === 'calendar') { 
                document.getElementById('page-calendar').classList.remove('hidden'); 
                setTimeout(renderCalendar, 200); // å»¶é²æ¸²æŸ“é¿å… FullCalendar ç ´åœ–
            }
        }

        function setCategory(c) {
            curCat = c;
            document.getElementById('type-video').className = c === 'video' ? 'type-opt active' : 'type-opt';
            document.getElementById('type-image').className = c === 'image' ? 'type-opt active' : 'type-opt';
            renderOptions();
        }

        function renderOptions() {
            // å¡«å…¥å®¢æˆ¶é¸å–®
            const zSel = document.getElementById('add-zone');
            zSel.innerHTML = '<option value="">é¸æ“‡å®¢æˆ¶</option>';
            const zones = curCat === 'video' ? DATA.videoSettings : DATA.imageSettings;
            if (zones) Object.keys(zones).sort().forEach(k => zSel.add(new Option(k, k)));

            // å¡«å…¥è£½ä½œäººèˆ‡é¡å‹
            const fill = (id, list) => {
                const el = document.getElementById(id); el.innerHTML = '';
                list.forEach(x => el.add(new Option(x, x)));
            };
            if (DATA.config) {
                const types = curCat === 'video' ? DATA.config.videoTypes : DATA.config.imageTypes;
                const prods = curCat === 'video' ? DATA.config.videoProducers : DATA.config.imageProducers;
                fill('add-producer', prods); fill('add-type', types);
                fill('edit-prod', prods); fill('edit-type', types);
            }
        }

        function updateClientInfo() {
            const z = document.getElementById('add-zone').value;
            if (z) {
                // è‡ªå‹•æ‹†è§£åç¨± (ä¾‹å¦‚ A_å°ç©é›» -> å°ç©é›»)
                const name = z.includes('_') ? z.split('_')[1] : z;
                document.getElementById('add-client').value = name;
                
                // è‡ªå‹•ç·¨è™Ÿ (æ‰¾è©²å®¢æˆ¶ç›®å‰æœ€å¤§è™Ÿ + 1)
                let max = 0;
                DATA.projects.forEach(p => {
                    if (p.zone === z) {
                        const num = parseInt(p.id.replace(/\D/g, '')) || 0;
                        if (num > max) max = num;
                    }
                });
                document.getElementById('add-id').value = String(max + 1).padStart(3, '0');
            }
        }

        // --- æ–°å¢å°ˆæ¡ˆ ---
        function submitProject() {
            const p = {
                category: curCat,
                zone: document.getElementById('add-zone').value,
                id: document.getElementById('add-id').value,
                client: document.getElementById('add-client').value,
                name: document.getElementById('add-name').value,
                producer: document.getElementById('add-producer').value,
                type: document.getElementById('add-type').value,
                note: document.getElementById('add-note').value,
                tag: document.getElementById('add-urgent').checked ? 'Urgent' : '',
                status: 'å°šæœªé€²è¡Œ'
            };
            const dates = document.getElementById('add-date').value.split(' to ');
            if (dates[0]) { p.start = dates[0]; p.end = dates[1] || dates[0]; }
            
            // è‡ªå‹•åˆ¤æ–·æ˜¯å¦è£½ä½œä¸­
            if (p.producer !== 'å°šæœªæš«å®š' && p.start) {
                if (new Date(p.start) <= new Date()) p.status = 'è£½ä½œä¸­';
            }

            if (!p.zone || !p.name) return alert("è«‹å¡«å¯«å®¢æˆ¶èˆ‡å°ˆæ¡ˆåç¨±");

            // æ¨‚è§€æ›´æ–°
            DATA.projects.push(p);
            localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
            alert("âœ… å°ˆæ¡ˆå·²å»ºç«‹ (èƒŒæ™¯åŒæ­¥ä¸­)");
            
            // æ¸…ç©ºæ¬„ä½
            document.getElementById('add-name').value = '';
            document.getElementById('add-note').value = '';
            updateClientInfo(); // è®“ç·¨è™Ÿ+1

            // å‚³é€
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addProject', payload: p }) });
        }

        // --- æ–°å¢å®¢æˆ¶é‚è¼¯ (ä¿®å¾©ç‰ˆ) ---
        function openAddClientModal() {
            const codeSel = document.getElementById('new-client-code');
            codeSel.innerHTML = '';
            
            const allCodes = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            const usedCodes = curCat === 'video' ? DATA.usedCodesVideo : DATA.usedCodesImage;
            // éæ¿¾æ‰å·²ä½¿ç”¨çš„ä»£ç¢¼
            const available = allCodes.filter(c => !usedCodes.includes(curCat==='image'?c.toLowerCase():c));
            
            available.forEach(c => codeSel.add(new Option(curCat==='image'?c.toLowerCase():c, curCat==='image'?c.toLowerCase():c)));
            
            document.getElementById('modal-client').style.display = 'flex';
        }

        function submitNewClient() {
            const code = document.getElementById('new-client-code').value;
            const name = document.getElementById('new-client-name').value;
            if (!name) return alert("è«‹è¼¸å…¥åç¨±");
            
            document.getElementById('modal-client').style.display = 'none';
            alert("âœ… å®¢æˆ¶å»ºç«‹ä¸­ï¼Œè«‹ç¨å¾Œé‡æ–°æ•´ç†é é¢");
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'createClient', cat: curCat, code: code, name: name }) })
            .then(() => location.reload());
        }

        // --- çœ‹æ¿æ¸²æŸ“ (ä¿®å¾© UI) ---
        function renderKanban(who) {
            document.getElementById('kb-title').innerText = who + " çš„ä»»å‹™";
            const tasks = DATA.projects.filter(p => p.producer === who);
            
            const buckets = { 'è£½ä½œä¸­': [], 'å¯©': [], 'å°šæœª': [], 'å®Œæˆ': [] };
            tasks.forEach(p => {
                if (p.status === 'è£½ä½œä¸­') buckets['è£½ä½œä¸­'].push(p);
                else if (p.status.includes('å¯©')) buckets['å¯©'].push(p);
                else if (p.status === 'å°šæœªé€²è¡Œ') buckets['å°šæœª'].push(p);
                else buckets['å®Œæˆ'].push(p);
            });

            const draw = (arr, elId) => {
                const el = document.getElementById(elId);
                if (arr.length === 0) { el.innerHTML = '<div class="text-gray-300 text-center py-4">ç„¡é …ç›®</div>'; return; }
                
                el.innerHTML = arr.map(p => {
                    let borderClass = 'k-card';
                    if (p.status === 'è£½ä½œä¸­') borderClass += ' k-blue';
                    else if (p.status.includes('å¯©')) borderClass += ' k-orange';
                    else if (p.status.includes('å®Œæˆ')) borderClass += ' k-green';

                    return `
                    <div class="${borderClass}">
                        <div class="k-header">
                            <span class="k-id">${p.id}</span>
                            <div class="flex gap-2">
                                <div onclick="openEdit('${p.id}','${p.zone}')" class="btn-edit cursor-pointer"><i class="fas fa-pen"></i></div>
                                <div onclick="deleteProject('${p.id}','${p.zone}', '${p.category}')" class="btn-edit cursor-pointer hover:bg-red-100 hover:text-red-500"><i class="fas fa-trash"></i></div>
                            </div>
                        </div>
                        <div class="k-title">${p.name}</div>
                        <div class="k-client">${p.client} ${p.tag === 'Urgent' ? '<span class="text-red-500 ml-2 font-bold">ğŸ”¥ æ€¥ä»¶</span>' : ''}</div>
                        <div class="text-xs text-gray-400 mt-2"><i class="far fa-clock"></i> ${p.start || '--'} ~ ${p.end || '--'}</div>
                        
                        <div class="k-footer">
                            <div class="k-actions">
                                ${ p.status === 'è£½ä½œä¸­' ? 
                                   `<button onclick="openStatus('${p.id}','${p.zone}')" class="btn btn-action bg-orange-500">é€å¯©</button>` : '' }
                                ${ p.status.includes('å¯©') ? 
                                   `<button onclick="quickUpdate('${p.id}','${p.zone}','è£½ä½œä¸­')" class="btn btn-action bg-gray-500">é€€ä¿®</button>
                                    <button onclick="quickUpdate('${p.id}','${p.zone}','å·²å®Œæˆ')" class="btn btn-action bg-black">å®Œæˆ</button>` : '' }
                                ${ p.status === 'å°šæœªé€²è¡Œ' ? 
                                   `<button onclick="quickUpdate('${p.id}','${p.zone}','è£½ä½œä¸­')" class="btn btn-action bg-blue-600">é–‹å§‹è£½ä½œ</button>` : '' }
                            </div>
                        </div>
                    </div>`;
                }).join('');
            };

            draw(buckets['è£½ä½œä¸­'], 'kb-process');
            draw(buckets['å¯©'], 'kb-review');
            draw(buckets['å°šæœª'], 'kb-todo');
            draw(buckets['å®Œæˆ'], 'kb-done');
        }

        // --- ç·¨è¼¯èˆ‡ç‹€æ…‹æ›´æ–° ---
        function openEdit(id, zone) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if (!p) return;
            document.getElementById('edit-oid').value = p.id;
            document.getElementById('edit-ozone').value = p.zone;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-prod').value = p.producer;
            document.getElementById('edit-type').value = p.type;
            if (p.start) fpEdit.setDate([p.start, p.end]);
            document.getElementById('edit-note').value = p.note;
            document.getElementById('modal-edit').style.display = 'flex';
        }

        function saveEdit() {
            const originId = document.getElementById('edit-oid').value;
            const originZone = document.getElementById('edit-ozone').value;
            const p = DATA.projects.find(x => x.id === originId && x.zone === originZone);
            
            if (p) {
                p.name = document.getElementById('edit-name').value;
                p.producer = document.getElementById('edit-prod').value;
                p.type = document.getElementById('edit-type').value;
                p.note = document.getElementById('edit-note').value;
                const dates = document.getElementById('edit-date').value.split(' to ');
                if (dates[0]) { p.start = dates[0]; p.end = dates[1] || dates[0]; }
                
                localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
                renderApp(DATA);
                
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateProject', payload: p, originId: originId, originZone: originZone }) });
            }
            document.getElementById('modal-edit').style.display = 'none';
        }

        function deleteProject(id, zone, cat) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿç„¡æ³•å¾©åŸï¼")) return;
            DATA.projects = DATA.projects.filter(p => !(p.id === id && p.zone === zone));
            localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
            renderApp(DATA);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteProject', cat: cat, zone: zone, id: id }) });
        }

        function openStatus(id, zone) {
            document.getElementById('status-id').value = id;
            document.getElementById('status-zone').value = zone;
            document.getElementById('status-hours').value = '';
            document.getElementById('modal-status').style.display = 'flex';
        }

        function submitStatus(status) {
            const id = document.getElementById('status-id').value;
            const zone = document.getElementById('status-zone').value;
            const hours = document.getElementById('status-hours').value;
            quickUpdate(id, zone, status, hours);
            document.getElementById('modal-status').style.display = 'none';
        }

        function quickUpdate(id, zone, status, hours=0) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if (p) {
                p.status = status;
                if(hours > 0) p.hours = (parseFloat(p.hours) || 0) + parseFloat(hours);
                localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
                renderApp(DATA);
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', cat: p.category, zone: zone, id: id, status: status, hours: hours }) });
            }
        }

        // --- ç”˜ç‰¹åœ– (ä¿®å¾©ç‰ˆ) ---
        function renderGantt() {
            const container = document.getElementById('gantt-area');
            const y = ganttDate.getFullYear();
            const m = ganttDate.getMonth();
            document.getElementById('gantt-month-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            
            const daysInMonth = new Date(y, m+1, 0).getDate();
            let html = `<table class="gantt-table"><thead><tr><th class="gantt-th w-24 sticky left-0 bg-white">å°ˆæ¡ˆ</th>`;
            
            for(let i=1; i<=daysInMonth; i++) {
                html += `<th class="gantt-th">${i}</th>`;
            }
            html += `</tr></thead><tbody>`;
            
            DATA.projects.forEach(p => {
                if(!p.start || !p.end) return;
                const s = new Date(p.start);
                const e = new Date(p.end);
                
                // åªé¡¯ç¤ºæœ¬æœˆçš„
                if(e < new Date(y, m, 1) || s > new Date(y, m+1, 0)) return;
                
                let startDay = s < new Date(y, m, 1) ? 1 : s.getDate();
                let endDay = e > new Date(y, m+1, 0) ? daysInMonth : e.getDate();
                let width = (endDay - startDay + 1) * 28; // æ¯æ ¼ç´„28px
                let left = (startDay - 1) * 28;

                let color = '#9CA3AF';
                if(p.status === 'è£½ä½œä¸­') color = '#2563EB';
                if(p.status.includes('å¯©')) color = '#F59E0B';
                if(p.status === 'å·²å®Œæˆ') color = '#10B981';

                html += `<tr><td class="gantt-td w-24 sticky left-0 bg-white border-r text-xs font-bold px-1 truncate">${p.name}</td>
                         <td class="gantt-td" colspan="${daysInMonth}">
                            <div class="absolute h-5 rounded text-white text-xs px-1 overflow-hidden" 
                                 style="left:${left}px; width:${width}px; top:8px; background:${color};">
                                ${p.producer}
                            </div>
                         </td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function moveGantt(n) {
            ganttDate.setMonth(ganttDate.getMonth() + n);
            renderGantt();
        }

        // --- è¡Œäº‹æ›† (ä¿®å¾©ç‰ˆ) ---
        function renderCalendar() {
            if (calendar) calendar.destroy();
            const el = document.getElementById('calendar');
            const events = DATA.projects.filter(p => p.start).map(p => ({
                title: p.name + ` (${p.producer})`,
                start: p.start,
                end: new Date(new Date(p.end).getTime() + 86400000).toISOString().slice(0, 10), // FullCalendar end is exclusive
                color: p.status === 'è£½ä½œä¸­' ? '#2563EB' : (p.status.includes('å¯©') ? '#F59E0B' : '#10B981')
            }));
            
            calendar = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                events: events,
                headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                height: 600,
                contentHeight: 600
            });
            calendar.render();
        }

        // --- å…¶ä»– ---
        function openHistory() {
            const z = document.getElementById('add-zone').value;
            if(!z) return alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
            document.getElementById('hist-client-title').innerText = z.split('_')[1] + " æ­·å²ç´€éŒ„";
            document.getElementById('modal-history').style.display = 'flex';
            
            fetch(API_URL + `?action=getHistory&zone=${z}&cat=${curCat}`)
            .then(r => r.json())
            .then(list => {
                document.getElementById('hist-content').innerHTML = list.map(h => 
                    `<div class="flex justify-between py-2 border-b"><span class="font-bold">${h.name}</span><span class="text-sm text-gray-500">${h.status}</span></div>`
                ).join('') || 'ç„¡ç´€éŒ„';
            });
        }

        function closeModal(id) { document.getElementById('modal-' + id).style.display = 'none'; }
    </script>
</body>
</html>
