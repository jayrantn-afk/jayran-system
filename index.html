<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°å†‰å½±åƒå·¥ä½œå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        /* --- V6 Apple æ¥µç°¡é¢¨æ ¼ --- */
        :root { --bg: #F5F5F7; --card-bg: #FFFFFF; --text-main: #1D1D1F; --text-sec: #86868B; --accent: #007AFF; --danger: #FF3B30; --radius: 12px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* å°èˆªåˆ— */
        .segmented-nav { background: #E5E5EA; padding: 4px; border-radius: 14px; display: flex; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .nav-item { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; color: var(--text-sec); cursor: pointer; border-radius: 10px; transition: all 0.2s; }
        .nav-item.active { background: #FFFFFF; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .clean-card { background: var(--card-bg); border-radius: 18px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.02); }
        .clean-input, .clean-select { width: 100%; padding: 12px; background: #F5F5F7; border: 1px solid transparent; border-radius: 10px; font-size: 15px; font-weight: 500; transition: 0.2s; outline: none; }
        .clean-input:focus, .clean-select:focus { background: #FFFFFF; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        
        /* æŒ‰éˆ• */
        .btn-main { background: var(--text-main); color: white; width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 15px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-main:active { transform: scale(0.98); }
        .icon-btn { width: 40px; height: 40px; border-radius: 10px; display: flex; justify-content: center; align-items: center; background: #E5E5EA; color: var(--text-main); cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { background: #D1D1D6; }

        /* çœ‹æ¿è¨­è¨ˆ */
        .kanban-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .kanban-grid { grid-template-columns: repeat(2, 1fr); } }
        .kanban-item { background: white; border-radius: 16px; padding: 20px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.04); transition: 0.2s; }
        .kanban-item:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        
        .k-tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 700; color: white; display: inline-block; margin-bottom: 8px; }
        .tag-blue { background: #007AFF; } .tag-orange { background: #FF9500; } .tag-green { background: #34C759; } .tag-gray { background: #8E8E93; }
        .k-title { font-size: 17px; font-weight: 700; color: #1D1D1F; margin-bottom: 4px; line-height: 1.4; }
        .k-meta { font-size: 13px; color: #86868B; display: flex; align-items: center; gap: 6px; margin-top: 8px; }
        
        /* ç”˜ç‰¹åœ–å„ªåŒ– - ä¸æœƒè·‘ç‰ˆ */
        .gantt-wrapper { overflow-x: auto; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); width: 100%; border: 1px solid rgba(0,0,0,0.03); white-space: nowrap; }
        .gantt-table { border-collapse: collapse; min-width: 100%; } 
        .gantt-header-cell { text-align: center; font-size: 11px; font-weight: 700; color: #8E8E93; padding: 10px 4px; min-width: 24px; }
        .gantt-today { background-color: #FFF9C4; } 
        .gantt-bar { position: absolute; top: 12px; height: 20px; border-radius: 4px; color: white; font-size: 10px; line-height: 20px; padding: 0 6px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        /* Modal & FAB */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 50; }
        .modal-body { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 40; }
        .fab-btn { width: 52px; height: 52px; background: #1D1D1F; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1); }
        .hidden { display: none; }
        
        /* Setup Modal */
        #setup-modal { display: flex; z-index: 1000; }
    </style>
</head>
<body>
    <div id="setup-modal" class="modal-mask">
        <div class="modal-body text-center">
            <h2 class="text-2xl font-black mb-4">ğŸ”— é€£æ¥ç³»çµ±</h2>
            <p class="text-gray-500 text-sm mb-4">è«‹è²¼ä¸Šæ‚¨å‰›å‰›éƒ¨ç½²ç²å¾—çš„ Google Apps Script ç¶²å€ (ä»¥ .../exec çµå°¾)</p>
            <input id="api-url-input" class="clean-input mb-4 text-center text-sm" placeholder="https://script.google.com/...">
            <button onclick="saveApiUrl()" class="btn-main">é–‹å§‹ä½¿ç”¨</button>
        </div>
    </div>

    <div id="loader" class="fixed top-0 left-0 w-full h-full bg-[#F5F5F7] flex flex-col justify-center items-center z-[49] hidden">
        <div class="text-2xl font-black tracking-widest animate-pulse text-gray-400">JAYRAN</div>
    </div>

    <div class="fab-container">
        <div onclick="togglePanel('link')" class="fab-btn" style="background:#007AFF;" title="é€£çµ"><i class="fas fa-link"></i></div>
        <div onclick="togglePanel('pending')" class="fab-btn" style="background:#8E8E93;" title="å¾…åˆ†æ´¾"><i class="fas fa-user-clock"></i></div>
        <div onclick="togglePanel('memo')" class="fab-btn" title="ä¾¿åˆ©è²¼"><i class="fas fa-sticky-note"></i></div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-8">
        <div class="mb-6 px-2 flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tight">æ°å†‰å½±åƒå·¥ä½œå®¤</h1>
            <div onclick="clearApiCache()" class="text-xs text-gray-400 cursor-pointer hover:text-red-500">é‡è¨­é€£ç·š</div>
        </div>
        
        <div class="segmented-nav">
            <div onclick="switchTab('add')" id="nav-add" class="nav-item active">æ–°å¢</div>
            <div onclick="switchTab('wei')" id="nav-wei" class="nav-item">é­æ•è»’</div>
            <div onclick="switchTab('chiu')" id="nav-chiu" class="nav-item">é‚±ä»æ°</div>
            <div onclick="switchTab('gan')" id="nav-gan" class="nav-item">ç”˜ç‰¹åœ–</div>
            <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-item">è¡Œäº‹æ›†</div>
        </div>

        <div id="p-add" class="clean-card">
            <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                <div onclick="setCat('video')" id="t-video" class="flex-1 text-center py-2 text-sm font-bold rounded-lg bg-white shadow-sm cursor-pointer">ğŸ¬ å½±ç‰‡</div>
                <div onclick="setCat('image')" id="t-image" class="flex-1 text-center py-2 text-sm font-bold text-gray-500 cursor-pointer">ğŸ¨ åœ–æ–‡</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">å®¢æˆ¶</label>
                    <div class="flex gap-2 mt-1">
                        <select id="i-zone" onchange="updateClientName()" class="clean-select flex-1"></select>
                        <div onclick="openZoneModal()" class="icon-btn"><i class="fas fa-plus"></i></div>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">ç·¨è™Ÿ</label>
                    <input id="i-id" class="clean-input mt-1 font-mono" placeholder="001">
                </div>
            </div>
            
            <input id="i-client" class="clean-input mb-4 bg-gray-50 text-gray-500" disabled>
            <input id="i-name" class="clean-input mb-4 font-bold" placeholder="å°ˆæ¡ˆåç¨±">
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">è£½ä½œäºº</label>
                    <select id="i-producer" class="clean-select mt-1"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">é¡å‹</label>
                    <select id="i-type" class="clean-select mt-1"></select>
                </div>
            </div>
            
            <div class="flex items-center gap-2 mb-4 px-1">
                <input type="checkbox" id="i-urgent" class="w-5 h-5 accent-red-500">
                <label for="i-urgent" class="font-bold text-red-500 text-sm">æ¨™è¨˜ç‚ºæ€¥ä»¶</label>
            </div>
            
            <input id="i-date" class="clean-input text-center mb-6" placeholder="é¸æ“‡æ—¥æœŸç¯„åœ">
            <button onclick="saveProject()" class="btn-main">å»ºç«‹å°ˆæ¡ˆ</button>
        </div>

        <div id="p-kanban" class="hidden">
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4 px-1">ğŸ”¥ è£½ä½œä¸­</h3>
                <div id="kb-process" class="kanban-grid"></div>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-400 mb-4 px-1">ğŸ‘€ å¯©æ ¸ä¸­</h3>
                <div id="kb-review" class="kanban-grid"></div>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-400 mb-4 px-1">â³ å°šæœªé€²è¡Œ</h3>
                <div id="kb-todo" class="kanban-grid"></div>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-400 mb-4 px-1">âœ… å·²å®Œæˆ</h3>
                <div id="kb-done" class="kanban-grid"></div>
            </div>
        </div>

        <div id="p-gantt" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="gan-title" class="text-xl font-bold">ç”˜ç‰¹åœ–</h2>
                <div class="flex gap-2">
                    <button class="icon-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="icon-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="p-calendar" class="hidden">
            <div id="calendar-container" class="bg-white p-4 rounded-2xl shadow-sm">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <div id="modal-zone" class="modal-mask"><div class="modal-body">
        <h3 class="font-bold text-lg mb-4">æ–°å¢å®¢æˆ¶</h3>
        <select id="m-z-code" class="clean-select mb-3"></select>
        <input id="m-z-name" class="clean-input mb-6" placeholder="å®¢æˆ¶åç¨±">
        <button onclick="confirmZone()" class="btn-main">ç¢ºèªæ–°å¢</button>
        <div onclick="closeModal('zone')" class="text-center text-gray-400 mt-4 text-sm cursor-pointer">å–æ¶ˆ</div>
    </div></div>

    <div id="modal-edit" class="modal-mask"><div class="modal-body">
        <h3 class="font-bold text-lg mb-4">ç·¨è¼¯å°ˆæ¡ˆ</h3>
        <input type="hidden" id="e-oid"><input type="hidden" id="e-ozone">
        <div class="flex gap-2 mb-3">
            <select id="e-code" class="clean-select w-20" onchange="updateEditClient()"></select>
            <input id="e-client" class="clean-input flex-1 bg-gray-50" disabled>
            <input id="e-num" class="clean-input w-24 text-center">
        </div>
        <input id="e-name" class="clean-input mb-3 font-bold">
        <div class="flex gap-3 mb-3">
            <select id="e-prod" class="clean-select"></select>
            <select id="e-type" class="clean-select"></select>
        </div>
        <input id="e-date" class="clean-input text-center mb-6">
        <div class="flex gap-2">
            <button onclick="deleteProj()" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold">åˆªé™¤</button>
            <button onclick="saveEdit()" class="flex-1 bg-black text-white py-3 rounded-xl font-bold">å„²å­˜</button>
        </div>
        <div onclick="closeModal('edit')" class="text-center text-gray-400 mt-4 text-sm cursor-pointer">å–æ¶ˆ</div>
    </div></div>

    <div id="modal-action" class="modal-mask"><div class="modal-body">
        <h3 class="font-bold text-lg mb-2">æ›´æ–°ç‹€æ…‹</h3>
        <input type="hidden" id="a-id"><input type="hidden" id="a-zone">
        <p class="text-sm text-gray-500 mb-4">è‹¥å®Œæˆæˆ–é€å¯©ï¼Œè«‹è¼¸å…¥å·¥æ™‚ï¼š</p>
        <input id="a-hours" type="number" class="clean-input text-center text-2xl font-bold mb-6" placeholder="0.0">
        <div class="flex gap-2">
            <button onclick="doAction('è£½ä½œä¸­')" class="flex-1 bg-gray-100 text-black py-3 rounded-xl font-bold">é€€ä¿® / è£½ä½œ</button>
            <button onclick="doAction('å®¢æˆ¶å¯©æ ¸')" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">é€å¯©</button>
            <button onclick="doAction('å·²å®Œæˆ')" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold">å®Œæˆ</button>
        </div>
        <div onclick="closeModal('action')" class="text-center text-gray-400 mt-4 text-sm cursor-pointer">å–æ¶ˆ</div>
    </div></div>

    <script>
        // â˜… æ ¸å¿ƒé‚è¼¯ï¼šç¶²å€å„²å­˜æ–¼ LocalStorageï¼Œé¿å…æ¯æ¬¡ä¿®æ”¹ â˜…
        let API_URL = localStorage.getItem('JAYRAN_API_URL');
        let DATA = { projects: [], config: {} };
        let curCat = 'video';
        let curTab = 'add';
        let curDate = new Date();
        const fp = flatpickr("#i-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpEdit = flatpickr("#e-date", { mode: "range", dateFormat: "Y-m-d" });

        // åˆå§‹åŒ–
        if (!API_URL) { document.getElementById('setup-modal').style.display = 'flex'; } 
        else { loadData(); }

        function saveApiUrl() {
            const url = document.getElementById('api-url-input').value.trim();
            if (!url.includes('/exec')) return alert('ç¶²å€æ ¼å¼éŒ¯èª¤');
            localStorage.setItem('JAYRAN_API_URL', url);
            API_URL = url;
            document.getElementById('setup-modal').style.display = 'none';
            loadData();
        }

        function clearApiCache() {
            if(confirm('ç¢ºå®šè¦é‡è¨­é€£ç·šç¶²å€å—ï¼Ÿ')) {
                localStorage.removeItem('JAYRAN_API_URL');
                location.reload();
            }
        }

        function loadData() {
            document.getElementById('loader').classList.remove('hidden');
            // å…ˆè®€å¿«å–
            const cache = localStorage.getItem('JAYRAN_CACHE');
            if (cache) { renderAll(JSON.parse(cache)); }

            // å†è®€ç¶²è·¯
            fetch(API_URL + '?action=initAllData')
                .then(r => r.json())
                .then(d => {
                    localStorage.setItem('JAYRAN_CACHE', JSON.stringify(d));
                    renderAll(d);
                    document.getElementById('loader').classList.add('hidden');
                })
                .catch(e => { alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯'); document.getElementById('loader').classList.add('hidden'); });
        }

        function renderAll(d) {
            DATA = d;
            renderOptions();
            if(curTab === 'wei') renderKanban('é­æ•è»’');
            else if(curTab === 'chiu') renderKanban('é‚±ä»æ°');
            else if(curTab === 'gan') renderGantt();
            else if(curTab === 'calendar') renderCalendar();
        }

        function renderOptions() {
            const z = document.getElementById('i-zone'); z.innerHTML = '<option value="">é¸æ“‡å®¢æˆ¶</option>';
            const conf = (curCat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            if(conf) Object.keys(conf).sort().forEach(k => z.add(new Option(k,k)));
            
            const fill = (id, list) => {
                const el = document.getElementById(id); el.innerHTML = '';
                list.forEach(i => el.add(new Option(i, i)));
            };
            if(DATA.config) {
                const types = (curCat==='video') ? DATA.config.videoTypes : DATA.config.imageTypes;
                const prods = (curCat==='video') ? DATA.config.videoProducers : DATA.config.imageProducers;
                fill('i-type', types); fill('i-producer', prods);
                fill('e-type', types); fill('e-prod', prods);
            }
            
            // Code options
            const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            const cList = (curCat==='image') ? abc.map(x=>x.toLowerCase()) : abc;
            const codeSel = document.getElementById('m-z-code'); codeSel.innerHTML='';
            cList.forEach(c => codeSel.add(new Option(c,c)));
            const eCode = document.getElementById('e-code'); eCode.innerHTML='';
            cList.forEach(c => eCode.add(new Option(c,c)));
        }

        function setCat(c) {
            curCat = c;
            document.getElementById('t-video').className = c==='video' ? 'flex-1 text-center py-2 text-sm font-bold rounded-lg bg-white shadow-sm cursor-pointer' : 'flex-1 text-center py-2 text-sm font-bold text-gray-500 cursor-pointer';
            document.getElementById('t-image').className = c==='image' ? 'flex-1 text-center py-2 text-sm font-bold rounded-lg bg-white shadow-sm cursor-pointer' : 'flex-1 text-center py-2 text-sm font-bold text-gray-500 cursor-pointer';
            renderOptions();
        }

        function updateClientName() {
            const v = document.getElementById('i-zone').value;
            if(v) {
                const name = v.includes('_') ? v.split('_')[1] : v;
                document.getElementById('i-client').value = name;
                // Auto ID logic
                let max = 0;
                DATA.projects.forEach(p => { if(p.zone === v) { const n = parseInt(p.id.replace(/\D/g,'')); if(n>max) max=n; }});
                document.getElementById('i-id').value = String(max+1).padStart(3,'0');
            }
        }

        function saveProject() {
            const p = {
                category: curCat,
                zone: document.getElementById('i-zone').value,
                id: document.getElementById('i-id').value,
                client: document.getElementById('i-client').value,
                name: document.getElementById('i-name').value,
                producer: document.getElementById('i-producer').value,
                type: document.getElementById('i-type').value,
                note: document.getElementById('i-note').value,
                tag: document.getElementById('i-urgent').checked ? 'Urgent' : '',
                status: 'å°šæœªé€²è¡Œ'
            };
            const dates = document.getElementById('i-date').value.split(' to ');
            if(dates[0]) { p.start = dates[0]; p.end = dates[1] || dates[0]; }
            if(p.producer !== 'å°šæœªæš«å®š' && p.start) {
                if(new Date(p.start) <= new Date()) p.status = 'è£½ä½œä¸­';
            }

            if(!p.zone || !p.name) return alert('è«‹å¡«å¯«å®Œæ•´');
            
            // Optimistic UI
            DATA.projects.push(p);
            localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
            alert('å·²å»ºç«‹ (èƒŒæ™¯åŒæ­¥ä¸­)');
            
            // Send
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'addProject', payload:p}) });
            
            // Clear
            document.getElementById('i-name').value = '';
            document.getElementById('i-note').value = '';
            updateClientName(); // Reset ID
        }

        // --- çœ‹æ¿é‚è¼¯ ---
        function renderKanban(who) {
            const list = DATA.projects.filter(p => p.producer === who);
            const cols = { 'è£½ä½œä¸­': [], 'å¯©': [], 'å°šæœª': [], 'å®Œæˆ': [] };
            
            list.forEach(p => {
                if(p.status === 'è£½ä½œä¸­') cols['è£½ä½œä¸­'].push(p);
                else if(p.status.includes('å¯©')) cols['å¯©'].push(p);
                else if(p.status === 'å°šæœªé€²è¡Œ') cols['å°šæœª'].push(p);
                else cols['å®Œæˆ'].push(p);
            });

            const draw = (arr, id) => {
                const el = document.getElementById(id);
                el.innerHTML = arr.map(p => `
                    <div class="kanban-item">
                        <div class="flex justify-between items-start mb-2">
                            <span class="k-tag ${getTagColor(p.status)}">${p.status}</span>
                            <div class="flex gap-2">
                                <div onclick="openAction('${p.id}','${p.zone}')" class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center cursor-pointer text-gray-500 hover:bg-black hover:text-white transition"><i class="fas fa-check text-xs"></i></div>
                                <div onclick="openEdit('${p.id}','${p.zone}')" class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center cursor-pointer text-gray-500 hover:bg-black hover:text-white transition"><i class="fas fa-pen text-xs"></i></div>
                            </div>
                        </div>
                        <div class="k-title">${p.name}</div>
                        <div class="text-xs text-gray-400 font-mono mb-2">${p.id} Â· ${p.client}</div>
                        ${ p.start ? `<div class="k-meta"><i class="far fa-clock"></i> ${p.start.slice(5)}~${p.end.slice(5)}</div>` : '' }
                        ${ p.tag==='Urgent' ? `<div class="mt-2 text-xs font-bold text-red-500">ğŸ”¥ æ€¥ä»¶</div>` : '' }
                        <div class="w-full bg-gray-100 h-1 mt-3 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full" style="width:${calcProgress(p)}%"></div>
                        </div>
                    </div>
                `).join('') || '<div class="text-center text-gray-300 py-4 text-sm">ç„¡é …ç›®</div>';
            };

            draw(cols['è£½ä½œä¸­'], 'kb-process');
            draw(cols['å¯©'], 'kb-review');
            draw(cols['å°šæœª'], 'kb-todo');
            draw(cols['å®Œæˆ'], 'kb-done');
        }

        function getTagColor(s) {
            if(s==='è£½ä½œä¸­') return 'tag-blue';
            if(s.includes('å¯©')) return 'tag-orange';
            if(s.includes('å®Œæˆ')) return 'tag-green';
            return 'tag-gray';
        }

        function calcProgress(p) {
            if(!p.start || !p.end) return 0;
            if(p.status.includes('å®Œæˆ')) return 100;
            const total = new Date(p.end) - new Date(p.start);
            const now = new Date() - new Date(p.start);
            if(now < 0) return 0;
            const pct = (now / total) * 100;
            return pct > 100 ? 100 : pct;
        }

        // --- ç”˜ç‰¹åœ– ---
        function renderGantt() {
            const box = document.getElementById('gantt-chart');
            const y = curDate.getFullYear(), m = curDate.getMonth();
            document.getElementById('gan-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            
            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m+1, 0);
            const days = lastDay.getDate();
            
            let html = `<table class="gantt-table"><thead><tr><th class="gantt-header-cell sticky left-0 bg-white z-10 w-24">å°ˆæ¡ˆ</th>`;
            for(let i=1; i<=days; i++) {
                const isToday = (new Date().getDate() === i && new Date().getMonth() === m);
                html += `<th class="gantt-header-cell ${isToday?'gantt-today':''}">${i}</th>`;
            }
            html += `</tr></thead><tbody>`;

            // é¡¯ç¤ºå…¨éƒ¨å°ˆæ¡ˆ
            DATA.projects.forEach(p => {
                if(!p.start || !p.end) return;
                const s = new Date(p.start), e = new Date(p.end);
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬æœˆç¯„åœ
                if(e < firstDay || s > lastDay) return;

                html += `<tr><td class="sticky left-0 bg-white z-10 border-b border-gray-50 py-2 px-1 text-xs font-bold truncate max-w-[100px]">${p.client}<br><span class="font-normal text-gray-400">${p.name}</span></td><td colspan="${days}" class="relative h-10 border-b border-gray-50">`;
                
                // è¨ˆç®— Bar ä½ç½®
                let startDay = s < firstDay ? 1 : s.getDate();
                let endDay = e > lastDay ? days : e.getDate();
                let left = (startDay - 1) * (100/days);
                let width = (endDay - startDay + 1) * (100/days);
                
                let bg = '#8E8E93';
                if(p.status === 'è£½ä½œä¸­') bg = '#007AFF';
                if(p.status.includes('å¯©')) bg = '#FF9500';
                if(p.status.includes('å®Œæˆ')) bg = '#34C759';

                html += `<div class="gantt-bar" style="left:${left}%; width:${width}%; background:${bg};">${p.producer[0]}</div>`;
                html += `</td></tr>`;
            });
            html += `</tbody></table>`;
            box.innerHTML = html;
        }

        function changeMonth(d) {
            curDate.setMonth(curDate.getMonth() + d);
            renderGantt();
        }

        // --- è¡Œäº‹æ›† ---
        function renderCalendar() {
            const el = document.getElementById('calendar');
            const events = DATA.projects.map(p => ({
                title: p.name,
                start: p.start,
                end: new Date(new Date(p.end).getTime() + 86400000).toISOString().slice(0,10),
                color: p.status==='è£½ä½œä¸­'?'#007AFF':(p.status.includes('å¯©')?'#FF9500':'#8E8E93')
            }));
            const cal = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                events: events,
                headerToolbar: { left: 'prev,next', center: 'title', right: 'dayGridMonth' },
                height: 600
            });
            cal.render();
        }

        // --- æ“ä½œèˆ‡ Modal ---
        function openEdit(id, zone) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if(!p) return;
            document.getElementById('e-oid').value = p.id;
            document.getElementById('e-ozone').value = p.zone;
            document.getElementById('e-code').value = p.zone.split('_')[0];
            updateEditClient();
            document.getElementById('e-num').value = p.id.replace(/\D/g,'');
            document.getElementById('e-name').value = p.name;
            document.getElementById('e-prod').value = p.producer;
            document.getElementById('e-type').value = p.type;
            if(p.start) fpEdit.setDate([p.start, p.end]);
            document.getElementById('modal-edit').style.display = 'flex';
        }

        function updateEditClient() {
            const code = document.getElementById('e-code').value;
            // ç°¡å–®æŸ¥æ‰¾å°æ‡‰åç¨± (éœ€å¾Œç«¯ Config æ”¯æ´ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
            document.getElementById('e-client').value = "å®¢æˆ¶ " + code; 
        }

        function saveEdit() {
            const p = {
                category: curCat,
                originId: document.getElementById('e-oid').value,
                originZone: document.getElementById('e-ozone').value,
                zone: document.getElementById('e-code').value + "_" + document.getElementById('e-client').value,
                id: document.getElementById('e-code').value + document.getElementById('e-num').value,
                name: document.getElementById('e-name').value,
                producer: document.getElementById('e-prod').value,
                type: document.getElementById('e-type').value,
                client: document.getElementById('e-client').value
            };
            const dates = document.getElementById('e-date').value.split(' to ');
            if(dates[0]) { p.start = dates[0]; p.end = dates[1] || dates[0]; }
            
            // Update Local
            const idx = DATA.projects.findIndex(x => x.id === p.originId && x.zone === p.originZone);
            if(idx !== -1) { DATA.projects[idx] = {...DATA.projects[idx], ...p}; }
            localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
            document.getElementById('modal-edit').style.display = 'none';
            renderAll(DATA);
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'updateProject', payload:p, originId:p.originId, originZone:p.originZone}) });
        }

        function openAction(id, zone) {
            document.getElementById('a-id').value = id;
            document.getElementById('a-zone').value = zone;
            document.getElementById('modal-action').style.display = 'flex';
        }

        function doAction(status) {
            const id = document.getElementById('a-id').value;
            const zone = document.getElementById('a-zone').value;
            const hrs = document.getElementById('a-hours').value;
            
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if(p) { p.status = status; if(hrs) p.hours = (Number(p.hours)||0) + Number(hrs); }
            
            localStorage.setItem('JAYRAN_CACHE', JSON.stringify(DATA));
            document.getElementById('modal-action').style.display = 'none';
            renderAll(DATA);
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'updateStatus', cat:curCat, zone:zone, id:id, status:status, hours:hrs}) });
        }

        // --- å·¥å…· ---
        function switchTab(t) {
            curTab = t;
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+t).classList.add('active');
            ['p-add', 'p-kanban', 'p-gantt', 'p-calendar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if(t==='add') document.getElementById('p-add').classList.remove('hidden');
            else if(t==='gan') { document.getElementById('p-gantt').classList.remove('hidden'); renderGantt(); }
            else if(t==='calendar') { document.getElementById('p-calendar').classList.remove('hidden'); setTimeout(renderCalendar, 100); }
            else { document.getElementById('p-kanban').classList.remove('hidden'); renderKanban(t==='wei'?'é­æ•è»’':'é‚±ä»æ°'); }
        }

        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
        function openZoneModal() { document.getElementById('modal-zone').style.display = 'flex'; }
        function togglePanel(id) { /* ä¿ç•™åŸæœ¬é‚è¼¯æˆ–ç°¡åŒ– */ }
    </script>
</body>
</html>
