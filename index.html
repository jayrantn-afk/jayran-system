<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°å†‰å½±åƒå·¥ä½œå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="icon" href="https://drive.google.com/uc?export=view&id=1PA3de57c2FhIo86zRGzXB2e-LTmvVnt5">
    
    <style>
        :root { --bg: #F5F5F7; --surface: #FFFFFF; --primary: #1D1D1F; --secondary: #86868B; --accent: #007AFF; --radius: 12px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--primary); padding-bottom: 60px; }
        
        .segmented-nav { background: #E8E8ED; padding: 4px; border-radius: 10px; display: flex; margin-bottom: 24px; flex-wrap: wrap; }
        .nav-item { flex: 1; min-width: 80px; text-align: center; padding: 10px; font-size: 14px; font-weight: 700; color: var(--secondary); cursor: pointer; border-radius: 7px; transition: all 0.2s; white-space: nowrap; }
        .nav-item.active { background: var(--surface); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .clean-card { background: var(--surface); border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .clean-input, .clean-select { width: 100%; padding: 12px; background: #F5F5F7; border: 1px solid transparent; border-radius: 8px; font-size: 15px; font-weight: 500; transition: 0.2s; }
        .clean-input:focus, .clean-select:focus { background: var(--surface); border-color: var(--accent); outline: none; }
        
        .type-switch { display: flex; margin-bottom: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #E5E5E5; }
        .type-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 700; color: #86868B; background: #FAFAFA; transition: 0.2s; }
        .type-btn.active { background: #1D1D1F; color: white; }
        
        .icon-btn { width: 44px; height: 44px; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-black { background: #1D1D1F; color: white; }
        .btn-gray { background: #F2F2F7; color: #1D1D1F; }

        .kanban-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .kanban-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .kanban-item { background: white; border: 1px solid #E5E5E5; border-radius: 12px; padding: 16px 16px 16px 20px; position: relative; border-left: 5px solid #007AFF; transition: 0.2s; padding-top: 40px; }
        .kanban-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .k-blue { border-left-color: #007AFF; } .k-orange { border-left-color: #FF9500; } .k-green { border-left-color: #34C759; } .k-gray { border-left-color: #8E8E93; }
        .k-red { border-left-color: #ff3b30 !important; border: 1px solid #ffcccc; background: #fff5f5; }
        
        .k-header-badges { position: absolute; top: 12px; left: 12px; display: flex; gap: 6px; z-index: 2; }
        .k-status-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; color: white; }
        .k-tag-urgent { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; color: white; background: #ff3b30; }
        
        .k-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 20; }
        .k-action-btn { width: 28px; height: 28px; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #999; transition: 0.2s; background: #f5f5f7; z-index: 30; }
        .k-action-btn:hover { background: #e5e5e5; color: #333; }
        .k-del:hover { background: #fee2e2; color: #ef4444; }

        .k-id { font-size: 13px; font-weight: 700; color: #86868B; margin-top: 0px; margin-bottom: 2px; }
        .k-name { font-size: 18px; font-weight: 800; color: #1D1D1F; margin-bottom: 4px; padding-right: 0px; line-height: 1.3; }
        .k-client { font-size: 13px; color: #666; margin-bottom: 8px; }
        .k-date { font-size: 12px; color: #888; font-weight: 600; display: flex; align-items: center; gap: 4px; }

        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary i.fa-caret-right {
            transition: transform 0.2s ease;
            display: inline-block;
            width: 20px;
            text-align: center;
        }
        details[open] > summary i.fa-caret-right { transform: rotate(90deg); }

        .gantt-wrapper { overflow-x: auto; background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); width: 100%; -webkit-overflow-scrolling: touch; }
        .gantt-table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; }
        .gantt-header-cell { text-align: center; font-size: 10px; color: #888; border-right: 1px solid #f0f0f0; padding: 8px 0; width: 28px; }
        .gantt-today { background-color: #FFF9C4; color: #000; font-weight: 900; border-bottom: 3px solid #FFD700; }
        .gantt-today-cell { background-color: #FFF9C4; } 
        .gantt-row { height: 40px; border-bottom: 1px solid #f9f9f9; }
        .gantt-label-cell { width: 220px; padding-right: 10px; background: white; z-index: 10; position: sticky; left: 0; border-right: 2px solid #eee; padding-left: 10px; white-space: nowrap; overflow: hidden; }
        .gantt-id { font-weight: 900; font-size: 12px; color: #333; margin-right: 6px; }
        .gantt-name { font-size: 12px; color: #444; font-weight: 500; }
        .gantt-grid-cell { border-right: 1px solid #f5f5f5; position: relative; padding: 0; }
        .gantt-bar { position: absolute; top: 10px; left: 1px; right: 1px; height: 20px; border-radius: 4px; background: #007AFF; color: white; font-size: 10px; line-height: 20px; padding: 0 5px; white-space: nowrap; overflow: hidden; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .gan-btn { background: #E5E7EB; color: #1F2937; transition: all 0.2s; }
        .gan-btn.active { background: #1D1D1F; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .gan-btn:hover:not(.active) { opacity: 0.8; }

        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-body { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; margin: 20px; }
        .hidden { display: none; }
        
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 999; }
        .fab-btn { width: 60px; height: 60px; background: #1D1D1F; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; position: relative; }
        .fab-btn:hover { transform: scale(1.1); }
        .fab-btn.fab-link { background: #2D3748; } 
        .badge { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: bold; display: none; }
        
        .fab-left-container { position: fixed; bottom: 30px; left: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 999; }
        .fab-btn-small { width: 40px; height: 40px; font-size: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; }
        .fab-btn-small:hover { transform: scale(1.1); }

        .float-panel { position: fixed; bottom: 30px; right: 100px; width: 350px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 998; display: none; border: 1px solid #eee; flex-direction: column; max-height: 70vh; padding: 0; overflow: hidden; }
        @media (max-width: 600px) { .float-panel { right: 20px; left: 20px; width: auto; bottom: 100px; } }
        .panel-header-area { padding: 25px 25px 0 25px; flex-shrink: 0; background: white; }
        .panel-scroll-area { padding: 0 25px 25px 25px; overflow-y: auto; flex-grow: 1; }

        .memo-item, .pending-item { background: #FFF9C4; padding: 15px; border-radius: 10px; margin-bottom: 12px; position: relative; border-left: 6px solid #FFD700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .memo-item.chiu { background: #E3F2FD; border-left-color: #2196F3; } 
        .pending-item { background: #f3f4f6; border-left: 6px solid #9CA3AF; }
        
        .memo-content, .pending-name { font-weight: 800; color: #333; margin-bottom: 8px; font-size: 20px; line-height: 1.4; }
        .memo-meta, .pending-meta { font-size: 14px; color: #666; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .memo-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .memo-icon { font-size: 16px; color: #aaa; cursor: pointer; padding: 2px; }
        .memo-icon:hover { color: #555; }
        .memo-del:hover { color: #ff3b30; }
        .memo-input { background: white; border: 2px solid #ddd; color: #333; }
        .memo-input:focus { border-color: #1D1D1F; }

        .link-item { background: #2D3748; color: white; padding: 12px 16px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; transition: 0.2s; position: relative; }
        .link-item:hover { transform: translateX(5px); background: #1A202C; }
        .link-actions { display: flex; gap: 10px; margin-left: 10px; }
        .link-icon { color: #A0AEC0; font-size: 16px; cursor: pointer; padding: 5px; }
        .link-icon:hover { color: white; }
        .link-del:hover { color: #ff3b30; }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .setting-actions i { cursor: pointer; padding: 5px; margin-left: 5px; color: #999; }
        .setting-actions i:hover { color: #333; }

        #calendar-container { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); min-height: 600px; }
        .fc-theme-standard td, .fc-theme-standard th { border: none !important; border-bottom: 1px solid #f5f5f7 !important; }
        .fc-col-header-cell-cushion { color: #888; font-weight: 700; padding: 10px 0 !important; }
        .fc-daygrid-day-number { color: #333; font-weight: 700; padding: 8px !important; text-decoration: none !important; }
        .fc-day-today { background-color: transparent !important; }
        .fc-day-today .fc-daygrid-day-frame { box-shadow: inset 0 0 0 3px #1D1D1F !important; border-radius: 8px; }
        .fc-day-today .fc-daygrid-day-number { color: #1D1D1F !important; background-color: transparent !important; font-weight: 900 !important; }
        .fc-event { border: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; cursor: pointer; margin-bottom: 3px !important; border-radius: 6px !important; }
        .fc-event-main { padding: 4px 8px; font-weight: 600; font-size: 11px; color: white !important; display: flex; align-items: center; gap: 4px; }
        .fc-toolbar-title { font-weight: 900 !important; font-size: 1.5rem !important; }
        .fc-button { background-color: #E5E7EB !important; color: #1F2937 !important; border: none !important; border-radius: 8px !important; font-weight: bold !important; text-transform: capitalize; transition: 0.2s; }
        .fc-button:hover { background-color: #d1d5db !important; }
        .fc-button-active { background-color: #1D1D1F !important; color: white !important; }
        .cal-filter-btn { padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: 0.2s; background: #E5E7EB; color: #666; }
        .cal-filter-btn.active { background: #1D1D1F; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="loader" class="fixed top-0 left-0 w-full h-full bg-[#F5F5F7] flex flex-col justify-center items-center z-[999]">
        <div class="text-2xl font-black tracking-widest animate-pulse">JAYRAN STUDIO</div>
        <div id="loader-msg" class="mt-4 text-gray-500 font-bold">è³‡æ–™è®€å–ä¸­...</div>
    </div>

    <div class="fab-container">
        <div onclick="togglePanel('link')" class="fab-btn fab-link" title="å®¢æˆ¶é€£çµåº«"><i class="fas fa-link"></i></div>
        <div onclick="togglePanel('pending')" class="fab-btn" title="å¾…åˆ†æ´¾å°ˆæ¡ˆ" style="background:#4B5563;">
            <i class="fas fa-user-clock"></i>
            <span id="pending-badge" class="badge">0</span>
        </div>
        <div onclick="togglePanel('memo')" class="fab-btn" title="åœ˜éšŠä¾¿åˆ©è²¼">
            <i class="fas fa-paste"></i>
            <span id="memo-badge" class="badge">0</span>
        </div>
    </div>

    <div class="fab-left-container">
        <div onclick="window.open('https://script.google.com/macros/s/AKfycbzpYIM8Pw-ASL_M_cVIJl-H_AXMZWcADv6qmxmo7cvxidEib74mXmP_sQJatY1MM30R0g/exec', '_blank')" class="fab-btn-small bg-white text-gray-800" title="å‰å¾€å¿ƒæ™ºåœ–ç³»çµ±">
            <i class="fas fa-project-diagram"></i>
        </div>
    </div>
    
    <div id="panel-memo" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">ğŸ“ åœ˜éšŠä¾¿åˆ©è²¼</h3>
                <span onclick="togglePanel('memo')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
            <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <input id="m-content" class="w-full memo-input text-lg font-bold mb-3 outline-none p-3 rounded-lg" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …...">
                <div class="flex gap-3 mb-3">
                    <select id="m-owner" class="text-base p-2 rounded bg-white border border-gray-300 font-bold"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select>
                    <input id="m-date" class="text-base p-2 rounded bg-white border border-gray-300 w-48 text-center font-bold" placeholder="èµ·è¨–æ—¥æœŸ">
                </div>
                <button id="btn-memo-add" onclick="addMemoItem()" class="w-full bg-black text-white text-base py-3 rounded-lg font-bold hover:bg-gray-800">æ–°å¢è²¼æ–‡</button>
            </div>
        </div>
        <div id="memo-list" class="panel-scroll-area">
            <div class="text-center text-gray-400 text-sm py-4">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="panel-pending" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">ğŸ‘¤ å¾…åˆ†æ´¾å°ˆæ¡ˆ</h3>
                <span onclick="togglePanel('pending')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
        </div>
        <div id="pending-list" class="panel-scroll-area">
            <div class="text-center text-gray-400 text-sm py-4">ç›®å‰æ²’æœ‰å¾…åˆ†æ´¾é …ç›®</div>
        </div>
    </div>

    <div id="panel-link" class="float-panel">
        <div class="panel-header-area">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl">ğŸ”— å®¢æˆ¶é€£çµåº«</h3>
                <span onclick="togglePanel('link')" class="cursor-pointer text-gray-400 hover:text-black text-xl"><i class="fas fa-times"></i></span>
            </div>
            <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <input id="l-client" class="w-full memo-input text-lg font-bold mb-3 outline-none p-3 rounded-lg" placeholder="å®¢æˆ¶åç¨± (å¦‚: å°ç©é›»)">
                <input id="l-url" class="w-full memo-input text-base font-bold mb-3 outline-none p-3 rounded-lg" placeholder="è²¼ä¸Šç¶²å€ (https://...)">
                <button id="btn-link-add" onclick="addLinkItem()" class="w-full bg-blue-600 text-white text-base py-3 rounded-lg font-bold hover:bg-blue-800">æ–°å¢é€£çµ</button>
            </div>
        </div>
        <div id="link-list" class="panel-scroll-area">
            <div class="text-center text-gray-400 text-sm py-4">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="modal-preview" class="modal-mask"><div class="modal-body">
        <h3 class="text-lg font-black mb-2">å°ˆæ¡ˆæ­·å²ç´€éŒ„</h3>
        <p id="hist-title" class="text-sm text-gray-500 mb-4"></p>
        <div id="hist-list" class="mb-4 max-h-60 overflow-y-auto">è¼‰å…¥ä¸­...</div>
        <button onclick="closeModal('preview')" class="w-full bg-gray-200 py-3 rounded-lg font-bold">é—œé–‰</button>
    </div></div>

    <div id="modal-zone" class="modal-mask"><div class="modal-body">
        <h3 id="modal-title" class="text-lg font-black mb-4">å€åŸŸè¨­å®š</h3>
        <input type="hidden" id="edit-orig-name">
        <div class="mb-4" id="div-code-select">
            <label class="block text-xs font-bold text-gray-500 mb-1">ä»£è™Ÿ</label>
            <select id="modal-code" class="clean-select font-mono"></select>
        </div>
        <label class="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ¶åç¨±</label>
        <input id="modal-name" class="clean-input mb-6" placeholder="ä¾‹å¦‚ï¼šå°ç©é›»">
        <div class="flex gap-2">
            <button onclick="closeModal('zone')" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmZoneModal()" class="flex-1 bg-black text-white py-2 rounded-lg font-bold">ç¢ºèª</button>
        </div>
    </div></div>
    
    <div id="modal-leave" class="modal-mask"><div class="modal-body">
        <h3 class="text-lg font-black mb-4">è«‹å‡ç”³è«‹</h3>
        <div class="mb-3"><label class="block text-xs font-bold text-gray-500 mb-1">è«‹å‡äºº</label><select id="leave-name" class="clean-select font-bold"><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select></div>
        <div class="mb-3"><label class="block text-xs font-bold text-gray-500 mb-1">è«‹å‡æ™‚é–“</label><input id="leave-date" class="clean-input text-center" placeholder="é¸æ“‡æ—¥æœŸç¯„åœ"></div>
        <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1">äº‹ç”±</label><input id="leave-reason" class="clean-input" placeholder="ä¾‹å¦‚ï¼šå‡ºåœ‹ã€ç”Ÿç—…"></div>
        <div class="flex gap-2">
            <button onclick="closeModal('leave')" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmLeave()" class="flex-1 bg-black text-white py-2 rounded-lg font-bold">é€å‡º</button>
        </div>
    </div></div>

    <div id="modal-edit-project" class="modal-mask"><div class="modal-body w-[400px]">
        <h3 class="text-xl font-black mb-4">ç·¨è¼¯å°ˆæ¡ˆå…§å®¹</h3>
        <input type="hidden" id="ep-cat">
        <input type="hidden" id="ep-zone">
        <input type="hidden" id="ep-origin-id">
        <input type="hidden" id="ep-origin-zone"> 
        <div class="grid grid-cols-4 gap-2 mb-3 items-end">
            <div><label class="text-xs text-gray-500 font-bold block mb-1">ä»£è™Ÿ</label><select id="ep-code" class="clean-select font-bold text-center px-1" onchange="updateEditClientInfo()"></select></div>
            <div class="col-span-2"><label class="text-xs text-gray-500 font-bold block mb-1">å®¢æˆ¶ (å¯ç·¨è¼¯)</label><input id="ep-client-display" class="clean-input bg-white text-black font-bold text-sm"></div>
            <div><label class="text-xs text-gray-500 font-bold block mb-1">æ•¸å­—</label><input id="ep-num" class="clean-input font-bold text-center px-1" placeholder="001"></div>
        </div>
        <div class="mb-3"><label class="text-xs text-gray-500 font-bold">è£½ä½œäºº</label><select id="ep-producer" class="clean-select font-bold"></select></div>
        <div class="mb-3"><label class="text-xs text-gray-500 font-bold">å°ˆæ¡ˆåç¨±</label><input id="ep-name" class="clean-input font-bold"></div>
        <div class="grid grid-cols-2 gap-3 mb-3">
             <div><label class="text-xs text-gray-500 font-bold">é¡å‹</label><select id="ep-type" class="clean-select"></select></div>
             <div><label class="text-xs text-gray-500 font-bold">æ—¥æœŸç¯„åœ</label><input id="ep-date" class="clean-input text-center text-xs"></div>
        </div>
        <div class="mb-3"><label class="text-xs text-gray-500 font-bold">å·¥æ™‚ (å°æ™‚)</label><input id="ep-hours" type="number" step="0.5" class="clean-input font-bold" placeholder="0"></div>
        <div class="mb-3"><label class="text-xs text-gray-500 font-bold">å‚™è¨»</label><textarea id="ep-note" class="clean-input h-16 text-sm"></textarea></div>
        <div class="flex items-center gap-2 mb-6">
            <input type="checkbox" id="ep-urgent" class="w-4 h-4 text-red-600">
            <label for="ep-urgent" class="text-sm font-bold text-red-600">æ€¥ä»¶</label>
        </div>
        <div class="flex gap-2">
            <button onclick="closeModal('edit-project')" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmEditProject()" class="flex-1 bg-black text-white py-3 rounded-lg font-bold">å„²å­˜è®Šæ›´</button>
        </div>
    </div></div>

    <div id="modal-hours" class="modal-mask"><div class="modal-body">
        <h3 class="text-lg font-black mb-2">é€å‡ºå¯©æ ¸</h3>
        <p class="text-sm text-gray-500 mb-4">æœ¬æ¬¡èŠ±è²»å·¥æ™‚ (hr)</p>
        <input type="hidden" id="hours-zone"><input type="hidden" id="hours-id"><input type="hidden" id="hours-cat">
        <input id="input-hours" type="number" step="0.5" class="clean-input mb-6 text-center font-bold text-xl" placeholder="1.5">
        <div class="flex gap-2">
            <button onclick="closeModal('hours')" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmSendReview()" class="flex-1 bg-black text-white py-2 rounded-lg font-bold">é€å‡º</button>
        </div>
    </div></div>

    <div id="modal-settings" class="modal-mask"><div class="modal-body w-[350px]">
        <h3 id="setting-title" class="text-xl font-black mb-4">ç®¡ç†é¸å–®</h3>
        <input type="hidden" id="st-type"> 
        <div class="flex gap-2 mb-4">
            <input id="st-input" class="clean-input flex-1" placeholder="è¼¸å…¥æ–°é¸é …...">
            <button onclick="addSettingItem()" class="bg-black text-white px-4 rounded-lg font-bold">æ–°å¢</button>
        </div>
        <div id="st-list" class="max-h-60 overflow-y-auto border-t border-gray-100"></div>
        <button onclick="closeModal('settings')" class="w-full bg-gray-200 py-3 rounded-lg font-bold mt-4">é—œé–‰</button>
    </div></div>

    <div class="max-w-5xl mx-auto px-4 py-8">
        <div class="mb-6 px-1 flex items-center gap-3">
            <h1 class="text-2xl font-black text-black">æ°å†‰å½±åƒå·¥ä½œå®¤</h1>
        </div>
        
        <div class="segmented-nav">
            <div onclick="switchTab('add')" id="nav-add" class="nav-item active" title="é»æ“Šåˆ·æ–°"><i class="fas fa-plus mr-2"></i> æ–°å¢</div>
            <div onclick="switchTab('wei')" id="nav-wei" class="nav-item" title="é»æ“Šåˆ·æ–°"><i class="fas fa-user mr-2"></i> é­æ•è»’</div>
            <div onclick="switchTab('chiu')" id="nav-chiu" class="nav-item" title="é»æ“Šåˆ·æ–°"><i class="fas fa-user mr-2"></i> é‚±ä»æ°</div>
            <div onclick="switchTab('gan')" id="nav-gan" class="nav-item" title="é»æ“Šåˆ·æ–°"><i class="fas fa-chart-bar mr-2"></i> ç”˜ç‰¹åœ–</div>
            <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-item" title="é»æ“Šåˆ·æ–°"><i class="fas fa-calendar-alt mr-2"></i> è¡Œäº‹æ›†</div>
        </div>

        <div id="p-add" class="clean-card">
            <div class="type-switch">
                <div onclick="setProjectType('video')" id="btn-type-video" class="type-btn active">ğŸ¬ å‰ªè¼¯å°ˆæ¡ˆ</div>
                <div onclick="setProjectType('image')" id="btn-type-image" class="type-btn">ğŸ¨ åœ–æ–‡å°ˆæ¡ˆ</div>
            </div>

            <h2 class="text-xl font-bold mb-4">å»ºç«‹æ–°å°ˆæ¡ˆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å€åŸŸ / å®¢æˆ¶</label>
                    <div class="flex gap-2">
                        <select id="i-zone" onchange="updateClientName()" class="clean-select font-bold flex-grow"></select>
                        <div onclick="openHistory()" class="icon-btn btn-gray" title="é è¦½"><i class="fas fa-eye"></i></div>
                        <div onclick="openZoneModal('new')" class="icon-btn btn-black" title="æ–°å¢"><i class="fas fa-plus"></i></div>
                        <div onclick="openZoneModal('edit')" class="icon-btn btn-gray" title="ç·¨è¼¯"><i class="fas fa-pen"></i></div>
                    </div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ç·¨è™Ÿ</label><input id="i-id" class="clean-input font-mono font-bold" placeholder=""></div>
            </div>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ¶åç¨± (é¡¯ç¤ºç”¨)</label><input id="i-client" class="clean-input bg-gray-100 text-black font-bold"></div>
            <div class="mb-4"><label id="lbl-name" class="block text-xs font-bold text-gray-500 mb-1">å°ˆæ¡ˆåç¨±</label><input id="i-name" class="clean-input" placeholder="è¼¸å…¥æ¨™é¡Œ"></div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">è£½ä½œäºº</label>
                    <div class="flex gap-1">
                        <select id="i-producer" class="clean-select" onchange="checkProducer()"></select>
                        <div onclick="openSettings('Producer')" class="icon-btn btn-gray w-10 h-[46px]" title="ç®¡ç†è£½ä½œäºº"><i class="fas fa-cog"></i></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label>
                    <div class="flex gap-1">
                        <select id="i-type" class="clean-select"></select>
                        <div onclick="openSettings('Type')" class="icon-btn btn-gray w-10 h-[46px]" title="ç®¡ç†é¡å‹"><i class="fas fa-cog"></i></div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 flex items-center gap-2">
                <input type="checkbox" id="i-urgent" class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                <label for="i-urgent" class="text-base font-bold text-red-600">ğŸ”¥ æ¨™è¨˜ç‚ºæ€¥ä»¶</label>
            </div>

            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸç¯„åœ</label><input id="i-date" class="clean-input text-center" placeholder="é»æ“Šé¸æ“‡"></div>
            <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨»</label><textarea id="i-note" class="clean-input h-20"></textarea></div>
            <button onclick="saveProject()" id="btn-create" class="w-full bg-black text-white py-3 rounded-lg font-bold shadow-md hover:bg-gray-800 transition">å»ºç«‹ä¸¦åŒæ­¥</button>
        </div>

        <div id="p-kanban" class="hidden">
            <h2 id="kb-title" class="text-2xl font-black mb-6 px-2"></h2>
            
            <div class="mb-8">
                <h3 class="text-lg font-bold text-blue-600 mb-3 px-2">ğŸ”¥ è£½ä½œä¸­</h3>
                <div id="kb-process" class="kanban-grid"></div>
            </div>
            
            <details class="mb-6 group">
                <summary class="text-lg font-bold text-orange-500 mb-3 px-2 cursor-pointer list-none flex items-center gap-2 outline-none select-none hover:opacity-80">
                    <i class="fas fa-caret-right transition-transform duration-200 group-open:rotate-90"></i>
                    <span>ğŸ‘€ å¯©æ ¸ä¸­</span>
                </summary>
                <div id="kb-review" class="kanban-grid pl-2"></div>
            </details>
            
            <details class="mb-4 group">
                <summary class="text-lg font-bold text-gray-500 mb-3 px-2 cursor-pointer list-none flex items-center gap-2 outline-none select-none hover:text-gray-700">
                    <i class="fas fa-caret-right transition-transform duration-200 group-open:rotate-90"></i>
                    <span>â³ å°šæœªé€²è¡Œ</span>
                </summary>
                <div id="kb-todo" class="kanban-grid pl-2"></div>
            </details>
            
            <details class="mb-4 group">
                <summary class="text-lg font-bold text-gray-500 mb-3 px-2 cursor-pointer list-none flex items-center gap-2 outline-none select-none hover:text-gray-700">
                    <i class="fas fa-caret-right transition-transform duration-200 group-open:rotate-90"></i>
                    <span>âœ… å·²å®Œæˆ</span>
                </summary>
                <div id="kb-done" class="kanban-grid pl-2"></div>
            </details>
        </div>

        <div id="p-gantt" class="hidden">
            <h2 id="gan-title" class="text-2xl font-black mb-6 px-2">ç”˜ç‰¹åœ–</h2>
            <div class="flex gap-2 mb-4 px-2 items-center">
                <button id="btn-gan-wei" onclick="renderGantt('é­æ•è»’')" class="gan-btn px-4 py-2 rounded-lg font-bold">é­æ•è»’</button>
                <button id="btn-gan-chiu" onclick="renderGantt('é‚±ä»æ°')" class="gan-btn px-4 py-2 rounded-lg font-bold">é‚±ä»æ°</button>
                
                <div class="flex-1"></div>
                <button class="icon-btn btn-gray" onclick="changeGanttMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="icon-btn btn-gray" onclick="changeGanttMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="p-calendar" class="hidden">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-2xl font-black">è¡Œäº‹æ›†</h2>
                <button onclick="openLeaveModal()" class="bg-black text-white px-3 py-1 rounded-lg text-sm font-bold"><i class="fas fa-coffee mr-1"></i> è«‹å‡</button>
            </div>
            <div class="flex gap-2 mb-4 px-2">
                <button id="btn-cal-all" onclick="filterCalendar('all')" class="cal-filter-btn active">å…¨éƒ¨</button>
                <button id="btn-cal-wei" onclick="filterCalendar('é­æ•è»’')" class="cal-filter-btn">é­æ•è»’</button>
                <button id="btn-cal-chiu" onclick="filterCalendar('é‚±ä»æ°')" class="cal-filter-btn">é‚±ä»æ°</button>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxEK4TafDLSKqfn3QuJk2bwNpnWcPMcOoNt6nVmz2w4geyMoRL4Bx_ILVIAtBbGhVCV/exec'; 

        let DATA = { ids: {}, videoSettings: {}, imageSettings: {}, projects: [], usedCodesVideo: [], usedCodesImage: [], config: {}, leaves: [] };
        let curTab = 'add';
        let curCat = 'video';
        let modalMode = 'new';
        let calendar = null; 
        let calendarFilter = 'all'; 
        let currentGanttDate = new Date(); 
        let editingMemoIdx = null;
        let editingLinkIdx = null;

        const fp = flatpickr("#i-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpMemo = flatpickr("#m-date", { mode: "range", dateFormat: "Y-m-d" });
        const fpEdit = flatpickr("#ep-date", { mode: "range", dateFormat: "Y-m-d" }); 
        const fpLeave = flatpickr("#leave-date", { mode: "range", dateFormat: "Y-m-d" }); 

        function callAPI(action, payload, onSuccess) {
            if (GAS_API_URL) {
                if (['initAllData', 'getHistory', 'getLeaves', 'getMemos', 'getLinks'].includes(action)) {
                    let params = `?action=${action}`;
                    if(payload.cat) params += `&cat=${payload.cat}`;
                    if(payload.zone) params += `&zone=${payload.zone}`;
                    
                    fetch(GAS_API_URL + params)
                    .then(res => res.json())
                    .then(data => onSuccess(data))
                    .catch(e => console.error("API Error:", e));
                } else {
                    const postData = { action: action, ...payload };
                    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(postData) })
                    .then(res => res.json())
                    .then(data => onSuccess(data.data))
                    .catch(e => { alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); document.getElementById('loader').style.display = 'none'; });
                }
            } else {
                const handler = google.script.run.withSuccessHandler(onSuccess);
                if (action === 'initAllData') handler.initAllData();
            }
        }

        window.onload = function() {
            const cachedData = localStorage.getItem('JAYRAN_SYSTEM_DATA');
            if (cachedData) {
                try {
                    const parsedData = JSON.parse(cachedData);
                    processDataUpdate(parsedData, true); 
                    document.getElementById('loader-msg').innerText = "èƒŒæ™¯åŒæ­¥æœ€æ–°è³‡æ–™ä¸­...";
                } catch(e) { console.error("Cache Parse Error", e); }
            }

            callAPI('initAllData', {}, (res) => {
                if(res.error) {
                    document.getElementById('loader-msg').innerHTML = `<span class="text-red-500">${res.error}</span>`;
                } else {
                    localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(res));
                    processDataUpdate(res, false);
                }
            });
        };

        function processDataUpdate(res, isCache) {
            DATA = res;
            renderZoneOptions();
            loadMemos();
            loadLinks();
            loadPending();
            
            if (curTab === 'wei') renderKanban('é­æ•è»’');
            else if (curTab === 'chiu') renderKanban('é‚±ä»æ°');
            else if (curTab === 'gan') {
                if(document.getElementById('btn-gan-wei').classList.contains('active')) renderGantt('é­æ•è»’');
                else renderGantt('é‚±ä»æ°');
            }
            else if (curTab === 'calendar') {
                renderCalendar();
            }

            if (!isCache) {
                document.getElementById('loader').style.display = 'none';
                setProjectType('video'); 
            } else {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function setProjectType(type) {
            curCat = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-type-' + type).classList.add('active');
            document.getElementById('i-name').placeholder = (type === 'video') ? "è¼¸å…¥å½±ç‰‡æ¨™é¡Œ" : "è¼¸å…¥åœ–æ–‡æ¨™é¡Œ";
            document.getElementById('lbl-name').innerText = (type === 'video') ? "å½±ç‰‡åç¨±" : "åœ–æ–‡åç¨±";
            document.getElementById('i-id').placeholder = "å»ºè­°ç·¨è™Ÿ: 001";
            renderZoneOptions();
            renderDynamicOptions();
        }

        function renderDynamicOptions() {
            if (!DATA.config) return;
            const types = (curCat === 'video') ? DATA.config.videoTypes : DATA.config.imageTypes;
            const producers = (curCat === 'video') ? DATA.config.videoProducers : DATA.config.imageProducers;
            const fillSelect = (id, list) => {
                const el = document.getElementById(id);
                if(el && list) {
                    const currentVal = el.value;
                    el.innerHTML = '';
                    list.forEach(item => el.add(new Option(item, item)));
                    if(list.includes(currentVal)) el.value = currentVal;
                }
            };
            fillSelect('i-type', types);
            fillSelect('i-producer', producers);
            fillSelect('ep-type', types);
            fillSelect('ep-producer', producers);
        }

        function switchTab(tab) {
            curTab = tab;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            ['p-add', 'p-kanban', 'p-gantt', 'p-calendar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (tab === 'add') document.getElementById('p-add').classList.remove('hidden');
            else if (tab === 'wei') { document.getElementById('p-kanban').classList.remove('hidden'); renderKanban('é­æ•è»’'); }
            else if (tab === 'chiu') { document.getElementById('p-kanban').classList.remove('hidden'); renderKanban('é‚±ä»æ°'); }
            else if (tab === 'gan') { document.getElementById('p-gantt').classList.remove('hidden'); renderGantt('é­æ•è»’'); }
            else if (tab === 'calendar') { 
                document.getElementById('p-calendar').classList.remove('hidden'); 
                setTimeout(() => renderCalendar(), 100); 
            }
        }

        function renderZoneOptions() {
            const sel = document.getElementById('i-zone'); 
            sel.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            const settings = (curCat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            if (settings) {
                Object.keys(settings).sort().forEach(k => {
                    const op = document.createElement('option');
                    op.value = k; op.text = k; sel.add(op);
                });
            }
            updateClientName(); 
        }

        function updateClientName() {
            const z = document.getElementById('i-zone').value;
            if (z) { 
                const realName = z.includes('_') ? z.substring(z.indexOf('_') + 1) : z;
                if (z.toUpperCase().startsWith('Z')) {
                    document.getElementById('i-client').value = ''; 
                    document.getElementById('i-client').readOnly = false; 
                    document.getElementById('i-client').classList.remove('bg-gray-100'); 
                    document.getElementById('i-client').classList.add('bg-white'); 
                } else {
                    document.getElementById('i-client').value = realName; 
                    document.getElementById('i-client').readOnly = true; 
                    document.getElementById('i-client').classList.add('bg-gray-100');
                    document.getElementById('i-client').classList.remove('bg-white');
                }
                let lastId = (DATA.ids) ? DATA.ids[z] : "";
                let displayId = "001"; 
                if (lastId && lastId !== "ç„¡" && lastId !== "ç„¡ç´€éŒ„") {
                    const match = lastId.match(/\d+$/); 
                    if (match) displayId = match[0];
                    document.getElementById('i-id').placeholder = `æœ€å¾Œç·¨è™Ÿ: ${displayId}`;
                } else {
                    document.getElementById('i-id').placeholder = `å»ºè­°ç·¨è™Ÿ: 001`;
                }
            } else {
                document.getElementById('i-client').value = '';
                document.getElementById('i-id').placeholder = ''; 
            }
        }

        function checkProducer() {
            const prod = document.getElementById('i-producer').value;
            const dateInput = document.getElementById('i-date');
            if (prod === 'å°šæœªæš«å®š') {
                dateInput.placeholder = "æ—¥æœŸå¯ç•™ç©º";
                dateInput.style.background = "#eef";
            } else {
                dateInput.placeholder = "é»æ“Šé¸æ“‡";
                dateInput.style.background = "#F5F5F7";
            }
        }

        function saveProject() {
            const dr = document.getElementById('i-date').value.split(' to ');
            const prod = document.getElementById('i-producer').value;
            const p = {
                category: curCat, zone: document.getElementById('i-zone').value, id: document.getElementById('i-id').value,
                client: document.getElementById('i-client').value, name: document.getElementById('i-name').value,
                producer: prod, type: document.getElementById('i-type').value,
                note: document.getElementById('i-note').value, start: dr[0] || "", end: dr[1] || dr[0] || "",
                tag: document.getElementById('i-urgent').checked ? 'Urgent' : '',
                status: (prod !== 'å°šæœªæš«å®š' && dr[0] && new Date(dr[0]) <= new Date()) ? 'è£½ä½œä¸­' : 'å°šæœªé€²è¡Œ'
            };
            if(!p.zone || !p.id || !p.name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            if(prod !== 'å°šæœªæš«å®š' && !p.start) return alert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ");
            
            // â˜… æ¨‚è§€æ›´æ–°ï¼šç›´æ¥åŠ åˆ°æœ¬åœ°è³‡æ–™ â˜…
            DATA.projects.push(p);
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true); // ç«‹å³æ›´æ–°ç•«é¢
            alert("âœ… å»ºç«‹æˆåŠŸ (èƒŒæ™¯åŒæ­¥ä¸­)");

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('i-id').value = '';
            document.getElementById('i-name').value = '';
            document.getElementById('i-note').value = '';
            document.getElementById('i-urgent').checked = false; 

            // èƒŒæ™¯é€å‡º
            callAPI('addProject', { payload: p }, (res) => {
                console.log("Synced");
            });
        }

        function renderKanban(producer) {
            document.getElementById('kb-title').innerText = producer + " ä»»å‹™çœ‹æ¿";
            if (!DATA.projects) return;
            const tasks = DATA.projects.filter(p => p.producer === producer);
            const card = (p, color, bg) => {
                // ä½¿ç”¨ ID å‚³é
                return `
                <div class="kanban-item k-${color} ${p.tag === 'Urgent' ? 'k-red' : ''}">
                    <div class="k-header-badges"><span class="k-status-badge bg-${bg}">${p.status}</span>${ p.tag === 'Urgent' ? '<span class="k-tag-urgent">ğŸ”¥ æ€¥ä»¶</span>' : '' }</div>
                    <div class="k-actions">
                        <div onclick="triggerEdit('${p.id}', '${p.zone}')" class="k-action-btn"><i class="fas fa-pen text-xs"></i></div>
                        <div onclick="deleteProject('${p.category}', '${p.zone}', '${p.id}')" class="k-action-btn k-del"><i class="fas fa-times text-xs"></i></div>
                    </div>
                    <div class="k-id">${p.id}</div><div class="k-name">${p.name}</div><div class="k-client">${p.client}</div>
                    <div class="k-date"><i class="far fa-calendar-alt"></i> ${p.start} ~ ${p.end}</div>
                    <div class="mt-3 flex gap-2">
                        ${ p.status==='è£½ä½œä¸­' ? `<button onclick="openHoursModal('${p.category}','${p.zone}','${p.id}')" class="flex-1 bg-gray-100 text-orange-600 text-xs font-bold py-2 rounded hover:bg-orange-50">é€å¯©æ ¸</button>` : '' }
                        ${ p.status.includes('å¯©') ? `<button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','è£½ä½œä¸­')" class="bg-gray-100 px-3 py-2 rounded text-xs font-bold">é€€ä¿®</button><button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','å·²å®Œæˆ')" class="flex-1 bg-black text-white text-xs font-bold py-2 rounded">å®Œæˆ</button>` : '' }
                        ${ p.status === 'å°šæœªé€²è¡Œ' ? `<button onclick="doUpdate('${p.category}','${p.zone}','${p.id}','è£½ä½œä¸­')" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded">é–‹å§‹è£½ä½œ</button>` : '' }
                    </div>
                </div>`;
            };
            const processHTML = tasks.filter(p => p.status === 'è£½ä½œä¸­').map(p => card(p, 'blue', 'blue')).join('');
            const reviewHTML = tasks.filter(p => p.status.includes('å¯©')).map(p => card(p, 'orange', 'orange')).join('');
            const todoHTML = tasks.filter(p => p.status === 'å°šæœªé€²è¡Œ').map(p => card(p, 'gray', 'gray')).join('');
            const doneHTML = tasks.filter(p => p.status === 'å·²å®Œæˆ' || p.status === 'å·²çµæ¡ˆ').map(p => card(p, 'green', 'green')).join('');
            document.getElementById('kb-process').innerHTML = processHTML || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-review').innerHTML = reviewHTML || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-todo').innerHTML = todoHTML || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
            document.getElementById('kb-done').innerHTML = doneHTML || '<div class="text-center text-gray-300 py-4">ç„¡</div>';
        }

        // æ–°å¢ï¼šé€é ID è§¸ç™¼ç·¨è¼¯
        function triggerEdit(id, zone) {
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if(p) openEditProject(p);
        }

        function deleteProject(category, zone, id) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆ ${id} å—ï¼Ÿ`)) return;
            
            // â˜… æ¨‚è§€æ›´æ–°ï¼šç›´æ¥åˆªé™¤æœ¬åœ°è³‡æ–™ â˜…
            DATA.projects = DATA.projects.filter(p => !(p.id === id && p.zone === zone));
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);

            callAPI('deleteProject', { cat: category, zone: zone, id: id }, (res) => {
               console.log("Deleted");
            });
        }

        function confirmEditProject() {
            const dateVal = document.getElementById('ep-date').value;
            const dates = dateVal.split(' to ');
            const originId = document.getElementById('ep-origin-id').value;
            const originZone = document.getElementById('ep-origin-zone').value;
            
            const p = {
                category: document.getElementById('ep-cat').value,
                zone: document.getElementById('ep-zone').value, 
                id: document.getElementById('ep-num').value, 
                client: document.getElementById('ep-client-display').value,
                name: document.getElementById('ep-name').value,
                producer: document.getElementById('ep-producer').value,
                type: document.getElementById('ep-type').value,
                hours: document.getElementById('ep-hours').value, 
                start: dates[0] || "",
                end: dates[1] || dates[0] || "",
                note: document.getElementById('ep-note').value,
                tag: document.getElementById('ep-urgent').checked ? 'Urgent' : '',
                // é€™è£¡ä¿ç•™èˆŠç‹€æ…‹ï¼Œé™¤éé‚è¼¯éœ€è¦è®Šæ›´
                status: 'ä¿æŒåŸæ¨£' 
            };

            // å°‹æ‰¾ä¸¦æ›´æ–°æœ¬åœ°è³‡æ–™
            const targetIdx = DATA.projects.findIndex(x => x.id === originId && x.zone === originZone);
            if (targetIdx !== -1) {
                // ä¿ç•™åŸæœ¬çš„ statusï¼Œé™¤éæœ‰ç‰¹æ®Šé‚è¼¯
                p.status = DATA.projects[targetIdx].status;
                DATA.projects[targetIdx] = p;
            }

            closeModal('edit-project');
            
            // â˜… æ¨‚è§€æ›´æ–°ï¼šç«‹å³å­˜æª”ä¸¦åˆ·æ–° â˜…
            localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
            processDataUpdate(DATA, true);
            alert("âœ… ä¿®æ”¹æˆåŠŸ (èƒŒæ™¯åŒæ­¥ä¸­)");

            callAPI('updateProject', { payload: p, originId: originId, originZone: originZone }, (res) => {
                console.log("Updated");
            });
        }

        function openHistory() {
            const z = document.getElementById('i-zone').value;
            if(!z) return alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
            document.getElementById('hist-title').innerText = z;
            document.getElementById('hist-list').innerHTML = '<div class="text-center text-gray-400">è®€å–ä¸­...</div>';
            document.getElementById('modal-preview').style.display = 'flex';
            callAPI('getHistory', { cat: curCat, zone: z }, (list) => {
                let html = list.length === 0 ? '<div class="text-center text-gray-400">å°šç„¡å°ˆæ¡ˆ</div>' : '';
                list.forEach(p => {
                    let bg = '#888'; if(p.status === 'è£½ä½œä¸­') bg = '#007AFF'; else if(p.status.includes('å¯©')) bg = '#FF9500'; else if(p.status === 'å·²å®Œæˆ') bg = '#34C759';
                    html += `<div class="hist-item"><div class="font-bold text-gray-800 mr-2 w-16">${p.id}</div><div class="flex-1 truncate text-gray-600 mr-2">${p.name}</div><div class="hist-status" style="background:${bg}">${p.status}</div></div>`;
                });
                document.getElementById('hist-list').innerHTML = html;
            });
        }
        
        function doUpdate(cat, zone, id, status, hours=0) {
            // â˜… æ¨‚è§€æ›´æ–°ï¼šç›´æ¥æ”¹ç‹€æ…‹ â˜…
            const p = DATA.projects.find(x => x.id === id && x.zone === zone);
            if (p) {
                p.status = status;
                if (hours > 0) p.hours = (parseFloat(p.hours) || 0) + parseFloat(hours);
                localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(DATA));
                processDataUpdate(DATA, true);
            }

            callAPI('updateStatus', { cat:cat, zone:zone, id:id, status:status, hours:hours }, (res) => {
               console.log("Status Updated");
            });
        }
        
        function openSettings(type) {
            document.getElementById('st-type').value = type;
            document.getElementById('setting-title').innerText = (type==='Type') ? "ç®¡ç†é¡å‹" : "ç®¡ç†è£½ä½œäºº";
            document.getElementById('st-input').value = '';
            renderSettingList();
            document.getElementById('modal-settings').style.display = 'flex';
        }

        function renderSettingList() {
            const type = document.getElementById('st-type').value;
            const list = (curCat==='video') 
                ? (type==='Type' ? DATA.config.videoTypes : DATA.config.videoProducers)
                : (type==='Type' ? DATA.config.imageTypes : DATA.config.imageProducers);
            let html = '';
            list.forEach(item => {
                html += `<div class="setting-item"><span>${item}</span><div class="setting-actions"><i onclick="editSettingItem('${item}')" class="fas fa-pen text-sm"></i><i onclick="deleteSettingItem('${item}')" class="fas fa-trash-alt text-sm"></i></div></div>`;
            });
            document.getElementById('st-list').innerHTML = html;
        }

        function addSettingItem() {
            const val = document.getElementById('st-input').value;
            const type = document.getElementById('st-type').value;
            if(!val) return;
            document.getElementById('loader').style.display = 'flex';
            callAPI('manageConfig', { act: 'add', cat: curCat, type: type, val: val, oldVal: null }, (res) => {
                if(res === 'OK') {
                    callAPI('initAllData', {}, (data) => {
                        DATA = data;
                        document.getElementById('loader').style.display = 'none';
                        renderSettingList();
                        renderDynamicOptions();
                    });
                } else { alert(res); document.getElementById('loader').style.display = 'none'; }
            });
            document.getElementById('st-input').value = '';
        }

        function deleteSettingItem(val) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¸é …å—ï¼Ÿ")) return;
            const type = document.getElementById('st-type').value;
            document.getElementById('loader').style.display = 'flex';
            callAPI('manageConfig', { act: 'delete', cat: curCat, type: type, val: val, oldVal: null }, (res) => {
                if(res === 'OK') {
                    callAPI('initAllData', {}, (data) => {
                        DATA = data;
                        document.getElementById('loader').style.display = 'none';
                        renderSettingList();
                        renderDynamicOptions();
                    });
                } else { alert(res); document.getElementById('loader').style.display = 'none'; }
            });
        }

        function editSettingItem(oldVal) {
            const newVal = prompt("è«‹è¼¸å…¥æ–°åç¨±ï¼š", oldVal);
            if (!newVal || newVal === oldVal) return;
            const type = document.getElementById('st-type').value;
            document.getElementById('loader').style.display = 'flex';
            callAPI('manageConfig', { act: 'edit', cat: curCat, type: type, val: newVal, oldVal: oldVal }, (res) => {
                if(res === 'OK') {
                    callAPI('initAllData', {}, (data) => {
                        DATA = data;
                        document.getElementById('loader').style.display = 'none';
                        renderSettingList();
                        renderDynamicOptions();
                    });
                } else { alert("ç·¨è¼¯å¤±æ•—ï¼š" + res); document.getElementById('loader').style.display = 'none'; }
            });
        }

        function openHoursModal(cat, zone, id) {
            document.getElementById('hours-cat').value = cat;
            document.getElementById('hours-zone').value = zone;
            document.getElementById('hours-id').value = id;
            document.getElementById('input-hours').value = '';
            document.getElementById('modal-hours').style.display = 'flex';
        }
        function confirmSendReview() {
            const h = document.getElementById('input-hours').value;
            if(!h) return alert("è«‹è¼¸å…¥å·¥æ™‚");
            closeModal('hours');
            doUpdate(document.getElementById('hours-cat').value, document.getElementById('hours-zone').value, document.getElementById('hours-id').value, 'å®¢æˆ¶å¯©æ ¸', h);
        }
        function togglePanel(type) {
            const allPanels = ['panel-memo', 'panel-link', 'panel-pending'];
            const targetId = 'panel-' + type;
            const targetEl = document.getElementById(targetId);
            const isVisible = targetEl.style.display !== 'none';
            allPanels.forEach(id => { document.getElementById(id).style.display = 'none'; });
            if (!isVisible) { targetEl.style.display = 'flex'; if (type === 'memo') loadMemos(); if (type === 'link') loadLinks(); if (type === 'pending') loadPending(); }
        }
        function loadPending() {
            const pendingList = DATA.projects.filter(p => p.producer === 'å°šæœªæš«å®š');
            const container = document.getElementById('pending-list');
            const badge = document.getElementById('pending-badge');
            if (pendingList.length > 0) { badge.style.display = 'flex'; badge.innerText = pendingList.length; } else { badge.style.display = 'none'; }
            if (pendingList.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ç›®å‰æ²’æœ‰å¾…åˆ†æ´¾é …ç›®</div>'; return; }
            let html = '';
            pendingList.forEach((p, idx) => {
                const prefix = p.zone.split('_')[0]; 
                const numPart = p.id.replace(prefix, '');
                const pStr = JSON.stringify(p).replace(/'/g, "&#39;");
                html += `
                <div id="p-item-${idx}" class="pending-item">
                    <div id="p-display-${idx}">
                        <div class="pending-name">${p.id} ${p.name}</div>
                        <div class="pending-meta text-xs text-gray-500 mb-2">${p.client}</div>
                        <div class="absolute top-2 right-2 text-gray-400 hover:text-black cursor-pointer flex gap-2">
                            <i class="fas fa-pen" onclick='enablePendingEdit(${idx})'></i>
                            <i class="fas fa-trash-alt text-red-300 hover:text-red-600 cursor-pointer" onclick="deleteProject('${p.category}', '${p.zone}', '${p.id}')"></i>
                        </div>
                        <div class="flex gap-2">
                            <select id="p-assign-maker-${idx}" class="text-xs p-1 rounded bg-white border font-bold flex-1"><option value="">é¸æ“‡è£½ä½œäºº...</option><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select>
                            <input id="p-assign-date-${idx}" class="text-xs p-1 rounded bg-white border w-32 text-center" placeholder="è£œå¡«æ—¥æœŸ">
                            <button onclick="confirmAssign('${p.category}', '${p.zone}', '${p.id}', ${idx})" class="bg-black text-white text-xs px-3 py-1 rounded font-bold">ç¢ºèª</button>
                        </div>
                    </div>
                    <div id="p-edit-${idx}" class="hidden">
                        <input type="hidden" id="pe-origin-id-${idx}" value="${p.id}">
                        <input type="hidden" id="pe-origin-zone-${idx}" value="${p.zone}">
                        <input type="hidden" id="pe-cat-${idx}" value="${p.category}">
                        <input type="hidden" id="pe-type-${idx}" value="${p.type}">
                        <input type="hidden" id="pe-note-${idx}" value="${p.note}">
                        <input type="hidden" id="pe-tag-${idx}" value="${p.tag}">
                        <div class="flex gap-1 mb-1">
                             <select id="pe-code-${idx}" class="text-xs p-1 border rounded w-16 font-bold text-center" onchange="updatePendingEditClient(${idx})"></select>
                             <input id="pe-num-${idx}" value="${numPart}" class="text-xs p-1 border rounded w-16 font-bold text-center">
                             <div class="flex-1"></div>
                             <div class="cursor-pointer text-gray-400 hover:text-red-500" onclick="cancelPendingEdit(${idx})"><i class="fas fa-times"></i></div>
                        </div>
                        <input id="pe-name-${idx}" value="${p.name}" class="w-full text-xs p-1 border rounded mb-1 font-bold" placeholder="å°ˆæ¡ˆåç¨±">
                        <input id="pe-client-${idx}" value="${p.client}" class="w-full text-xs p-1 border rounded mb-2 text-gray-500" placeholder="å®¢æˆ¶åç¨±">
                        <div class="flex gap-2">
                            <select id="pe-producer-${idx}" class="text-xs p-1 rounded bg-white border font-bold flex-1"><option value="å°šæœªæš«å®š">å°šæœªæš«å®š</option><option>é­æ•è»’</option><option>é‚±ä»æ°</option></select>
                            <input id="pe-date-${idx}" class="text-xs p-1 rounded bg-white border w-24 text-center" placeholder="æ—¥æœŸ">
                            <button onclick="savePendingEdit(${idx})" class="bg-blue-600 text-white text-xs px-3 py-1 rounded font-bold">ä¿å­˜</button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
            pendingList.forEach((p, idx) => { flatpickr(`#p-assign-date-${idx}`, { mode: "range", dateFormat: "Y-m-d" }); flatpickr(`#pe-date-${idx}`, { mode: "range", dateFormat: "Y-m-d" }); });
        }
        function enablePendingEdit(idx) {
            document.getElementById(`p-display-${idx}`).classList.add('hidden');
            document.getElementById(`p-edit-${idx}`).classList.remove('hidden');
            const cat = document.getElementById(`pe-cat-${idx}`).value;
            const settings = (cat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            const codeSel = document.getElementById(`pe-code-${idx}`);
            const originZone = document.getElementById(`pe-origin-zone-${idx}`).value;
            const prefix = originZone.split('_')[0];
            codeSel.innerHTML = '';
            Object.keys(settings).sort().forEach(k => { const code = k.split('_')[0]; codeSel.add(new Option(code, code)); });
            codeSel.value = prefix;
        }
        function cancelPendingEdit(idx) {
            document.getElementById(`p-display-${idx}`).classList.remove('hidden');
            document.getElementById(`p-edit-${idx}`).classList.add('hidden');
        }
        function updatePendingEditClient(idx) {
            const cat = document.getElementById(`pe-cat-${idx}`).value;
            const selectedCode = document.getElementById(`pe-code-${idx}`).value;
            const settings = (cat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            let foundZone = "";
            for (let key in settings) { if (key.startsWith(selectedCode + "_") || key === selectedCode) { foundZone = key; break; } }
            if (foundZone) { const clientName = foundZone.includes('_') ? foundZone.substring(foundZone.indexOf('_') + 1) : foundZone; document.getElementById(`pe-client-${idx}`).value = clientName; }
        }
        function savePendingEdit(idx) {
            const dateVal = document.getElementById(`pe-date-${idx}`).value;
            const dates = dateVal.split(' to ');
            const selectedCode = document.getElementById(`pe-code-${idx}`).value;
            const cat = document.getElementById(`pe-cat-${idx}`).value;
            const settings = (cat === 'video') ? DATA.videoSettings : DATA.imageSettings;
            let newZone = "";
            for (let key in settings) { if (key.startsWith(selectedCode + "_") || key === selectedCode) { newZone = key; break; } }
            if (!newZone) newZone = selectedCode + "_" + document.getElementById(`pe-client-${idx}`).value; 
            const p = {
                category: cat, zone: newZone, id: document.getElementById(`pe-num-${idx}`).value, 
                client: document.getElementById(`pe-client-${idx}`).value, name: document.getElementById(`pe-name-${idx}`).value,
                producer: document.getElementById(`pe-producer-${idx}`).value, type: document.getElementById(`pe-type-${idx}`).value,
                start: dates[0] || "", end: dates[1] || dates[0] || "", note: document.getElementById(`pe-note-${idx}`).value, tag: document.getElementById(`pe-tag-${idx}`).value
            };
            const originId = document.getElementById(`pe-origin-id-${idx}`).value;
            const originZone = document.getElementById(`pe-origin-zone-${idx}`).value;
            document.getElementById('loader').style.display = 'flex';
            callAPI('updateProject', { payload: p, originId: originId, originZone: originZone }, (res) => {
                if (res === "OK") { callAPI('initAllData', {}, (data) => { localStorage.setItem('JAYRAN_SYSTEM_DATA', JSON.stringify(data)); processDataUpdate(data, false); }); } 
                else { alert("ä¿å­˜å¤±æ•—ï¼š" + res); document.getElementById('loader').style.display = 'none'; }
            });
        }
        function confirmAssign(cat, zone, id, idx) {
            const maker = document.getElementById(`p-assign-maker-${idx}`).value;
            const date = document.getElementById(`p-assign-date-${idx}`).value;
            if(!maker || !date) return alert("è«‹é¸æ“‡è£½ä½œäººèˆ‡æ—¥æœŸ");
            document.getElementById('loader').style.display = 'flex';
            callAPI('assignProject', { cat:cat, zone:zone, id:id, maker:maker, date:date }, (res) => {
                callAPI('initAllData', {}, (data) => processDataUpdate(data));
            });
        }
        function loadMemos() {
            callAPI('getMemos', {}, (list) => {
                const container = document.getElementById('memo-list');
                const badge = document.getElementById('memo-badge');
                if(list.length > 0) { badge.style.display = 'flex'; badge.innerText = list.length; } else { badge.style.display = 'none'; }
                if(list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é … ğŸ‰</div>'; return; }
                let html = '';
                list.forEach(m => {
                    const colorClass = (m.owner === 'é‚±ä»æ°') ? 'chiu' : ''; 
                    const mStr = JSON.stringify(m).replace(/'/g, "&#39;");
                    html += `<div class="memo-item ${colorClass}">
                        <div class="memo-content">${m.content}</div>
                        <div class="memo-meta">
                            <span><i class="fas fa-user-circle"></i> ${m.owner}</span>
                            <span><i class="far fa-clock"></i> ${m.date}</span>
                        </div>
                        <div class="memo-actions">
                            <i onclick='editMemoMode(${mStr})' class="memo-icon fas fa-pen"></i>
                            <i onclick="finishMemo(${m.idx}, this)" class="memo-icon far fa-check-circle text-green-500" title="å®Œæˆ"></i>
                            <i onclick="deleteMemo(${m.idx}, this)" class="memo-icon fas fa-trash-alt memo-del" title="åˆªé™¤"></i>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            });
        }
        function deleteMemo(idx, el) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ä¾¿åˆ©è²¼å—ï¼Ÿ")) return;
            el.parentElement.parentElement.style.opacity = '0.5'; 
            callAPI('deleteMemo', { idx:idx }, (res) => loadMemos());
        }
        function editMemoMode(m) {
            editingMemoIdx = m.idx;
            document.getElementById('m-content').value = m.content;
            document.getElementById('m-owner').value = m.owner;
            if(m.date) fpMemo.setDate(m.date);
            const btn = document.getElementById('btn-memo-add');
            btn.innerText = "æ›´æ–°è²¼æ–‡";
            btn.classList.add('bg-blue-600');
            btn.onclick = updateMemoItem;
        }
        function updateMemoItem() {
            const content = document.getElementById('m-content').value;
            const owner = document.getElementById('m-owner').value;
            const date = document.getElementById('m-date').value;
            if(!content) return alert("è«‹è¼¸å…¥å…§å®¹");
            document.getElementById('m-content').value = ''; 
            document.getElementById('memo-list').innerHTML = '<div class="text-center text-gray-400 text-sm py-4"><i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...</div>';
            const btn = document.getElementById('btn-memo-add');
            btn.innerText = "æ–°å¢è²¼æ–‡";
            btn.classList.remove('bg-blue-600');
            btn.onclick = addMemoItem;
            callAPI('editMemo', { idx: editingMemoIdx, item: {content: content, owner: owner, date: date} }, (res) => { editingMemoIdx = null; loadMemos(); });
        }
        function addMemoItem() {
            const content = document.getElementById('m-content').value;
            const owner = document.getElementById('m-owner').value;
            const date = document.getElementById('m-date').value;
            if(!content) return alert("è«‹è¼¸å…¥å…§å®¹");
            document.getElementById('m-content').value = ''; 
            document.getElementById('memo-list').innerHTML = '<div class="text-center text-gray-400 text-sm py-4"><i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...</div>';
            callAPI('addMemo', { item: {content: content, owner: owner, date: date} }, (res) => loadMemos());
        }
        function finishMemo(idx, el) {
            if(!confirm("ç¢ºå®šå®Œæˆæ­¤äº‹é …ä¸¦å°å­˜å—ï¼Ÿ")) return;
            el.parentElement.parentElement.style.opacity = '0.5'; 
            callAPI('completeMemo', { idx:idx }, (res) => loadMemos());
        }
        function loadLinks() {
            callAPI('getLinks', {}, (list) => {
                const container = document.getElementById('link-list');
                if(list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">å°šç„¡é€£çµ</div>'; return; }
                let html = '';
                list.forEach(l => {
                    const lStr = JSON.stringify(l).replace(/'/g, "&#39;");
                    html += `<div class="link-item">
                        <div onclick="window.open('${l.url}','_blank')" class="flex-1 truncate"><i class="fas fa-link mr-2"></i> ${l.client}</div>
                        <div class="link-actions">
                            <i onclick='editLinkMode(${lStr})' class="link-icon fas fa-pen"></i>
                            <i onclick="removeLink(${l.idx}, this)" class="link-icon fas fa-trash-alt link-del"></i>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            });
        }
        function editLinkMode(l) {
            editingLinkIdx = l.idx;
            document.getElementById('l-client').value = l.client;
            document.getElementById('l-url').value = l.url;
            const btn = document.getElementById('btn-link-add');
            btn.innerText = "æ›´æ–°é€£çµ";
            btn.onclick = updateLinkItem;
        }
        function updateLinkItem() {
            const client = document.getElementById('l-client').value;
            const url = document.getElementById('l-url').value;
            if(!client || !url) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
            const btn = document.getElementById('btn-link-add');
            btn.innerText = "æ›´æ–°ä¸­...";
            btn.disabled = true;
            callAPI('editLink', { idx: editingLinkIdx, client: client, url: url }, (res) => {
                btn.innerText = "æ–°å¢é€£çµ";
                btn.disabled = false;
                btn.onclick = addLinkItem;
                editingLinkIdx = null;
                document.getElementById('l-client').value = '';
                document.getElementById('l-url').value = '';
                loadLinks();
            });
        }
        function addLinkItem() {
            const client = document.getElementById('l-client').value;
            const url = document.getElementById('l-url').value;
            if(!client || !url) return alert("è«‹è¼¸å…¥å®¢æˆ¶åç¨±èˆ‡ç¶²å€");
            const btn = document.getElementById('btn-link-add');
            const originalText = btn.innerText;
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;
            callAPI('addLink', { client: client, url: url }, (res) => {
                btn.innerText = originalText;
                btn.disabled = false;
                if (res !== "OK") { alert(res); } else { document.getElementById('l-client').value = ''; document.getElementById('l-url').value = ''; loadLinks(); }
            });
        }
        function removeLink(idx, el) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é€£çµå—ï¼Ÿ")) return;
            el.parentElement.parentElement.style.opacity = '0.5';
            callAPI('deleteLink', { idx:idx }, (res) => loadLinks());
        }
        
        function openZoneModal(mode) {
            modalMode = mode;
            const z = document.getElementById('i-zone').value;
            if (mode === 'edit' && !z) return alert("è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„å®¢æˆ¶");
            document.getElementById('modal-title').innerText = (mode==='new') ? "æ–°å¢å®¢æˆ¶" : "ç·¨è¼¯å®¢æˆ¶åç¨±";
            const selCode = document.getElementById('modal-code');
            selCode.innerHTML = '';
            const raw = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            const alphabet = (curCat === 'image') ? raw.map(c=>c.toLowerCase()) : raw;
            const used = (curCat === 'image') ? DATA.usedCodesImage : DATA.usedCodesVideo;
            alphabet.forEach(c => { 
                if(mode === 'new' && used.includes(c)) return; 
                const op = document.createElement('option'); op.value = c; op.text = c; selCode.add(op); 
            });
            document.getElementById('div-code-select').classList.remove('hidden');
            if (mode === 'new') {
                document.getElementById('modal-name').value = '';
            } else {
                const prefix = z.split('_')[0];
                const realName = z.includes('_') ? z.substring(z.indexOf('_') + 1) : z;
                let found = false;
                for(let i=0; i<selCode.options.length; i++) { if(selCode.options[i].value == prefix) found = true; }
                if(!found) { const op = document.createElement('option'); op.value = prefix; op.text = prefix; selCode.add(op); }
                selCode.value = prefix;
                document.getElementById('modal-name').value = realName;
            }
            document.getElementById('modal-zone').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }

        function confirmZoneModal() {
            const name = document.getElementById('modal-name').value;
            const code = document.getElementById('modal-code').value;
            if(!name) return;
            closeModal('zone');
            document.getElementById('loader').style.display = 'flex';
            if (modalMode === 'new') {
                callAPI('createClient', { cat: curCat, code: code, name: name }, (res) => {
                    callAPI('initAllData', {}, (data) => processDataUpdate(data));
                });
            } else {
                const oldName = document.getElementById('i-zone').value;
                const newFullName = code + "_" + name; 
                callAPI('renameClient', { cat: curCat, oldName: oldName, newFullName: newFullName }, (res) => {
                    callAPI('initAllData', {}, (data) => processDataUpdate(data));
                });
            }
        }
        
        function openEditProject(p) {
            document.getElementById('ep-cat').value = p.category;
            document.getElementById('ep-origin-id').value = p.id; 
            document.getElementById('ep-origin-zone').value = p.zone; 
            const prefix = p.zone.split('_')[0]; 
            const numPart = p.id.replace(prefix, ''); 
            const epCodeSel = document.getElementById('ep-code');
            epCodeSel.innerHTML = '';
            const settings = (p.category === 'video') ? DATA.videoSettings : DATA.imageSettings;
            Object.keys(settings).sort().forEach(k => { epCodeSel.add(new Option(k.split('_')[0], k.split('_')[0])); });
            epCodeSel.value = prefix;
            document.getElementById('ep-num').value = numPart;
            updateEditClientInfo(); 
            document.getElementById('ep-producer').value = p.producer;
            document.getElementById('ep-name').value = p.name;
            document.getElementById('ep-type').value = p.type;
            document.getElementById('ep-hours').value = p.hours || 0; 
            if (p.start && p.end) fpEdit.setDate([p.start, p.end]); else fpEdit.clear();
            document.getElementById('ep-note').value = p.note;
            document.getElementById('ep-urgent').checked = (p.tag === 'Urgent');
            document.getElementById('modal-edit-project').style.display = 'flex';
        }

        function updateEditClientInfo() {
            const selectedCode = document.getElementById('ep-code').value;
            const settings = (document.getElementById('ep-cat').value === 'video') ? DATA.videoSettings : DATA.imageSettings;
            let foundZone = "";
            for (let key in settings) { if (key.startsWith(selectedCode + "_") || key === selectedCode) { foundZone = key; break; } }
            if (foundZone) {
                const clientName = foundZone.includes('_') ? foundZone.substring(foundZone.indexOf('_') + 1) : foundZone;
                document.getElementById('ep-client-display').value = clientName;
                document.getElementById('ep-zone').value = foundZone; 
            } else {
                document.getElementById('ep-client-display').value = "æœªçŸ¥å®¢æˆ¶";
                document.getElementById('ep-zone').value = "";
            }
        }
    </script>
</body>
</html>
